---
title: "Integración de los datos de estructura de muestreo de los grupos"
author: "Marius Bottin"
date: "`r Sys.Date()`"
output: 
    pdf_document:
       number_sections: true
       toc: true
       toc_depth: 4
       latex_engine: xelatex
---


************************

```{r setup}
knitr::opts_chunk$set(tidy.opts = list(width.cutoff = 70), tidy = TRUE, connection="fracking_db", max.print=100)
def.chunk.hook  <- knitr::knit_hooks$get("chunk")
knitr::knit_hooks$set(chunk = function(x, options) {
  x <- def.chunk.hook(x, options)
  paste0("\n \\", "footnotesize","\n\n", x, "\n\n \\normalsize\n\n")
})
require(openxlsx)
require(RPostgreSQL)

```

```{r}
fracking_db <- dbConnect(PostgreSQL(), dbname='fracking')
```

TODO ; error for people affectations when "row.names" are repeated (mamiferos, hidrobiologicos, herpetos)

# Platforms

**Ver archivo de exportación de los datos espaciales para entender de donde vienen los datos espaciales brutos**


```{sql}
DELETE FROM main.platform;


INSERT INTO main.platform(platform,zona_geom,plat_geom)
SELECT 'Kalé',(ST_DUMP(zonas.wkb_geometry)).geom, (ST_DUMP(kale."Shape")).geom
FROM raw_geom.kale,raw_geom.zonas
WHERE zonas.zona='Kale'
RETURNING cd_plat
;

INSERT INTO main.platform(platform,zona_geom,plat_geom)
SELECT 'Platero',(ST_DUMP(zonas.wkb_geometry)).geom, (ST_DUMP(platero."Shape")).geom
FROM raw_geom.platero,raw_geom.zonas
WHERE zonas.zona='Platero'
RETURNING cd_plat
;

INSERT INTO main.platform(platform,zona_geom)
SELECT 'Caracterización', (ST_DUMP(zonas.wkb_geometry)).geom
FROM raw_geom.zonas
WHERE zonas.zona='Caracterizacion'
RETURNING cd_plat;

```


# Herpetos

## ANH

**NOTES**

1. the same ANH has been associated with caracterización and one of the platform... I think the best thing to do is not to hardcode it and wait for extracting it from the spatial data
1. I really doubt occurrenceID to be right for the event IDs in the DarwinCore format


```sql
WITH a AS(
SELECT DISTINCT
  REGEXP_REPLACE(event_id,'^(ANH_[0-9]{1,3})_Herp_T[0-9]_[DN](_TE2)?$','\1') anh_name,
  REGEXP_REPLACE(event_id,'^ANH_([0-9]{1,3})_Herp_T[0-9]_[DN](_TE2)?$','\1')::int num_anh,
  p.cd_plat
FROM raw_dwc.anfibios_event ae
LEFT JOIN main.platform p ON ae.measurement_value__plataforma_=p.platform
UNION
SELECT DISTINCT
  REGEXP_REPLACE(occurrence_id,'^(ANH_[0-9]{1,3})_Herp_T[0-9]_[DN](_TE2)?$','\1') anh_name,
  REGEXP_REPLACE(occurrence_id,'^ANH_([0-9]{1,3})_Herp_T[0-9]_[DN](_TE2)?$','\1')::int num_anh,
  p.cd_plat
FROM raw_dwc.reptiles_event ae
LEFT JOIN main.platform p ON ae.measurement_value__plataforma_=p.platform
)
SELECT anh_name, num_anh, cd_plat
FROM a
ORDER BY num_anh
```

Insertar los datos de anh:

```{sql}
INSERT INTO main.punto_referencia(name_pt_ref, num_anh)
WITH a AS(
SELECT DISTINCT
  REGEXP_REPLACE(event_id,'^(ANH_[0-9]{1,3})_Herp_T[0-9]_[DN](_TE2)?$','\1') anh_name,
  REGEXP_REPLACE(event_id,'^ANH_([0-9]{1,3})_Herp_T[0-9]_[DN](_TE2)?$','\1')::int num_anh
FROM raw_dwc.anfibios_event ae
UNION
SELECT DISTINCT
  REGEXP_REPLACE(occurrence_id,'^(ANH_[0-9]{1,3})_Herp_T[0-9]_[DN](_TE2)?$','\1') anh_name,
  REGEXP_REPLACE(occurrence_id,'^ANH_([0-9]{1,3})_Herp_T[0-9]_[DN](_TE2)?$','\1')::int num_anh
FROM raw_dwc.reptiles_event ae
)
SELECT anh_name, num_anh
FROM a
ORDER BY num_anh
RETURNING cd_pt_ref
```

dar las referencias en las tablas de herpetos

```{sql}
ALTER TABLE raw_dwc.anfibios_event ADD COLUMN cd_pt_ref int REFERENCES main.punto_referencia(cd_pt_ref) ON DELETE SET NULL ON UPDATE CASCADE;
ALTER TABLE raw_dwc.reptiles_event ADD COLUMN cd_pt_ref int REFERENCES main.punto_referencia(cd_pt_ref) ON DELETE SET NULL ON UPDATE CASCADE;
ALTER TABLE raw_dwc.anfibios_registros ADD COLUMN cd_pt_ref int REFERENCES main.punto_referencia(cd_pt_ref) ON DELETE SET NULL ON UPDATE CASCADE;
ALTER TABLE raw_dwc.reptiles_registros ADD COLUMN cd_pt_ref int REFERENCES main.punto_referencia(cd_pt_ref) ON DELETE SET NULL ON UPDATE CASCADE;

UPDATE raw_dwc.anfibios_event
SET cd_pt_ref=pr.cd_pt_ref
FROM main.punto_referencia pr
WHERE REGEXP_REPLACE(event_id,'^(ANH_[0-9]{1,3})_Herp_T[0-9]_[DN](_TE2)?$','\1')=pr.name_pt_ref
;

UPDATE raw_dwc.reptiles_event
SET cd_pt_ref=pr.cd_pt_ref
FROM main.punto_referencia pr
WHERE REGEXP_REPLACE(occurrence_id,'^(ANH_[0-9]{1,3})_Herp_T[0-9]_[DN](_TE2)?$','\1')=pr.name_pt_ref
;

UPDATE raw_dwc.anfibios_registros
SET cd_pt_ref=pr.cd_pt_ref
FROM main.punto_referencia pr
WHERE REGEXP_REPLACE(event_id,'^(ANH_[0-9]{1,3})_Herp_T[0-9]_[DN](_TE2)?$','\1')=pr.name_pt_ref
;

UPDATE raw_dwc.reptiles_registros
SET cd_pt_ref=pr.cd_pt_ref
FROM main.punto_referencia pr
WHERE REGEXP_REPLACE(event_id,'^(ANH_[0-9]{1,3})_Herp_T[0-9]_[DN](_TE2)?$','\1')=pr.name_pt_ref
;

SELECT true;
```

Averiguando que ninguna fila no tenga anh

```{sql}
SELECT * FROM raw_dwc.anfibios_event WHERE cd_pt_ref IS NULL;
```

```{sql}
SELECT * FROM raw_dwc.anfibios_registros WHERE cd_pt_ref IS NULL;
```

```{sql}
SELECT * FROM raw_dwc.reptiles_event WHERE cd_pt_ref IS NULL;
```

```{sql}
SELECT * FROM raw_dwc.reptiles_registros WHERE cd_pt_ref IS NULL;
```

## Unit, sampling efforts definition, abundance definition, protocolo


```{sql}
INSERT INTO main.def_unit(cd_measurement_type, unit, unit_spa, abbv_unit,factor)
VALUES(
  (SELECT cd_measurement_type FROM main.def_measurement_type WHERE measurement_type='distance'),
  'Meter',
  'Metros',
  'm',
  1
  ),
  (
  (SELECT cd_measurement_type FROM main.def_measurement_type WHERE measurement_type='number of individuals'),
  'Number of individuals',
  'Número de individuos',
  'ind',
  1
  ),
  (
  (SELECT cd_measurement_type FROM main.def_measurement_type WHERE measurement_type='time'),
  'Minutes',
  'Minutos',
  'min',
  1
  )
  
RETURNING cd_unit,unit;
```

```{sql}
INSERT INTO main.def_var_samp_eff(var_samp_eff, var_samp_eff_spa, cd_unit,type_variable)
VALUES(
  'Covered distance',
  'Distancia recorrida',
  (SELECT cd_unit FROM main.def_unit WHERE cd_measurement_type=(SELECT cd_measurement_type FROM main.def_measurement_type WHERE measurement_type='distance') AND unit='Meter'),
  'double precision'
  ),(
  'Elapsed time',
  'Duración',
  (SELECT cd_unit FROM main.def_unit WHERE cd_measurement_type=(SELECT cd_measurement_type FROM main.def_measurement_type WHERE measurement_type='time') AND unit='Minutes'),
  'double precision'
  )
RETURNING cd_var_samp_eff, var_samp_eff ;
```

```{sql}
INSERT INTO main.def_var_ind_qt(var_qt_ind, var_qt_ind_spa, cd_unit, type_variable)
VALUES(
  'Number of individuals',
  'Número de individuos',
  (SELECT cd_unit FROM main.def_unit WHERE cd_measurement_type=(SELECT cd_measurement_type FROM main.def_measurement_type WHERE measurement_type='number of individuals') AND unit='Number of individuals'),
  'int'
)
RETURNING cd_var_ind_qt,var_qt_ind
;
```

```{sql}
INSERT INTO main.def_protocol(protocol,protocol_spa,cd_var_samp_eff_1,cd_var_samp_eff_2,samp_eff_1_implicit,samp_eff_2_implicit,cd_var_ind_qt,description_spa)
VALUES(
  'Visual encounter survey',
  'Búsqueda por encuentros visuales',
  (SELECT cd_var_samp_eff FROM main.def_var_samp_eff WHERE var_samp_eff='Covered distance'),
  (SELECT cd_var_samp_eff FROM main.def_var_samp_eff WHERE var_samp_eff='Elapsed time'),
  false,
  true,
  (SELECT cd_var_ind_qt FROM main.def_var_ind_qt WHERE var_qt_ind='Number of individuals'),
  'Búsqueda por encuentros visuales (VES)'
)
RETURNING cd_protocol,protocol,protocol_spa;
```

## Personas

```{sql}
INSERT INTO main.people(verbatim_person)
WITH a AS(
SELECT DISTINCT INITCAP(TRIM(UNNEST(STRING_TO_ARRAY(recorded_by, ' | ')))) AS name_person
FROM raw_dwc.anfibios_registros
UNION
SELECT DISTINCT INITCAP(TRIM(UNNEST(STRING_TO_ARRAY(identified_by, ' | '))))
FROM raw_dwc.anfibios_registros
UNION
SELECT DISTINCT INITCAP(TRIM(UNNEST(STRING_TO_ARRAY(recorded_by, ' | '))))
FROM raw_dwc.reptiles_registros
UNION
SELECT DISTINCT INITCAP(TRIM(UNNEST(STRING_TO_ARRAY(identified_by, ' | '))))
FROM raw_dwc.reptiles_registros
)
SELECT DISTINCT name_person
FROM a 
ORDER BY name_person
RETURNING cd_person, verbatim_person
```

Dar los codigos a las tables de origen:

```{sql}
ALTER TABLE raw_dwc.anfibios_registros ADD COLUMN cds_recorded_by int[];
WITH a AS(
SELECT "row.names", INITCAP(TRIM(UNNEST(STRING_TO_ARRAY(recorded_by, ' | ')))) AS name_person
FROM raw_dwc.anfibios_registros
),b AS(
SELECT "row.names", ARRAY_AGG(cd_person) cds
FROM a 
LEFT JOIN main.people p ON a.name_person=p.verbatim_person
GROUP BY "row.names"
)
UPDATE raw_dwc.anfibios_registros AS r
SET cds_recorded_by=b.cds
FROM b
WHERE r."row.names"=b."row.names"
RETURNING r."row.names", cds_recorded_by
;
ALTER TABLE raw_dwc.anfibios_registros ADD COLUMN cds_identified_by int[];
WITH a AS(
SELECT "row.names", INITCAP(TRIM(UNNEST(STRING_TO_ARRAY(identified_by, ' | ')))) AS name_person
FROM raw_dwc.anfibios_registros
),b AS(
SELECT "row.names", ARRAY_AGG(cd_person) cds
FROM a 
LEFT JOIN main.people p ON a.name_person=p.verbatim_person
GROUP BY "row.names"
)
UPDATE raw_dwc.anfibios_registros AS r
SET cds_identified_by=b.cds
FROM b
WHERE r."row.names"=b."row.names"
RETURNING r."row.names", cds_identified_by
;
ALTER TABLE raw_dwc.reptiles_registros ADD COLUMN cds_recorded_by int[];
WITH a AS(
SELECT "row.names", INITCAP(TRIM(UNNEST(STRING_TO_ARRAY(recorded_by, ' | ')))) AS name_person
FROM raw_dwc.reptiles_registros
),b AS(
SELECT "row.names", ARRAY_AGG(cd_person) cds
FROM a 
LEFT JOIN main.people p ON a.name_person=p.verbatim_person
GROUP BY "row.names"
)
UPDATE raw_dwc.reptiles_registros AS r
SET cds_recorded_by=b.cds
FROM b
WHERE r."row.names"=b."row.names"
RETURNING r."row.names", cds_recorded_by
;
ALTER TABLE raw_dwc.reptiles_registros ADD COLUMN cds_identified_by int[];
WITH a AS(
SELECT "row.names", INITCAP(TRIM(UNNEST(STRING_TO_ARRAY(identified_by, ' | ')))) AS name_person
FROM raw_dwc.reptiles_registros
),b AS(
SELECT "row.names", ARRAY_AGG(cd_person) cds
FROM a 
LEFT JOIN main.people p ON a.name_person=p.verbatim_person
GROUP BY "row.names"
)
UPDATE raw_dwc.reptiles_registros AS r
SET cds_identified_by=b.cds
FROM b
WHERE r."row.names"=b."row.names"
RETURNING r."row.names", cds_identified_by
;
SELECT 1;
```

## gp_event

**NOTE**:

1. en algunos casos hay 3 fechas para un solo ANH, yo pensaba encontrar solo 2 fechas: error de fecha, o un plan de muestreo particular?
2. la otra solución podría ser agrupar por ANH+año (solución que voy a adoptar por ahora) pero... averiguar!
3. Algunas asociaciones año + anh solo corresponden a 4 eventos en anfibios
4. Algunos ANH no tienen datos en 2022
5. problemas de SRID?

```{sql}
WITH a AS(
SELECT cd_pt_ref, name_pt_ref, TO_DATE(event_date,'YYYY-MM-DD'), ROW_NUMBER() OVER (PARTITION BY cd_pt_ref  ORDER BY TO_DATE(event_date,'YYYY-MM-DD')) num_gp, count(*)
FROM raw_dwc.anfibios_event
JOIN main.punto_referencia USING (cd_pt_ref)
GROUP BY cd_pt_ref, name_pt_ref, TO_DATE(event_date,'YYYY-MM-DD')
ORDER BY cd_pt_ref, TO_DATE(event_date,'YYYY-MM-DD')
)
SELECT * 
FROM a
WHERE cd_pt_ref IN (SELECT cd_pt_ref FROM a WHERE num_gp=3)
;
```

```{sql}
--WITH a AS(
SELECT cd_pt_ref, name_pt_ref, EXTRACT(isoyear FROM TO_DATE(event_date,'YYYY-MM-DD')), ROW_NUMBER() OVER (PARTITION BY cd_pt_ref  ORDER BY EXTRACT(isoyear FROM TO_DATE(event_date,'YYYY-MM-DD'))) num_gp, count(*)
FROM raw_dwc.anfibios_event
JOIN main.punto_referencia USING (cd_pt_ref)
GROUP BY cd_pt_ref, name_pt_ref, EXTRACT(isoyear FROM TO_DATE(event_date,'YYYY-MM-DD'))
ORDER BY cd_pt_ref, EXTRACT(isoyear FROM TO_DATE(event_date,'YYYY-MM-DD'))
--)
;
```
  


```{sql}
WITH a AS(
SELECT cd_pt_ref, EXTRACT(isoyear FROM TO_DATE(event_date,'YYYY-MM-DD')) AS year
FROM raw_dwc.anfibios_event
UNION ALL
SELECT cd_pt_ref, EXTRACT(isoyear FROM TO_DATE(event_date,'YYYY-MM-DD')) AS year
FROM raw_dwc.reptiles_event
)
SELECT cd_pt_ref, name_pt_ref, year , ROW_NUMBER() OVER (PARTITION BY cd_pt_ref  ORDER BY year) num_gp, count(*)
FROM a 
JOIN main.punto_referencia USING (cd_pt_ref)
GROUP BY cd_pt_ref, name_pt_ref, year
ORDER BY cd_pt_ref, year
--)
;
```

Insertar los grupos de eventos

```{sql}
INSERT INTO main.gp_event(cd_gp_biol,cd_protocol,cd_pt_ref,campaign_nb)
WITH a AS(
SELECT cd_pt_ref, EXTRACT(isoyear FROM TO_DATE(event_date,'YYYY-MM-DD')) AS year
FROM raw_dwc.anfibios_event
UNION ALL
SELECT cd_pt_ref, EXTRACT(isoyear FROM TO_DATE(event_date,'YYYY-MM-DD')) AS year
FROM raw_dwc.reptiles_event
)
SELECT 'herp', (SELECT cd_protocol FROM main.def_protocol WHERE protocol='Visual encounter survey'),cd_pt_ref, ROW_NUMBER() OVER (PARTITION BY cd_pt_ref  ORDER BY year) num_gp
FROM a 
JOIN main.punto_referencia USING (cd_pt_ref)
GROUP BY cd_pt_ref, name_pt_ref, year
ORDER BY cd_pt_ref, year
RETURNING cd_gp_event,cd_gp_biol,cd_protocol,cd_pt_ref,campaign_nb
;
```

Attributing the gp_event

```{sql}
ALTER TABLE raw_dwc.anfibios_event ADD COLUMN cd_gp_event int REFERENCES main.gp_event(cd_gp_event) ON DELETE SET NULL;
ALTER TABLE raw_dwc.reptiles_event ADD COLUMN cd_gp_event int REFERENCES main.gp_event(cd_gp_event) ON DELETE SET NULL;

WITH a AS(
SELECT cd_pt_ref, EXTRACT(isoyear FROM TO_DATE(event_date,'YYYY-MM-DD')) AS year
FROM raw_dwc.anfibios_event
UNION ALL
SELECT cd_pt_ref, EXTRACT(isoyear FROM TO_DATE(event_date,'YYYY-MM-DD')) AS year
FROM raw_dwc.reptiles_event
),b AS(
SELECT cd_pt_ref, name_pt_ref, year , ROW_NUMBER() OVER (PARTITION BY cd_pt_ref  ORDER BY year) num_gp, count(*)
FROM a 
JOIN main.punto_referencia USING (cd_pt_ref)
GROUP BY cd_pt_ref, name_pt_ref, year
ORDER BY cd_pt_ref, year
), c AS(
SELECT "row.names",ge.cd_gp_event
FROM raw_dwc.anfibios_event e
LEFT JOIN b ON EXTRACT(isoyear FROM TO_DATE(event_date,'YYYY-MM-DD'))=year AND e.cd_pt_ref=b.cd_pt_ref
LEFT JOIN main.gp_event ge ON b.num_gp=ge.campaign_nb AND ge.cd_gp_biol='herp' AND cd_protocol= (SELECT cd_protocol FROM main.def_protocol WHERE protocol='Visual encounter survey') AND ge.cd_pt_ref=e.cd_pt_ref
)
UPDATE raw_dwc.anfibios_event e
SET cd_gp_event=c.cd_gp_event
FROM c
WHERE c."row.names"=e."row.names"
;

WITH a AS(
SELECT cd_pt_ref, EXTRACT(isoyear FROM TO_DATE(event_date,'YYYY-MM-DD')) AS year
FROM raw_dwc.reptiles_event
UNION ALL
SELECT cd_pt_ref, EXTRACT(isoyear FROM TO_DATE(event_date,'YYYY-MM-DD')) AS year
FROM raw_dwc.reptiles_event
),b AS(
SELECT cd_pt_ref, name_pt_ref, year , ROW_NUMBER() OVER (PARTITION BY cd_pt_ref  ORDER BY year) num_gp, count(*)
FROM a 
JOIN main.punto_referencia USING (cd_pt_ref)
GROUP BY cd_pt_ref, name_pt_ref, year
ORDER BY cd_pt_ref, year
), c AS(
SELECT "row.names",ge.cd_gp_event
FROM raw_dwc.reptiles_event e
LEFT JOIN b ON EXTRACT(isoyear FROM TO_DATE(event_date,'YYYY-MM-DD'))=year AND e.cd_pt_ref=b.cd_pt_ref
LEFT JOIN main.gp_event ge ON b.num_gp=ge.campaign_nb AND ge.cd_gp_biol='herp' AND cd_protocol= (SELECT cd_protocol FROM main.def_protocol WHERE protocol='Visual encounter survey') AND ge.cd_pt_ref=e.cd_pt_ref
)
UPDATE raw_dwc.reptiles_event e
SET cd_gp_event=c.cd_gp_event
FROM c
WHERE c."row.names"=e."row.names"
;
SELECT true;
```

## event

1. pb de formatos en las coordenadas intermedias: puntos intempestivos
2. pb de formato en las horas: espacios raros antes de los segundos
3. errores de coordenadas sobre los eventos siguientes

\footnotesize

```{sql}
WITH a AS(
SELECT cd_gp_event,
  event_id, 
  TO_DATE(event_date, 'YYYY-MM-DD') date,
  REGEXP_REPLACE(SPLIT_PART(event_time,'/',1),'\s+','','g') hora_1,
  REGEXP_REPLACE(SPLIT_PART(event_time,'/',2),'\s+','','g') hora_2,
  sample_size_value,
  event_remarks,
  decimal_latitude::double precision pt1_lat,
  decimal_longitude::double precision pt1_long,
  REGEXP_REPLACE(SPLIT_PART(measurement_value_coordenadas_intermedia_,',',1),'[ .]$','')::double precision pt2_lat,
  SPLIT_PART(measurement_value_coordenadas_intermedia_,',',2)::double precision pt2_long,
  SPLIT_PART(measurement_value_coordenadasfinal_,',',1)::double precision pt3_lat,
  SPLIT_PART(measurement_value_coordenadasfinal_,',',2)::double precision pt3_long
FROM raw_dwc.anfibios_event
UNION
SELECT cd_gp_event,
  occurrence_id, 
  TO_DATE(event_date, 'YYYY-MM-DD') date,
  REGEXP_REPLACE(SPLIT_PART(event_time,'/',1),'\s+','','g') hora_1,
  REGEXP_REPLACE(SPLIT_PART(event_time,'/',2),'\s+','','g') hora_2,
  sampling_size_value,
  event_remarks,
  decimal_latitude::double precision pt1_lat,
  decimal_longitude::double precision pt1_long,
  REGEXP_REPLACE(SPLIT_PART(measurement_value__coordenadas_intermedia_,',',1),'[ .]$','')::double precision pt2_lat,
  SPLIT_PART(measurement_value__coordenadas_intermedia_,',',2)::double precision pt2_long,
  SPLIT_PART(measurement_value__coordenadas_final_,',',1)::double precision pt3_lat,
  SPLIT_PART(measurement_value__coordenadas_final_,',',2)::double precision pt3_long
FROM raw_dwc.reptiles_event
),b AS(
SELECT
  cd_gp_event, event_id,
  REGEXP_REPLACE(event_id,'^(ANH_[0-9]{1,3})_Herp_T([0-9])_([DN])(_TE2)?$','\2')::int transect,
  REGEXP_REPLACE(event_id,'^(ANH_[0-9]{1,3})_Herp_(T[0-9])_([DN])(_TE2)?$','\3') jornada,
  CASE 
    WHEN REGEXP_REPLACE(event_id,'^(ANH_[0-9]{1,3})_Herp_(T[0-9])_([DN])(_TE2)?$','\4') ='' THEN 1
    ELSE 2
  END campaign,
  ROW_NUMBER() OVER (PARTITION BY cd_gp_event ORDER BY cd_gp_event,REGEXP_REPLACE(event_id,'^(ANH_[0-9]{1,3})_Herp_T([0-9])_([DN])(_TE2)?$','\2')::int,REGEXP_REPLACE(event_id,'^(ANH_[0-9]{1,3})_Herp_(T[0-9])_([DN])(_TE2)?$','\3')  ) num_replicate,
  'Transect:'||REGEXP_REPLACE(event_id,'^(ANH_[0-9]{1,3})_Herp_T([0-9])_([DN])(_TE2)?$','\2')||'|Jornada:'||REGEXP_REPLACE(event_id,'^(ANH_[0-9]{1,3})_Herp_(T[0-9])_([DN])(_TE2)?$','\3')||'|Campaign:'||CASE WHEN REGEXP_REPLACE(event_id,'^(ANH_[0-9]{1,3})_Herp_(T[0-9])_([DN])(_TE2)?$','\4') ='' THEN 1 ELSE 2 END name_replicate,
  ARRAY_AGG(DISTINCT (date||' '||hora_1)::timestamp) date_time_begin,
  ARRAY_AGG(DISTINCT (date||' '||hora_2)::timestamp) date_time_end,
  ARRAY_AGG(DISTINCT sample_size_value) samp_effort_1,
  ARRAY_AGG(DISTINCT event_remarks) event_remarks,
  ARRAY_AGG(DISTINCT pt1_lat) a_pt1_lat,
  ARRAY_AGG(DISTINCT pt1_long) a_pt1_long,
  ARRAY_AGG(DISTINCT pt2_lat) a_pt2_lat,
  ARRAY_AGG(DISTINCT pt2_long) a_pt2_long,
  ARRAY_AGG(DISTINCT pt3_lat) a_pt3_lat,
  ARRAY_AGG(DISTINCT pt3_long) a_pt3_long

FROM a
GROUP BY cd_gp_event,event_id, transect, jornada
)
SELECT cd_gp_event, event_id,
a_pt1_lat,
a_pt1_long,
a_pt2_lat,
a_pt2_long,
a_pt3_lat,
a_pt3_long
FROM b 
WHERE 
 ARRAY_LENGTH(a_pt1_lat,1)>1
 OR ARRAY_LENGTH(a_pt1_long,1)>1
 OR ARRAY_LENGTH(a_pt1_lat,1)>1
 OR ARRAY_LENGTH(a_pt1_long,1)>1
 OR ARRAY_LENGTH(a_pt1_lat,1)>1
 OR ARRAY_LENGTH(a_pt1_long,1)>1

;
```

\normalsize

Voy a tomar los primeros valores por ahora:

Primero solo los datos obligatorios:
```{sql}
INSERT INTO main.event(cd_gp_event, event_id, num_replicate, description_replicate, date_time_begin, date_time_end, samp_effort_1,event_remarks)
WITH a AS(
SELECT cd_gp_event,
  event_id, 
  TO_DATE(event_date, 'YYYY-MM-DD') date,
  REGEXP_REPLACE(SPLIT_PART(event_time,'/',1),'\s+','','g') hora_1,
  REGEXP_REPLACE(SPLIT_PART(event_time,'/',2),'\s+','','g') hora_2,
  sample_size_value,
  event_remarks,
  decimal_latitude::double precision pt1_lat,
  decimal_longitude::double precision pt1_long,
  REGEXP_REPLACE(SPLIT_PART(measurement_value_coordenadas_intermedia_,',',1),'[ .]$','')::double precision pt2_lat,
  SPLIT_PART(measurement_value_coordenadas_intermedia_,',',2)::double precision pt2_long,
  SPLIT_PART(measurement_value_coordenadasfinal_,',',1)::double precision pt3_lat,
  SPLIT_PART(measurement_value_coordenadasfinal_,',',2)::double precision pt3_long
FROM raw_dwc.anfibios_event
UNION
SELECT cd_gp_event,
  occurrence_id, 
  TO_DATE(event_date, 'YYYY-MM-DD') date,
  REGEXP_REPLACE(SPLIT_PART(event_time,'/',1),'\s+','','g') hora_1,
  REGEXP_REPLACE(SPLIT_PART(event_time,'/',2),'\s+','','g') hora_2,
  sampling_size_value,
  event_remarks,
  decimal_latitude::double precision pt1_lat,
  decimal_longitude::double precision pt1_long,
  REGEXP_REPLACE(SPLIT_PART(measurement_value__coordenadas_intermedia_,',',1),'[ .]$','')::double precision pt2_lat,
  SPLIT_PART(measurement_value__coordenadas_intermedia_,',',2)::double precision pt2_long,
  SPLIT_PART(measurement_value__coordenadas_final_,',',1)::double precision pt3_lat,
  SPLIT_PART(measurement_value__coordenadas_final_,',',2)::double precision pt3_long
FROM raw_dwc.reptiles_event
), b AS(
SELECT
  cd_gp_event, event_id,
  REGEXP_REPLACE(event_id,'^(ANH_[0-9]{1,3})_Herp_T([0-9])_([DN])(_TE2)?$','\2')::int transect,
  REGEXP_REPLACE(event_id,'^(ANH_[0-9]{1,3})_Herp_(T[0-9])_([DN])(_TE2)?$','\3') jornada,
  CASE 
    WHEN REGEXP_REPLACE(event_id,'^(ANH_[0-9]{1,3})_Herp_(T[0-9])_([DN])(_TE2)?$','\4') ='' THEN 1
    ELSE 2
  END campaign,
  ROW_NUMBER() OVER (PARTITION BY cd_gp_event ORDER BY cd_gp_event,REGEXP_REPLACE(event_id,'^(ANH_[0-9]{1,3})_Herp_T([0-9])_([DN])(_TE2)?$','\2')::int,REGEXP_REPLACE(event_id,'^(ANH_[0-9]{1,3})_Herp_(T[0-9])_([DN])(_TE2)?$','\3')  ) num_replicate,
  'Transect:'||REGEXP_REPLACE(event_id,'^(ANH_[0-9]{1,3})_Herp_T([0-9])_([DN])(_TE2)?$','\2')||'|Jornada:'||REGEXP_REPLACE(event_id,'^(ANH_[0-9]{1,3})_Herp_(T[0-9])_([DN])(_TE2)?$','\3')||'|Campaign:'||CASE WHEN REGEXP_REPLACE(event_id,'^(ANH_[0-9]{1,3})_Herp_(T[0-9])_([DN])(_TE2)?$','\4') ='' THEN 1 ELSE 2 END description_replicate,
  (date||' '||hora_1)::timestamp date_time_begin,
  (date||' '||hora_2)::timestamp date_time_end,
  sample_size_value samp_effort_1,
  STRING_AGG(DISTINCT event_remarks, ' || ') event_remarks
FROM a
GROUP BY cd_gp_event,event_id, transect,jornada,campaign, description_replicate, date_time_begin, date_time_end, samp_effort_1
ORDER BY cd_gp_event, num_replicate
)
SELECT cd_gp_event, event_id, num_replicate, description_replicate, date_time_begin, date_time_end, samp_effort_1,event_remarks
FROM b
RETURNING  cd_gp_event, event_id, num_replicate, description_replicate
```

Ahora agregamos la información espacial:

```{sql}
WITH a AS(
SELECT event_id,
  decimal_latitude::double precision pt1_lat,
  decimal_longitude::double precision pt1_long,
  REGEXP_REPLACE(SPLIT_PART(measurement_value_coordenadas_intermedia_,',',1),'[ .]$','')::double precision pt2_lat,
  SPLIT_PART(measurement_value_coordenadas_intermedia_,',',2)::double precision pt2_long,
  SPLIT_PART(measurement_value_coordenadasfinal_,',',1)::double precision pt3_lat,
  SPLIT_PART(measurement_value_coordenadasfinal_,',',2)::double precision pt3_long
FROM raw_dwc.anfibios_event
UNION ALL
SELECT occurrence_id,
  decimal_latitude::double precision pt1_lat,
  decimal_longitude::double precision pt1_long,
  REGEXP_REPLACE(SPLIT_PART(measurement_value__coordenadas_intermedia_,',',1),'[ .]$','')::double precision pt2_lat,
  SPLIT_PART(measurement_value__coordenadas_intermedia_,',',2)::double precision pt2_long,
  SPLIT_PART(measurement_value__coordenadas_final_,',',1)::double precision pt3_lat,
  SPLIT_PART(measurement_value__coordenadas_final_,',',2)::double precision pt3_long
FROM raw_dwc.reptiles_event
), b AS(
SELECT a.event_id,
  pt1_lat,pt1_long,
  pt2_lat,pt2_long,
  pt3_lat,pt3_long,
  ROW_NUMBER() OVER (PARTITION BY a.event_id) repet
FROM a
GROUP BY  a.event_id,
  pt1_lat,pt1_long,
  pt2_lat,pt2_long,
  pt3_lat,pt3_long
), c AS(
SELECT 
 event_id,
 ST_SetSRID(ST_transform(
   ST_MakeLine(ARRAY[
     ST_SetSRID(ST_MakePoint(pt1_long,pt1_lat),4326),
     ST_SetSRID(ST_MakePoint(pt2_long,pt2_lat),4326),
     ST_SetSRID(ST_MakePoint(pt3_long,pt3_lat),4326)
   ])
 , (SELECT proj4text FROM spatial_ref_sys WHERE srid=3116)),3116) lines
FROM b
WHERE repet=1
)
UPDATE main.event AS e
SET li_geom=c.lines
FROM c
WHERE e.event_id=c.event_id
RETURNING e.event_id
;
SELECT true;
```

Damos los cd_event a todos las filas:

```{sql}
ALTER TABLE raw_dwc.anfibios_event ADD COLUMN cd_event int REFERENCES main.event(cd_event) ON DELETE SET NULL;
ALTER TABLE raw_dwc.anfibios_registros ADD COLUMN cd_event int REFERENCES main.event(cd_event);
ALTER TABLE raw_dwc.reptiles_event ADD COLUMN cd_event int REFERENCES main.event(cd_event) ON DELETE SET NULL;
ALTER TABLE raw_dwc.reptiles_registros ADD COLUMN cd_event int REFERENCES main.event(cd_event) ON DELETE SET NULL;

UPDATE raw_dwc.anfibios_event AS t
SET cd_event=e.cd_event
FROM main.event e
WHERE t.event_id=e.event_id;

UPDATE raw_dwc.anfibios_registros AS t
SET cd_event=e.cd_event
FROM main.event e
WHERE t.event_id=e.event_id;

UPDATE raw_dwc.reptiles_event AS t
SET cd_event=e.cd_event
FROM main.event e
WHERE t.occurrence_id=e.event_id;

UPDATE raw_dwc.reptiles_registros AS t
SET cd_event=e.cd_event
FROM main.event e
WHERE t.event_id=e.event_id;

SELECT true;
```


## registros

1. problem in timestamps
2. hay un taxon sin taxonomía resuelta
3. En el caso de los anfibios y de los reptiles, los organism_id no son unicos (anotar que de todas formas, hay que utilizar organism_id que son diferentes porque comparten event_id) Mi consejo: utilizar +10.000 para reptiles
4. Los occurrence_id no son unicos cuando mezclemos los reptiles y anfibios

```{sql}
SELECT occurrence_id, count(*)
FROM (SELECT occurrence_id FROM raw_dwc.anfibios_registros UNION ALL SELECT occurrence_id FROM raw_dwc.reptiles_registros) a
GROUP BY occurrence_id
HAVING count(*)>1;
```
Anfibios

```{sql}
SELECT organism_id, count(*)
FROM raw_dwc.anfibios_registros--(SELECT occurrence_id FROM raw_dwc.reptiles_registros UNION ALL SELECT occurrence_id FROM raw_dwc.reptiles_registros) a
GROUP BY organism_id
HAVING count(*)>1;
```

reptiles
```{sql}
SELECT organism_id, count(*)
FROM raw_dwc.reptiles_registros--(SELECT occurrence_id FROM raw_dwc.reptiles_registros UNION ALL SELECT occurrence_id FROM raw_dwc.reptiles_registros) a
GROUP BY organism_id
HAVING count(*)>1;
```

los dos
```{sql}
SELECT organism_id::double precision::integer, count(*)
FROM (SELECT organism_id FROM raw_dwc.reptiles_registros UNION ALL SELECT organism_id FROM raw_dwc.reptiles_registros) a
GROUP BY organism_id
HAVING count(*)>1;
```


```{sql}
/*
---TO SUPPRESS LATER
WITH a AS
(
SELECT "row.names", ROW_NUMBER() OVER (ORDER BY cd_event,event_time) nb
FROM raw_dwc.anfibios_registros
)
UPDATE raw_dwc.anfibios_registros AS r
SET organism_id=a.nb
FROM a
WHERE a."row.names"=r."row.names";
---
*/

INSERT INTO main.registros(cd_event, cds_recorded_by, date_time, cd_tax, cd_morfo, cds_identified_by, qt_int,remarks, occurrence_id, organism_id)
SELECT 
 cd_event,
 cds_recorded_by,
 (e.date_time_begin::date||' '||event_time)::timestamp date_time,
 tt.cd_tax,
 tt.cd_morfo,
 cds_identified_by,
 organism_quantity::double precision::int qt_int,
 r.event_remarks,
 occurrence_id,
 organism_id::text
FROM raw_dwc.anfibios_registros r
LEFT JOIN raw_dwc.taxonomy_total tt ON tt."row.names"=r."row.names" AND tt.table_orig='anfibios_registros'
LEFT JOIN main.event e USING (cd_event)
ORDER BY cd_event, date_time;
SELECT true;
```

Atribuir los cd_reg

Tenemos que tener una solución para separar los taxones de reptiles y anfibios


```{sql}
WITH a AS(
SELECT DISTINCT find_higher_id(cd_tax,'OR') cd_or
FROM main.registros
)
SELECT name_tax
FROM a
LEFT JOIN main.taxo t ON a.cd_or=t.cd_tax
```

```{sql}
ALTER TABLE raw_dwc.anfibios_registros ADD COLUMN cd_reg int REFERENCES main.registros(cd_reg);
UPDATE raw_dwc.anfibios_registros AS ar
SET cd_reg=r.cd_reg
FROM main.registros r
WHERE ar.cd_event=r.cd_event AND ar.organism_id::text=r.organism_id AND find_higher_id(r.cd_tax,'OR') IN (SELECT cd_tax FROM main.taxo WHERE name_tax IN ('Anura', 'Caudata'));

SELECT true;
```




```{sql}

---TO SUPPRESS LATER
WITH a AS
(
SELECT "row.names", ROW_NUMBER() OVER (ORDER BY cd_event,event_time) + (SELECT max(cd_reg) FROM main.registros)nb
FROM raw_dwc.reptiles_registros
)
UPDATE raw_dwc.reptiles_registros AS r
SET organism_id=a.nb
FROM a
WHERE a."row.names"=r."row.names";
---


INSERT INTO main.registros(cd_event, cds_recorded_by, date_time, cd_tax, cd_morfo, cds_identified_by, qt_int,remarks, occurrence_id, organism_id)
SELECT 
 cd_event,
 cds_recorded_by,
 (e.date_time_begin::date||' '||event_time)::timestamp date_time,
 tt.cd_tax,
 tt.cd_morfo,
 cds_identified_by,
 organism_quantity::double precision::int qt_int,
 r.event_remarks,
 occurrence_id||'[reptiles]', -- NOTE TO MODIFY IN FUTURE
 organism_id::double precision::int::text
FROM raw_dwc.reptiles_registros r
LEFT JOIN raw_dwc.taxonomy_total tt ON tt."row.names"=r."row.names" AND tt.table_orig='reptiles_registros'
LEFT JOIN main.event e USING (cd_event)
ORDER BY cd_event, date_time;
SELECT true;
```

Atribuir los cd_reg

Tenemos que tener una solución para separar los taxones de reptiles y reptiles


```{sql}
WITH a AS(
SELECT DISTINCT find_higher_id(cd_tax,'OR') cd_or
FROM main.registros
)
SELECT name_tax
FROM a
LEFT JOIN main.taxo t ON a.cd_or=t.cd_tax
```

```{sql}
ALTER TABLE raw_dwc.reptiles_registros ADD COLUMN cd_reg int REFERENCES main.registros(cd_reg);
UPDATE raw_dwc.reptiles_registros AS ar
SET cd_reg=r.cd_reg
FROM main.registros r
WHERE ar.cd_event=r.cd_event AND ar.organism_id::double precision::int::text=r.organism_id::text AND find_higher_id(r.cd_tax,'OR') NOT IN (SELECT cd_tax FROM main.taxo WHERE name_tax IN ('Anura', 'Caudata'));

SELECT true;
```




# Atropellamientos

## ANH

Los atropellamientas no está relacionados a ANH, pero CARAC y KAPLA podrían codificarse como ANH tambien
```{sql}
INSERT INTO main.punto_referencia(name_pt_ref)
VALUES
  ('Kapla'),('Carac')
RETURNING cd_pt_ref,name_pt_ref;
```

## Unit, sampling efforts definition, abundance definition, protocolo

Las unidades y variable son las mismas (las distancias recorridas eran en metros para los herpetos, y en km para atropellamientos, pero las voy a guardar así por ahora)

```{sql}
INSERT INTO main.def_protocol(protocol,protocol_spa,cd_var_samp_eff_1,cd_var_samp_eff_2,samp_eff_1_implicit,samp_eff_2_implicit,cd_var_ind_qt,description_spa)
VALUES(
  'Roadkill search',
  'Búsqueda de atropellamiento',
  (SELECT cd_var_samp_eff FROM main.def_var_samp_eff WHERE var_samp_eff='Covered distance'),
  (SELECT cd_var_samp_eff FROM main.def_var_samp_eff WHERE var_samp_eff='Elapsed time'),
  false,
  true,
  (SELECT cd_var_ind_qt FROM main.def_var_ind_qt WHERE var_qt_ind='Number of individuals'),
  'Búsqueda de atropellamientos'
)
RETURNING cd_protocol,protocol,protocol_spa;
```

## Personas

```{sql}
INSERT INTO main.people(verbatim_person)
WITH a AS(
SELECT DISTINCT INITCAP(TRIM(UNNEST(STRING_TO_ARRAY(recorded_by, ' | ')))) AS name_person
FROM raw_dwc.atropellamientos_registros
UNION
SELECT DISTINCT INITCAP(TRIM(UNNEST(STRING_TO_ARRAY(identified_by, ' | '))))
FROM raw_dwc.atropellamientos_registros
)
SELECT DISTINCT name_person
FROM a 
ORDER BY name_person
ON CONFLICT(verbatim_person) DO NOTHING
RETURNING cd_person, verbatim_person
```

Dar los codigos a las tables de origen:

```{sql}
ALTER TABLE raw_dwc.atropellamientos_registros ADD COLUMN cds_recorded_by int[];
WITH a AS(
SELECT "row.names", INITCAP(TRIM(UNNEST(STRING_TO_ARRAY(recorded_by, ' | ')))) AS name_person
FROM raw_dwc.atropellamientos_registros
),b AS(
SELECT "row.names", ARRAY_AGG(cd_person) cds
FROM a 
LEFT JOIN main.people p ON a.name_person=p.verbatim_person
GROUP BY "row.names"
)
UPDATE raw_dwc.atropellamientos_registros AS r
SET cds_recorded_by=b.cds
FROM b
WHERE r."row.names"=b."row.names"
RETURNING r."row.names", cds_recorded_by
;
ALTER TABLE raw_dwc.atropellamientos_registros ADD COLUMN cds_identified_by int[];
WITH a AS(
SELECT "row.names", INITCAP(TRIM(UNNEST(STRING_TO_ARRAY(identified_by, ' | ')))) AS name_person
FROM raw_dwc.atropellamientos_registros
),b AS(
SELECT "row.names", ARRAY_AGG(cd_person) cds
FROM a 
LEFT JOIN main.people p ON a.name_person=p.verbatim_person
GROUP BY "row.names"
)
UPDATE raw_dwc.atropellamientos_registros AS r
SET cds_identified_by=b.cds
FROM b
WHERE r."row.names"=b."row.names"
RETURNING r."row.names", cds_identified_by
;
SELECT 1;
```

## gp_event

Una manera de hacer los gps event es considerar que cada ves que se hace CARAC (o KAPLA) es una repetición...
Así cada mes es una campaña diferente: en lugar de tener 2 campañas, tenemos 5


```{sql}
WITH a AS(
SELECT 
  event_id, 
  TO_DATE(event_date,'YYYY-MM-DD'),
  REGEXP_REPLACE(event_id,'^([A-Z][a-z]+)-((CARAC)|(KAPLA))_([0-9]{1,3})$','\1') mes,
  REGEXP_REPLACE(event_id,'^([A-Z][a-z]+)-((CARAC)|(KAPLA))_([0-9]{1,3})$','\2') reco,
  REGEXP_REPLACE(event_id,'^([A-Z][a-z]+)-((CARAC)|(KAPLA))_([0-9]{1,3})$','\5') number,
  count(*)
  
FROM raw_dwc.atropellamientos_event
GROUP BY  event_id, TO_DATE(event_date,'YYYY-MM-DD'), mes
ORDER BY  TO_DATE(event_date,'YYYY-MM-DD')
)
SELECT * 
FROM a
;
```

```{sql}
WITH a AS(
SELECT 
  --event_id, 
  --TO_DATE(event_date,'YYYY-MM-DD'),
  REGEXP_REPLACE(event_id,'^([A-Z][a-z]+)-((CARAC)|(KAPLA))_([0-9]{1,3})$','\1') mes,
  INITCAP(REGEXP_REPLACE(event_id,'^([A-Z][a-z]+)-((CARAC)|(KAPLA))_([0-9]{1,3})$','\2')) reco,
  MIN(TO_DATE(event_date,'YYYY-MM-DD')) min_fecha,
  --REGEXP_REPLACE(event_id,'^([A-Z][a-z]+)-((CARAC)|(KAPLA))_([0-9]{1,3})$','\5') number,
  count(*)
  
FROM raw_dwc.atropellamientos_event
GROUP BY  mes,reco
ORDER BY reco,mes-- TO_DATE(event_date,'YYYY-MM-DD')
)
SELECT ROW_NUMBER() OVER (PARTITION BY reco ORDER BY min_fecha) campaign_nb ,* 
FROM a
;
```
  
```{sql}
INSERT INTO main.gp_event(cd_pt_ref,cd_gp_biol, cd_protocol, campaign_nb)
WITH a AS(
SELECT 
  --event_id, 
  --TO_DATE(event_date,'YYYY-MM-DD'),
  REGEXP_REPLACE(event_id,'^([A-Z][a-z]+)-((CARAC)|(KAPLA))_([0-9]{1,3})$','\1') mes,
  INITCAP(REGEXP_REPLACE(event_id,'^([A-Z][a-z]+)-((CARAC)|(KAPLA))_([0-9]{1,3})$','\2')) reco,
  MIN(TO_DATE(event_date,'YYYY-MM-DD')) min_fecha,
  --REGEXP_REPLACE(event_id,'^([A-Z][a-z]+)-((CARAC)|(KAPLA))_([0-9]{1,3})$','\5') number,
  count(*)
  
FROM raw_dwc.atropellamientos_event
GROUP BY  mes,reco
ORDER BY reco,mes-- TO_DATE(event_date,'YYYY-MM-DD')
)
SELECT cd_pt_ref, 
  'atro', 
  (SELECT cd_protocol FROM main.def_protocol WHERE protocol='Roadkill search'),
  ROW_NUMBER() OVER (PARTITION BY reco ORDER BY min_fecha) campaign_nb
FROM a
JOIN main.punto_referencia pr ON a.reco=pr.name_pt_ref
RETURNING gp_event.*
;
```


Attributing the gp_event

```{sql}
ALTER TABLE raw_dwc.atropellamientos_event ADD COLUMN cd_gp_event int REFERENCES main.gp_event(cd_gp_event) ON DELETE SET NULL;

WITH a AS(
SELECT 
  --event_id, 
  --TO_DATE(event_date,'YYYY-MM-DD'),
  REGEXP_REPLACE(event_id,'^([A-Z][a-z]+)-((CARAC)|(KAPLA))_([0-9]{1,3})$','\1') mes,
  INITCAP(REGEXP_REPLACE(event_id,'^([A-Z][a-z]+)-((CARAC)|(KAPLA))_([0-9]{1,3})$','\2')) reco,
  MIN(TO_DATE(event_date,'YYYY-MM-DD')) min_fecha,
  --REGEXP_REPLACE(event_id,'^([A-Z][a-z]+)-((CARAC)|(KAPLA))_([0-9]{1,3})$','\5') number,
  count(*)
  
FROM raw_dwc.atropellamientos_event
GROUP BY  mes,reco
ORDER BY reco,mes-- TO_DATE(event_date,'YYYY-MM-DD')
), b AS(
SELECT *,
  ROW_NUMBER() OVER (PARTITION BY reco ORDER BY min_fecha) campaign_nb
FROM a
JOIN main.punto_referencia pr ON a.reco=pr.name_pt_ref
), c AS(
SELECT "row.names", ge.cd_gp_event
FROM raw_dwc.atropellamientos_event e
LEFT JOIN b ON REGEXP_REPLACE(event_id,'^([A-Z][a-z]+)-((CARAC)|(KAPLA))_([0-9]{1,3})$','\1')=b.mes
  AND INITCAP(REGEXP_REPLACE(event_id,'^([A-Z][a-z]+)-((CARAC)|(KAPLA))_([0-9]{1,3})$','\2'))=b.reco
--cuidado eso no funciona para los grupos que comparten ANH con otros grupos
LEFT JOIN main.gp_event ge USING(cd_pt_ref,campaign_nb)
)
UPDATE raw_dwc.atropellamientos_event AS e
SET cd_gp_event=c.cd_gp_event
FROM c 
WHERE c."row.names"=e."row.names";

SELECT 'true';
```

## event


\footnotesize

```{sql}
WITH a AS(
SELECT cd_gp_event,
  event_id, 
  REGEXP_REPLACE(event_id,'^([A-Z][a-z]+)-((CARAC)|(KAPLA))_([0-9]{1,3})$','\1') mes,
  INITCAP(REGEXP_REPLACE(event_id,'^([A-Z][a-z]+)-((CARAC)|(KAPLA))_([0-9]{1,3})$','\2')) reco,
  REGEXP_REPLACE(event_id,'^([A-Z][a-z]+)-((CARAC)|(KAPLA))_([0-9]{1,3})$','\5')::int number,
  TO_DATE(event_date, 'YYYY-MM-DD') date,
  REGEXP_REPLACE(SPLIT_PART(event_time,'/',1),'\s+','','g') hora_1,
  REGEXP_REPLACE(SPLIT_PART(event_time,'/',2),'\s+','','g') hora_2,
  sample_size_value,
  --REGEXP_REPLACE(event_remarks,'La hora inicial corresponde al comienzo del recorrido y la hora final cuando termina;? ?\|?','')||' | '||event_remarks_1 event_remarks,
  event_remarks_1 event_remarks,
  locality,
  decimal_latitude::double precision pt1_lat,
  decimal_longitude::double precision pt1_long,
  REGEXP_REPLACE(SPLIT_PART(measurement_value__coordenadas_intermedia_,',',1),'[ .]$','')::double precision pt2_lat,
  SPLIT_PART(measurement_value__coordenadas_intermedia_,',',2)::double precision pt2_long,
  SPLIT_PART(measurement_value__coordenadas_final_,',',1)::double precision pt3_lat,
  SPLIT_PART(measurement_value__coordenadas_final_,',',2)::double precision pt3_long,
  (sample_size_value::double precision)*1000 samp_effort_1
FROM raw_dwc.atropellamientos_event
ORDER BY cd_gp_event, number
)
 SELECT 
  event_id,
  cd_gp_event,
  ROW_NUMBER() OVER (PARTITION BY cd_gp_event ORDER BY number) num_replicate,
  REGEXP_REPLACE(event_id,'^([A-Z][a-z]+)-((CARAC)|(KAPLA))_([0-9]{1,3})$','month:\1|route:\2|route_repetition_number:\5') description_replicate,
  (date||' '||hora_1)::timestamp date_time_begin,
  (date||' '||hora_2)::timestamp date_time_end,
  locality,
  samp_effort_1,
  event_remarks/*,
  ST_transform(
   ST_MakeLine(ARRAY[
     ST_SetSRID(ST_MakePoint(pt1_long,pt1_lat),4326),
     ST_SetSRID(ST_MakePoint(pt2_long,pt2_lat),4326),
     ST_SetSRID(ST_MakePoint(pt3_long,pt3_lat),4326)
   ])
 ,3116) lines*/
FROM a
```
\normalsize


```{sql}
INSERT INTO main.event(event_id, cd_gp_event, num_replicate, description_replicate, date_time_begin, date_time_end, locality_verb, samp_effort_1, event_remarks, li_geom)
WITH a AS(
SELECT cd_gp_event,
  event_id, 
  REGEXP_REPLACE(event_id,'^([A-Z][a-z]+)-((CARAC)|(KAPLA))_([0-9]{1,3})$','\1') mes,
  INITCAP(REGEXP_REPLACE(event_id,'^([A-Z][a-z]+)-((CARAC)|(KAPLA))_([0-9]{1,3})$','\2')) reco,
  REGEXP_REPLACE(event_id,'^([A-Z][a-z]+)-((CARAC)|(KAPLA))_([0-9]{1,3})$','\5')::int number,
  TO_DATE(event_date, 'YYYY-MM-DD') date,
  REGEXP_REPLACE(SPLIT_PART(event_time,'/',1),'\s+','','g') hora_1,
  REGEXP_REPLACE(SPLIT_PART(event_time,'/',2),'\s+','','g') hora_2,
  sample_size_value,
  --REGEXP_REPLACE(event_remarks,'La hora inicial corresponde al comienzo del recorrido y la hora final cuando termina;? ?\|?','')||' | '||event_remarks_1 event_remarks,
  event_remarks_1 event_remarks,
  locality,
  decimal_latitude::double precision pt1_lat,
  decimal_longitude::double precision pt1_long,
  REGEXP_REPLACE(SPLIT_PART(measurement_value__coordenadas_intermedia_,',',1),'[ .]$','')::double precision pt2_lat,
  SPLIT_PART(measurement_value__coordenadas_intermedia_,',',2)::double precision pt2_long,
  SPLIT_PART(measurement_value__coordenadas_final_,',',1)::double precision pt3_lat,
  SPLIT_PART(measurement_value__coordenadas_final_,',',2)::double precision pt3_long,
  (sample_size_value::double precision)*1000 samp_effort_1
FROM raw_dwc.atropellamientos_event
ORDER BY cd_gp_event, number
)
 SELECT 
  event_id,
  cd_gp_event,
  ROW_NUMBER() OVER (PARTITION BY cd_gp_event ORDER BY number) num_replicate,
  REGEXP_REPLACE(event_id,'^([A-Z][a-z]+)-((CARAC)|(KAPLA))_([0-9]{1,3})$','month:\1|route:\2|route_repetition_number:\5') description_replicate,
  (date||' '||hora_1)::timestamp date_time_begin,
  (date||' '||hora_2)::timestamp date_time_end,
  locality,
  samp_effort_1,
  event_remarks,
 ST_transform(
   ST_MakeLine(ARRAY[
     ST_SetSRID(ST_MakePoint(pt1_long,pt1_lat),4326),
     ST_SetSRID(ST_MakePoint(pt2_long,pt2_lat),4326),
     ST_SetSRID(ST_MakePoint(pt3_long,pt3_lat),4326)
   ])
 ,(SELECT proj4text FROM spatial_ref_sys WHERE srid=3116)) lines
FROM a
RETURNING main.event.cd_event, main.event.event_id;
```

Damos los cd_event a todos las filas:

```{sql}
ALTER TABLE raw_dwc.atropellamientos_event ADD COLUMN cd_event int REFERENCES main.event(cd_event) ON DELETE SET NULL;
ALTER TABLE raw_dwc.atropellamientos_registros ADD COLUMN cd_event int REFERENCES main.event(cd_event);

UPDATE raw_dwc.atropellamientos_event AS t
SET cd_event=e.cd_event
FROM main.event e
WHERE t.event_id=e.event_id;

UPDATE raw_dwc.atropellamientos_registros AS t
SET cd_event=e.cd_event
FROM main.event e
WHERE t.event_id=e.event_id;

SELECT true;
```


## registros


```{sql}
INSERT INTO main.registros(cd_event, cds_recorded_by, date_time, cd_tax, cd_morfo, cds_identified_by, qt_int,remarks, occurrence_id, organism_id, the_geom)
SELECT 
 cd_event,
 cds_recorded_by,
 (e.date_time_begin::date||' '||event_time)::timestamp date_time,
 tt.cd_tax,
 tt.cd_morfo,
 cds_identified_by,
 organism_quantity::int qt_int,
 NULL remarks,
 occurrence_id,
 organism_id,
 ST_SetSRID(ST_Transform(ST_SetSRID(ST_MakePoint(measurement_value__longitud_,measurement_value__latitud_), 4326),  (SELECT proj4text FROM spatial_ref_sys WHERE srid=3116)),3116)
FROM raw_dwc.atropellamientos_registros r
LEFT JOIN raw_dwc.taxonomy_total tt ON tt."row.names"=r."row.names" AND tt.table_orig='atropellamientos_registros'
LEFT JOIN main.event e USING (cd_event)
ORDER BY cd_event, date_time;
SELECT true;
```

Atribuir los cd_reg

Tenemos que tener una solución para separar los taxones de reptiles y atropellamientos



```{sql}
ALTER TABLE raw_dwc.atropellamientos_registros ADD COLUMN cd_reg int REFERENCES main.registros(cd_reg);
UPDATE raw_dwc.atropellamientos_registros AS ar
SET cd_reg=r.cd_reg
FROM main.registros r
WHERE ar.cd_event=r.cd_event AND ar.organism_id=r.organism_id;

SELECT true;
```



# Mariposas


## ANH


Entender el plan de muestreo

```{sql}
SELECT 
  event_id,
  REGEXP_REPLACE(event_id,'^ANH_([0-9]{1,3})_T\. Van Someren-Rydon([0-9])_(202[12]-[0-9][0-9]-[0-9][0-9])/(202[12]-[0-9][0-9]-[0-9][0-9])$','\1')::int anh_num,
  REGEXP_REPLACE(event_id,'^ANH_([0-9]{1,3})_T\. Van Someren-Rydon([0-9])_(202[12]-[0-9][0-9]-[0-9][0-9])/(202[12]-[0-9][0-9]-[0-9][0-9])$','\2')::int trap_num,
  REGEXP_REPLACE(event_id,'^ANH_([0-9]{1,3})_T\. Van Someren-Rydon([0-9])_(202[12]-[0-9][0-9]-[0-9][0-9])/(202[12]-[0-9][0-9]-[0-9][0-9])$','\3')::date fecha1,
  REGEXP_REPLACE(event_id,'^ANH_([0-9]{1,3})_T\. Van Someren-Rydon([0-9])_(202[12]-[0-9][0-9]-[0-9][0-9])/(202[12]-[0-9][0-9]-[0-9][0-9])$','\4')::date fecha2
FROM raw_dwc.mariposas_event
ORDER BY anh_num, fecha1, trap_num
```

```{sql}
WITH a AS(
SELECT 
  event_id,
  REGEXP_REPLACE(event_id,'^ANH_([0-9]{1,3})_T\. Van Someren-Rydon([0-9])_(202[12]-[0-9][0-9]-[0-9][0-9])/(202[12]-[0-9][0-9]-[0-9][0-9])$','\1')::int anh_num,
  REGEXP_REPLACE(event_id,'^ANH_([0-9]{1,3})_T\. Van Someren-Rydon([0-9])_(202[12]-[0-9][0-9]-[0-9][0-9])/(202[12]-[0-9][0-9]-[0-9][0-9])$','\2')::int trap_num,
  REGEXP_REPLACE(event_id,'^ANH_([0-9]{1,3})_T\. Van Someren-Rydon([0-9])_(202[12]-[0-9][0-9]-[0-9][0-9])/(202[12]-[0-9][0-9]-[0-9][0-9])$','\3')::date fecha1,
  REGEXP_REPLACE(event_id,'^ANH_([0-9]{1,3})_T\. Van Someren-Rydon([0-9])_(202[12]-[0-9][0-9]-[0-9][0-9])/(202[12]-[0-9][0-9]-[0-9][0-9])$','\4')::date fecha2
FROM raw_dwc.mariposas_event
ORDER BY anh_num, fecha1, trap_num
)
SELECT anh_num, EXTRACT(YEAR FROM fecha1) "year",ARRAY_AGG(trap_num),count(*)
FROM a
GROUP BY anh_num ,EXTRACT(YEAR FROM fecha1)
ORDER BY anh_num, EXTRACT(YEAR FROM fecha1),count(*)

```


Insertar los datos de anh:

```{sql}
INSERT INTO main.punto_referencia(name_pt_ref, num_anh)
WITH a AS(
SELECT 
  event_id,
  REGEXP_REPLACE(event_id,'^ANH_([0-9]{1,3})_T\. Van Someren-Rydon([0-9])_(202[12]-[0-9][0-9]-[0-9][0-9])/(202[12]-[0-9][0-9]-[0-9][0-9])$','\1')::int anh_num,
  REGEXP_REPLACE(event_id,'^ANH_([0-9]{1,3})_T\. Van Someren-Rydon([0-9])_(202[12]-[0-9][0-9]-[0-9][0-9])/(202[12]-[0-9][0-9]-[0-9][0-9])$','\2')::int trap_num,
  REGEXP_REPLACE(event_id,'^ANH_([0-9]{1,3})_T\. Van Someren-Rydon([0-9])_(202[12]-[0-9][0-9]-[0-9][0-9])/(202[12]-[0-9][0-9]-[0-9][0-9])$','\3')::date fecha1,
  REGEXP_REPLACE(event_id,'^ANH_([0-9]{1,3})_T\. Van Someren-Rydon([0-9])_(202[12]-[0-9][0-9]-[0-9][0-9])/(202[12]-[0-9][0-9]-[0-9][0-9])$','\4')::date fecha2
FROM raw_dwc.mariposas_event
)
SELECT 'ANH_'||anh_num, anh_num
FROM a
GROUP BY anh_num
ORDER BY anh_num
ON CONFLICT (name_pt_ref) DO NOTHING
RETURNING cd_pt_ref
;
```

dar las referencias en las tablas de mariposas

```{sql}
ALTER TABLE raw_dwc.mariposas_event ADD COLUMN cd_pt_ref int REFERENCES main.punto_referencia(cd_pt_ref) ON DELETE SET NULL ON UPDATE CASCADE;
ALTER TABLE raw_dwc.mariposas_registros ADD COLUMN cd_pt_ref int REFERENCES main.punto_referencia(cd_pt_ref) ON DELETE SET NULL ON UPDATE CASCADE;

UPDATE raw_dwc.mariposas_event
SET cd_pt_ref=pr.cd_pt_ref
FROM main.punto_referencia pr
WHERE REGEXP_REPLACE(event_id,'^(ANH_[0-9]{1,3})_T\. Van Someren-Rydon([0-9])_(202[12]-[0-9][0-9]-[0-9][0-9])/(202[12]-[0-9][0-9]-[0-9][0-9])$','\1')=pr.name_pt_ref
;

UPDATE raw_dwc.mariposas_registros
SET cd_pt_ref=pr.cd_pt_ref
FROM main.punto_referencia pr
WHERE REGEXP_REPLACE(event_id,'^(ANH_[0-9]{1,3})_T\. Van Someren-Rydon([0-9])_(202[12]-[0-9][0-9]-[0-9][0-9])/(202[12]-[0-9][0-9]-[0-9][0-9])$','\1')=pr.name_pt_ref
;

SELECT true;
```

Averiguando que ninguna fila no tenga anh

```{sql}
SELECT * FROM raw_dwc.mariposas_event WHERE cd_pt_ref IS NULL;
```

```{sql}
SELECT * FROM raw_dwc.mariposas_registros WHERE cd_pt_ref IS NULL;
```

## Unit, sampling efforts definition, abundance definition, protocolo

No hay nuevas unidades, ni variables que añadir (vamos a utilizar minutos para el tiempo de sampling effort), y 'Duración' para la variable de sampling effort


```{sql}
INSERT INTO main.def_protocol(protocol,protocol_spa,cd_var_samp_eff_1,cd_var_samp_eff_2,samp_eff_1_implicit,samp_eff_2_implicit,cd_var_ind_qt,description_spa)
VALUES(
  'VS-R trap',
  'Trampa VS-R',
  (SELECT cd_var_samp_eff FROM main.def_var_samp_eff WHERE var_samp_eff='Elapsed time'),
  NULL,
  true,
  false,
  (SELECT cd_var_ind_qt FROM main.def_var_ind_qt WHERE var_qt_ind='Number of individuals'),
  'Trampa Van Someren-Rydon'
)
RETURNING cd_protocol,protocol,protocol_spa;
```

## Personas

```{sql}
INSERT INTO main.people(verbatim_person)
WITH a AS(
SELECT DISTINCT INITCAP(TRIM(UNNEST(STRING_TO_ARRAY(recorded_by, ' | ')))) AS name_person
FROM raw_dwc.mariposas_registros
UNION
SELECT DISTINCT INITCAP(TRIM(UNNEST(STRING_TO_ARRAY(identified_by, ' | '))))
FROM raw_dwc.mariposas_registros
)
SELECT DISTINCT REGEXP_REPLACE(name_person, '- ','-')
FROM a 
ORDER BY REGEXP_REPLACE(name_person, '- ','-')
ON CONFLICT(verbatim_person) DO NOTHING
RETURNING cd_person, verbatim_person
```

Dar los codigos a las tables de origen:

```{sql}
ALTER TABLE raw_dwc.mariposas_registros ADD COLUMN cds_recorded_by int[];

WITH a AS(
SELECT "row.names", REGEXP_REPLACE(INITCAP(TRIM(UNNEST(STRING_TO_ARRAY(recorded_by, ' | ')))),'- ','-') AS name_person
FROM raw_dwc.mariposas_registros
),b AS(
SELECT "row.names", ARRAY_AGG(cd_person) cds
FROM a 
LEFT JOIN main.people p ON a.name_person=p.verbatim_person
GROUP BY "row.names"
)
UPDATE raw_dwc.mariposas_registros AS r
SET cds_recorded_by=b.cds
FROM b
WHERE r."row.names"=b."row.names"
RETURNING r."row.names", cds_recorded_by
;

ALTER TABLE raw_dwc.mariposas_registros ADD COLUMN cds_identified_by int[];

WITH a AS(
SELECT "row.names", REGEXP_REPLACE(INITCAP(TRIM(UNNEST(STRING_TO_ARRAY(identified_by, ' | ')))),'- ','-') AS name_person
FROM raw_dwc.mariposas_registros
),b AS(
SELECT "row.names", ARRAY_AGG(cd_person) cds
FROM a 
LEFT JOIN main.people p ON a.name_person=p.verbatim_person
GROUP BY "row.names"
)
UPDATE raw_dwc.mariposas_registros AS r
SET cds_identified_by=b.cds
FROM b
WHERE r."row.names"=b."row.names"
RETURNING r."row.names", cds_identified_by
;

SELECT 1;
```

## gp_event

```{sql}
WITH a AS(
SELECT 
  event_id,
  REGEXP_REPLACE(event_id,'^ANH_([0-9]{1,3})_T\. Van Someren-Rydon([0-9])_(202[12]-[0-9][0-9]-[0-9][0-9])/(202[12]-[0-9][0-9]-[0-9][0-9])$','\1')::int anh_num,
  REGEXP_REPLACE(event_id,'^ANH_([0-9]{1,3})_T\. Van Someren-Rydon([0-9])_(202[12]-[0-9][0-9]-[0-9][0-9])/(202[12]-[0-9][0-9]-[0-9][0-9])$','\2')::int trap_num,
  REGEXP_REPLACE(event_id,'^ANH_([0-9]{1,3})_T\. Van Someren-Rydon([0-9])_(202[12]-[0-9][0-9]-[0-9][0-9])/(202[12]-[0-9][0-9]-[0-9][0-9])$','\3')::date fecha1,
  REGEXP_REPLACE(event_id,'^ANH_([0-9]{1,3})_T\. Van Someren-Rydon([0-9])_(202[12]-[0-9][0-9]-[0-9][0-9])/(202[12]-[0-9][0-9]-[0-9][0-9])$','\4')::date fecha2
FROM raw_dwc.mariposas_event
ORDER BY anh_num, fecha1, trap_num
)
SELECT EXTRACT(YEAR FROM fecha1), anh_num, ARRAY_AGG(trap_num), count(*)
FROM a
GROUP BY EXTRACT(YEAR FROM fecha1), anh_num
ORDER BY EXTRACT(YEAR FROM fecha1), anh_num
;
```


```{sql}
INSERT INTO main.gp_event(cd_gp_biol,cd_protocol,cd_pt_ref,campaign_nb)
WITH a AS(
SELECT 
  event_id,
  REGEXP_REPLACE(event_id,'^ANH_([0-9]{1,3})_T\. Van Someren-Rydon([0-9])_(202[12]-[0-9][0-9]-[0-9][0-9])/(202[12]-[0-9][0-9]-[0-9][0-9])$','\1')::int anh_num,
  REGEXP_REPLACE(event_id,'^ANH_([0-9]{1,3})_T\. Van Someren-Rydon([0-9])_(202[12]-[0-9][0-9]-[0-9][0-9])/(202[12]-[0-9][0-9]-[0-9][0-9])$','\2')::int trap_num,
  REGEXP_REPLACE(event_id,'^ANH_([0-9]{1,3})_T\. Van Someren-Rydon([0-9])_(202[12]-[0-9][0-9]-[0-9][0-9])/(202[12]-[0-9][0-9]-[0-9][0-9])$','\3')::date fecha1,
  REGEXP_REPLACE(event_id,'^ANH_([0-9]{1,3})_T\. Van Someren-Rydon([0-9])_(202[12]-[0-9][0-9]-[0-9][0-9])/(202[12]-[0-9][0-9]-[0-9][0-9])$','\4')::date fecha2,
  cd_pt_ref
FROM raw_dwc.mariposas_event
ORDER BY anh_num, fecha1, trap_num
), b AS(
SELECT EXTRACT(YEAR FROM fecha1) año, anh_num, cd_pt_ref, ARRAY_AGG(trap_num), count(*)
FROM a
GROUP BY año, anh_num, cd_pt_ref
ORDER BY año, cd_pt_ref
)
SELECT 'mari', (SELECT cd_protocol FROM main.def_protocol WHERE protocol='VS-R trap'),cd_pt_ref, ROW_NUMBER() OVER (PARTITION BY cd_pt_ref  ORDER BY año) num_gp
FROM b
JOIN main.punto_referencia USING (cd_pt_ref)
GROUP BY cd_pt_ref, name_pt_ref, año
ORDER BY año,cd_pt_ref
RETURNING cd_gp_event,cd_gp_biol,cd_protocol,cd_pt_ref,campaign_nb
;
```

Attributing the gp_event

```{sql}
ALTER TABLE raw_dwc.mariposas_event ADD COLUMN cd_gp_event int REFERENCES main.gp_event(cd_gp_event) ON DELETE SET NULL;

WITH a AS(
SELECT 
  event_id,
  REGEXP_REPLACE(event_id,'^ANH_([0-9]{1,3})_T\. Van Someren-Rydon([0-9])_(202[12]-[0-9][0-9]-[0-9][0-9])/(202[12]-[0-9][0-9]-[0-9][0-9])$','\1')::int anh_num,
  EXTRACT (YEAR FROM REGEXP_REPLACE(event_id,'^ANH_([0-9]{1,3})_T\. Van Someren-Rydon([0-9])_(202[12]-[0-9][0-9]-[0-9][0-9])/(202[12]-[0-9][0-9]-[0-9][0-9])$','\3')::date) año,
  cd_pt_ref
FROM raw_dwc.mariposas_event
ORDER BY anh_num, año
), b AS(
SELECT año, anh_num, cd_pt_ref, count(*)
FROM a
GROUP BY año, anh_num, cd_pt_ref
ORDER BY año, cd_pt_ref
),c AS(
SELECT cd_pt_ref, año, ROW_NUMBER() OVER (PARTITION BY cd_pt_ref  ORDER BY año) num_gp
FROM b
JOIN main.punto_referencia USING (cd_pt_ref)
GROUP BY cd_pt_ref, name_pt_ref, año
ORDER BY año,cd_pt_ref
), d AS(
SELECT event_id, cd_gp_event
FROM a
LEFT JOIN b USING (cd_pt_ref,año)
LEFT JOIN c USING (cd_pt_ref,año)
LEFT JOIN main.gp_event e ON e.cd_gp_biol='mari' AND e.campaign_nb=c.num_gp AND c.cd_pt_ref=e.cd_pt_ref
)
UPDATE raw_dwc.mariposas_event e
SET cd_gp_event=d.cd_gp_event
FROM d
WHERE d.event_id=e.event_id
RETURNING e.event_id, e.cd_gp_event
;
```

## event

2. pb de formato en las horas

\footnotesize

```{sql}
INSERT INTO main.event(cd_gp_event,event_id,num_replicate, description_replicate, date_time_begin, date_time_end, locality_verb, event_remarks, pt_geom)
WITH a AS(
SELECT cd_gp_event,
  event_id, 
  REGEXP_REPLACE(event_id,'^ANH_([0-9]{1,3})_T\. Van Someren-Rydon([0-9])_(202[12]-[0-9][0-9]-[0-9][0-9])/(202[12]-[0-9][0-9]-[0-9][0-9])$','\2')::int num_replicate,
  REGEXP_REPLACE(event_id,'^ANH_([0-9]{1,3})_(T\. Van Someren-Rydon[0-9]_202[12]-[0-9][0-9]-[0-9][0-9]/202[12]-[0-9][0-9]-[0-9][0-9])$','\2') description_replicate,
  event_date,
  TO_DATE(SPLIT_PART(event_date,'/',1), 'YYYY-MM-DD') date_1,
  TO_DATE(SPLIT_PART(event_date,'/',2), 'YYYY-MM-DD') date_2,
  REGEXP_REPLACE(REGEXP_REPLACE(SPLIT_PART(event_time,'/',1),'\s+','','g'),'[^0-9]+$','') hora_1,
  CASE
  	WHEN REGEXP_REPLACE(SPLIT_PART(event_time,'/',2),'\s+','','g')='' THEN NULL
	ELSE REGEXP_REPLACE(SPLIT_PART(event_time,'/',2),'\s+','','g')
  END hora_2,
  locality locality_verb,
  sample_size_value,
  -- event_remarks, -- concierne unas modificaciones que vamos a hacer en la proxima etapa, o la ausencia de registro que se puede determinar automaticamente
  location_remarks,
  decimal_latitude::double precision,
  decimal_longitude::double precision
FROM raw_dwc.mariposas_event
)
SELECT 
  cd_gp_event,
  event_id, 
  num_replicate,
  description_replicate,
  CASE
  	--WHEN hora_1 IS NULL THEN ("date_1"||' '||'10:12:00')::timestamp
  	WHEN hora_1 IS NULL THEN NULL::timestamp
	ELSE ("date_1"||' '||hora_1)::timestamp
  END date_time_begin,
  CASE
        --WHEN hora_1 IS NULL AND hora_2 IS NULL THEN (("date_1"||' '||'10:12:00')::timestamp + '48 hours')
	--WHEN hora_2 IS NULL THEN (("date_1"||' '||hora_1)::timestamp + '48 hours')
	WHEN hora_2 IS NULL THEN NULL
	ELSE ("date_2"||' '||hora_2)::timestamp
  END date_time_end,
  locality_verb,
  location_remarks event_remarks,
  /*CASE
  	WHEN hora_1 IS NULL AND hora_2 IS NULL THEN location_remarks||'| La hora inicial no estaba disponible se pusó la hora promedia: 10:12, la hora final se pusó 48h después'
	WHEN hora_2 IS NULL THEN location_remarks||'| La hora final no estaba disponible, se pusó 48 horas despues de la hora inicial'
	ELSE location_remarks
  END event_remarks,*/
  ST_SetSRID(ST_Transform(ST_SetSRID(ST_MakePoint(decimal_longitude,decimal_latitude),4326), (SELECT proj4text FROM spatial_ref_sys WHERE srid=3116)),3116)
FROM a
RETURNING main.event.cd_event, main.event.cd_gp_event, main.event.event_id, main.event.num_replicate, main.event.description_replicate, main.event.date_time_begin, main.event.date_time_end, main.event.locality_verb, main.event.event_remarks, main.event.pt_geom
```

Damos los cd_event a todos las filas:

```{sql}
ALTER TABLE raw_dwc.mariposas_event ADD COLUMN cd_event int REFERENCES main.event(cd_event) ON DELETE SET NULL;
ALTER TABLE raw_dwc.mariposas_registros ADD COLUMN cd_event int REFERENCES main.event(cd_event);

UPDATE raw_dwc.mariposas_event AS t
SET cd_event=e.cd_event
FROM main.event e
WHERE t.event_id=e.event_id;

UPDATE raw_dwc.mariposas_registros AS t
SET cd_event=e.cd_event
FROM main.event e
WHERE t.event_id=e.event_id;

SELECT true;
```

Añadir fechas en la tabla extra cuando las horas no son disponibles

```{sql}
INSERT INTO main.def_var_event_extra(var_event_extra, type_var, var_event_extra_spa, var_event_extra_comment)
VALUES
  ('date_begin',
  'free text',
  'fecha_inicial',
  'This variable exists when the time associated with the beginning of the event does not exists (timestamp is null then). Note that the date is given as text and has to be transformed to be uses as date. format is YYYY-MM_DD'
  ),(
  'date_end',
  'free text',
  'fecha_final',
  'This variable exists when either the time or date associated with the end of the event is not available (timestamp is null then). Note that the date is given as text. format is YYYY-MM-DD'
  );

INSERT INTO main.event_extra(cd_event, cd_var_event_extra,value_text)
WITH a AS(
SELECT cd_event,ef.date_time_begin,ef.date_time_end,
  TO_DATE(SPLIT_PART(event_date,'/',1), 'YYYY-MM-DD') date_1,
  TO_DATE(SPLIT_PART(event_date,'/',2), 'YYYY-MM-DD') date_2
FROM raw_dwc.mariposas_event e
LEFT JOIN main.event ef USING (cd_event)
WHERE date_time_begin IS NULL OR date_time_end IS NULL
),b AS(
SELECT cd_event,
  CASE
   WHEN date_time_begin IS NULL THEN date_1
   ELSE NULL
  END date_begin
FROM a
)
SELECT 
 cd_event,
 (SELECT cd_var_event_extra FROM main.def_var_event_extra WHERE var_event_extra='date_begin'),
 to_char(date_begin,'yyyy-mm-dd')::text
FROM b
WHERE date_begin IS NOT NULL
RETURNING main.event_extra.cd_event, main.event_extra.cd_var_event_extra, main.event_extra.value_text
;
INSERT INTO main.event_extra(cd_event, cd_var_event_extra,value_text)
WITH a AS(
SELECT cd_event,ef.date_time_begin,ef.date_time_end,
  TO_DATE(SPLIT_PART(event_date,'/',1), 'YYYY-MM-DD') date_1,
  TO_DATE(SPLIT_PART(event_date,'/',2), 'YYYY-MM-DD') date_2
FROM raw_dwc.mariposas_event e
LEFT JOIN main.event ef USING (cd_event)
WHERE date_time_begin IS NULL OR date_time_end IS NULL
),b AS(
SELECT cd_event,
  CASE
   WHEN date_time_end IS NULL THEN date_2
   ELSE NULL
  END date_end
FROM a
)
SELECT 
 cd_event,
 (SELECT cd_var_event_extra FROM main.def_var_event_extra WHERE var_event_extra='date_end'),
 to_char(date_end,'yyyy-mm-dd')::text
FROM b
WHERE date_end IS NOT NULL
RETURNING main.event_extra.cd_event, main.event_extra.cd_var_event_extra, main.event_extra.value_text
;
```

## registros

```{sql}
SELECT occurrence_id, count(*)
FROM raw_dwc.mariposas_registros 
GROUP BY occurrence_id
HAVING count(*)>1;
```

```{sql}

INSERT INTO main.registros(cd_event, cds_recorded_by, date_time, cd_tax, cd_morfo, date_ident, cds_identified_by, qt_int,remarks, occurrence_id, organism_id)
SELECT 
 cd_event,
 cds_recorded_by,
 (e.date_time_begin::date||' '||event_time)::timestamp date_time,
 tt.cd_tax,
 tt.cd_morfo,
 TO_DATE(date_identified,'YYYY-MM-DD') date_ident,
 cds_identified_by,
 organism_quantity::double precision::int qt_int,
 r.event_remarks,
 occurrence_id,
 SPLIT_PART(occurrence_id,':',7) organism_id
 --ROW_NUMBER() OVER (ORDER BY (e.date_time_begin::date||' '||event_time)::timestamp)
 --organism_id::text
FROM raw_dwc.mariposas_registros r
LEFT JOIN raw_dwc.taxonomy_total tt ON tt."row.names"=r."row.names" AND tt.table_orig='mariposas_registros'
LEFT JOIN main.event e USING (cd_event)
ORDER BY date_time
RETURNING cd_event, cds_recorded_by, date_time, cd_tax, cd_morfo, cds_identified_by, qt_int,remarks, occurrence_id, organism_id
```

```{sql}
ALTER TABLE raw_dwc.mariposas_registros ADD COLUMN cd_reg int REFERENCES main.registros(cd_reg);
UPDATE raw_dwc.mariposas_registros AS ar
SET cd_reg=r.cd_reg
FROM main.registros r
WHERE ar.cd_event=r.cd_event AND ar.occurrence_id=r.occurrence_id;

-- Check cd_reg are unique in the source table
SELECT cd_reg,count(*) FROM  raw_dwc.mariposas_registros GROUP BY cd_reg HAVING count(*)>1;
```

# Hormigas

Para entender el plan de muestreo:



```{sql}
WITH a AS(
SELECT event_id,
 REGEXP_REPLACE(event_id,'^ANH_([0-9]{1,3})_((Captura manual)|(Pitfall)|(Trampa de caída atún)|(Winkler))([0-9]{1,2})_(202[12])-[0-9][0-9]-[0-9][0-9](/202[12]-[0-9][0-9]-[0-9][0-9])?','\1')::int anh_num,
 REGEXP_REPLACE(event_id,'^ANH_([0-9]{1,3})_((Captura manual)|(Pitfall)|(Trampa de caída atún)|(Winkler))([0-9]{1,2})_(202[12])-[0-9][0-9]-[0-9][0-9](/202[12]-[0-9][0-9]-[0-9][0-9])?','\2') metodo,
 REGEXP_REPLACE(event_id,'^ANH_([0-9]{1,3})_((Captura manual)|(Pitfall)|(Trampa de caída atún)|(Winkler))([0-9]{1,2})_(202[12])-[0-9][0-9]-[0-9][0-9](/202[12]-[0-9][0-9]-[0-9][0-9])?','\7')::int repli,
 REGEXP_REPLACE(event_id,'^ANH_([0-9]{1,3})_((Captura manual)|(Pitfall)|(Trampa de caída atún)|(Winkler))([0-9]{1,2})_(202[12])-[0-9][0-9]-[0-9][0-9](/202[12]-[0-9][0-9]-[0-9][0-9])?','\8') año
FROM raw_dwc.hormigas_event
)
SELECT anh_num, año, metodo, ARRAY_AGG(repli ORDER BY repli) repli, count(*)
FROM a
GROUP BY anh_num, año, metodo
ORDER BY anh_num, año, metodo
;
```


## ANH


Insertar los datos de anh:

```{sql}
INSERT INTO main.punto_referencia(name_pt_ref, num_anh)
WITH a AS(
SELECT
 REGEXP_REPLACE(event_id,'^ANH_([0-9]{1,3})_((Captura manual)|(Pitfall)|(Trampa de caída atún)|(Winkler))([0-9]{1,2})_(202[12])-[0-9][0-9]-[0-9][0-9](/202[12]-[0-9][0-9]-[0-9][0-9])?','\1')::int anh_num,
 REGEXP_REPLACE(event_id,'^(ANH_[0-9]{1,3})_((Captura manual)|(Pitfall)|(Trampa de caída atún)|(Winkler))([0-9]{1,2})_(202[12])-[0-9][0-9]-[0-9][0-9](/202[12]-[0-9][0-9]-[0-9][0-9])?','\1') anh_name
FROM raw_dwc.hormigas_event
)
SELECT anh_name, anh_num
FROM a
GROUP BY anh_name,anh_num
ORDER BY anh_num
ON CONFLICT (name_pt_ref) DO NOTHING
RETURNING cd_pt_ref, name_pt_ref
;
```

dar las referencias en las tablas de hormigas

```{sql}
ALTER TABLE raw_dwc.hormigas_event ADD COLUMN cd_pt_ref int REFERENCES main.punto_referencia(cd_pt_ref) ON DELETE SET NULL ON UPDATE CASCADE;
ALTER TABLE raw_dwc.hormigas_registros ADD COLUMN cd_pt_ref int REFERENCES main.punto_referencia(cd_pt_ref) ON DELETE SET NULL ON UPDATE CASCADE;

UPDATE raw_dwc.hormigas_event
SET cd_pt_ref=pr.cd_pt_ref
FROM main.punto_referencia pr
WHERE REGEXP_REPLACE(event_id,'^(ANH_[0-9]{1,3})_((Captura manual)|(Pitfall)|(Trampa de caída atún)|(Winkler))([0-9]{1,2})_(202[12])-[0-9][0-9]-[0-9][0-9](/202[12]-[0-9][0-9]-[0-9][0-9])?','\1') = name_pt_ref
;

UPDATE raw_dwc.hormigas_registros
SET cd_pt_ref=pr.cd_pt_ref
FROM main.punto_referencia pr
WHERE  REGEXP_REPLACE(event_id,'^(ANH_[0-9]{1,3})_((Captura manual)|(Pitfall)|(Trampa de caída atún)|(Winkler))([0-9]{1,2})_(202[12])-[0-9][0-9]-[0-9][0-9](/202[12]-[0-9][0-9]-[0-9][0-9])?','\1') = name_pt_ref
;

SELECT true;
```

Averiguando que ninguna fila no tenga anh

```{sql}
SELECT * FROM raw_dwc.hormigas_event WHERE cd_pt_ref IS NULL;
```

```{sql}
SELECT * FROM raw_dwc.hormigas_registros WHERE cd_pt_ref IS NULL;
```

## Unit, sampling efforts definition, abundance definition, protocolo

No hay nuevas unidades, ni variables que añadir (vamos a utilizar minutos para el tiempo de sampling effort), y 'Duración' para la variable de sampling effort


```{sql}
INSERT INTO main.def_unit(cd_measurement_type, unit, unit_spa, abbv_unit,factor)
VALUES(
  (SELECT cd_measurement_type FROM main.def_measurement_type WHERE measurement_type='area'),
  'Square meter',
  'Metros cuadrados',
  'm2',
  1
  ),
  (
  (SELECT cd_measurement_type FROM main.def_measurement_type WHERE measurement_type='presence/absence'),
  'Lot',
  'Lote',
  'lote',
  1
  )
  
RETURNING cd_unit,unit;
```

```{sql}
INSERT INTO main.def_var_samp_eff(var_samp_eff, var_samp_eff_spa, cd_unit,type_variable)
VALUES(
  'Sampling area',
  'Superficie de muestreo',
  (SELECT cd_unit FROM main.def_unit WHERE cd_measurement_type=(SELECT cd_measurement_type FROM main.def_measurement_type WHERE measurement_type='area') AND unit='Square meter'),
  'double precision'
  )
RETURNING cd_var_samp_eff, var_samp_eff ;
```

```{sql}
INSERT INTO main.def_var_ind_qt(var_qt_ind, var_qt_ind_spa, cd_unit, type_variable)
VALUES(
  'Lot',
  'Lote',
  (SELECT cd_unit FROM main.def_unit WHERE cd_measurement_type=(SELECT cd_measurement_type FROM main.def_measurement_type WHERE measurement_type='presence/absence') AND unit='Lot'),
  'int'
)
RETURNING cd_var_ind_qt,var_qt_ind
;
```

```{sql}
INSERT INTO main.def_protocol(protocol,protocol_spa,cd_var_samp_eff_1,cd_var_samp_eff_2,samp_eff_1_implicit,samp_eff_2_implicit,cd_var_ind_qt,description_spa)
VALUES(
  'Ant hand collection',
  'Captura manual de hormigas',
  (SELECT cd_var_samp_eff FROM main.def_var_samp_eff WHERE var_samp_eff='Sampling area'),
  (SELECT cd_var_samp_eff FROM main.def_var_samp_eff WHERE var_samp_eff='Elapsed time'),
  false,
  false,
  (SELECT cd_var_ind_qt FROM main.def_var_ind_qt WHERE var_qt_ind='Lot'),
  'Captura manual de hormigas: nota, cuando la cantidad de lote es superior a 1, quiere decir que los individuos se contarón'
),(
  'Ant pitfall',
  'Pitfall para hormigas',
  (SELECT cd_var_samp_eff FROM main.def_var_samp_eff WHERE var_samp_eff='Elapsed time'),
  NULL,
  true,
  NULL,
  (SELECT cd_var_ind_qt FROM main.def_var_ind_qt WHERE var_qt_ind='Lot'),
  'Pitfall: nota, cuando la cantidad de lote es superior a 1, quiere decir que los individuos se contarón'
),(
  'Ant winkler',
  'Winkler para hormigas',
  (SELECT cd_var_samp_eff FROM main.def_var_samp_eff WHERE var_samp_eff='Elapsed time'),
  NULL,
  true,
  NULL,
  (SELECT cd_var_ind_qt FROM main.def_var_ind_qt WHERE var_qt_ind='Lot'),
  'Winkler: nota, cuando la cantidad de lote es superior a 1, quiere decir que los individuos se contarón'
),(
  'Ant tuna fall trap',
  'Trampa de caída atún',
  (SELECT cd_var_samp_eff FROM main.def_var_samp_eff WHERE var_samp_eff='Elapsed time'),
  NULL,
  true,
  NULL,
  (SELECT cd_var_ind_qt FROM main.def_var_ind_qt WHERE var_qt_ind='Lot'),
  'Pitfall: nota, cuando la cantidad de lote es superior a 1, quiere decir que los individuos se contarón'
  )
RETURNING cd_protocol,protocol,protocol_spa;
```

## Personas

```{sql}
INSERT INTO main.people(verbatim_person)
WITH a AS(
SELECT DISTINCT INITCAP(TRIM(UNNEST(STRING_TO_ARRAY(recorded_by, ' | ')))) AS name_person
FROM raw_dwc.hormigas_registros
UNION
SELECT DISTINCT INITCAP(TRIM(UNNEST(STRING_TO_ARRAY(identified_by, ' | '))))
FROM raw_dwc.hormigas_registros
)
SELECT DISTINCT REGEXP_REPLACE(name_person, '- ','-')
FROM a 
ORDER BY REGEXP_REPLACE(name_person, '- ','-')
ON CONFLICT(verbatim_person) DO NOTHING
RETURNING cd_person, verbatim_person
```

Dar los codigos a las tables de origen:

```{sql}
ALTER TABLE raw_dwc.hormigas_registros ADD COLUMN cds_recorded_by int[];

WITH a AS(
SELECT "row.names", REGEXP_REPLACE(INITCAP(TRIM(UNNEST(STRING_TO_ARRAY(recorded_by, ' | ')))),'- ','-') AS name_person
FROM raw_dwc.hormigas_registros
),b AS(
SELECT "row.names", ARRAY_AGG(cd_person) cds
FROM a 
LEFT JOIN main.people p ON a.name_person=p.verbatim_person
GROUP BY "row.names"
)
UPDATE raw_dwc.hormigas_registros AS r
SET cds_recorded_by=b.cds
FROM b
WHERE r."row.names"=b."row.names"
RETURNING r."row.names", cds_recorded_by
;

ALTER TABLE raw_dwc.hormigas_registros ADD COLUMN cds_identified_by int[];

WITH a AS(
SELECT "row.names", REGEXP_REPLACE(INITCAP(TRIM(UNNEST(STRING_TO_ARRAY(identified_by, ' | ')))),'- ','-') AS name_person
FROM raw_dwc.hormigas_registros
),b AS(
SELECT "row.names", ARRAY_AGG(cd_person) cds
FROM a 
LEFT JOIN main.people p ON a.name_person=p.verbatim_person
GROUP BY "row.names"
)
UPDATE raw_dwc.hormigas_registros AS r
SET cds_identified_by=b.cds
FROM b
WHERE r."row.names"=b."row.names"
RETURNING r."row.names", cds_identified_by
;

SELECT 1;
```

## gp_event

```{sql}
WITH a AS(
SELECT 
  event_id,
 REGEXP_REPLACE(event_id,'^ANH_([0-9]{1,3})_((Captura manual)|(Pitfall)|(Trampa de caída atún)|(Winkler))([0-9]{1,2})_(202[12])-[0-9][0-9]-[0-9][0-9](/202[12]-[0-9][0-9]-[0-9][0-9])?','\1')::int anh_num,
 REGEXP_REPLACE(event_id,'^ANH_([0-9]{1,3})_((Captura manual)|(Pitfall)|(Trampa de caída atún)|(Winkler))([0-9]{1,2})_(202[12])-[0-9][0-9]-[0-9][0-9](/202[12]-[0-9][0-9]-[0-9][0-9])?','\2') metodo,
 REGEXP_REPLACE(event_id,'^ANH_([0-9]{1,3})_((Captura manual)|(Pitfall)|(Trampa de caída atún)|(Winkler))([0-9]{1,2})_(202[12])-[0-9][0-9]-[0-9][0-9](/202[12]-[0-9][0-9]-[0-9][0-9])?','\7')::int repli,
 REGEXP_REPLACE(event_id,'^ANH_([0-9]{1,3})_((Captura manual)|(Pitfall)|(Trampa de caída atún)|(Winkler))([0-9]{1,2})_(202[12])-[0-9][0-9]-[0-9][0-9](/202[12]-[0-9][0-9]-[0-9][0-9])?','\8') año
FROM raw_dwc.hormigas_event
)
SELECT año, anh_num,metodo, ARRAY_AGG(repli), count(*)
FROM a
GROUP BY año, anh_num, metodo
ORDER BY año, anh_num, metodo
;
```

Because there is more than a method, the number of the campaign should be determined this way:

```{sql}
WITH a AS(
SELECT 
  event_id,
 REGEXP_REPLACE(event_id,'^ANH_([0-9]{1,3})_((Captura manual)|(Pitfall)|(Trampa de caída atún)|(Winkler))([0-9]{1,2})_(202[12])-[0-9][0-9]-[0-9][0-9](/202[12]-[0-9][0-9]-[0-9][0-9])?','\1')::int anh_num,
 REGEXP_REPLACE(event_id,'^ANH_([0-9]{1,3})_((Captura manual)|(Pitfall)|(Trampa de caída atún)|(Winkler))([0-9]{1,2})_(202[12])-[0-9][0-9]-[0-9][0-9](/202[12]-[0-9][0-9]-[0-9][0-9])?','\2') metodo,
 REGEXP_REPLACE(event_id,'^ANH_([0-9]{1,3})_((Captura manual)|(Pitfall)|(Trampa de caída atún)|(Winkler))([0-9]{1,2})_(202[12])-[0-9][0-9]-[0-9][0-9](/202[12]-[0-9][0-9]-[0-9][0-9])?','\7')::int repli,
 REGEXP_REPLACE(event_id,'^ANH_([0-9]{1,3})_((Captura manual)|(Pitfall)|(Trampa de caída atún)|(Winkler))([0-9]{1,2})_(202[12])-[0-9][0-9]-[0-9][0-9](/202[12]-[0-9][0-9]-[0-9][0-9])?','\8') año
FROM raw_dwc.hormigas_event
)
SELECT año, anh_num, ROW_NUMBER() OVER (PARTITION BY anh_num ORDER BY año) campaign_nb
FROM a
GROUP BY año, anh_num
ORDER BY año, anh_num
;
```


```{sql}
INSERT INTO main.gp_event(cd_gp_biol,cd_protocol,cd_pt_ref,campaign_nb)
WITH a AS(
SELECT 
  event_id,
 REGEXP_REPLACE(event_id,'^ANH_([0-9]{1,3})_((Captura manual)|(Pitfall)|(Trampa de caída atún)|(Winkler))([0-9]{1,2})_(202[12])-[0-9][0-9]-[0-9][0-9](/202[12]-[0-9][0-9]-[0-9][0-9])?','\1')::int anh_num,
 REGEXP_REPLACE(event_id,'^ANH_([0-9]{1,3})_((Captura manual)|(Pitfall)|(Trampa de caída atún)|(Winkler))([0-9]{1,2})_(202[12])-[0-9][0-9]-[0-9][0-9](/202[12]-[0-9][0-9]-[0-9][0-9])?','\2') metodo,
 REGEXP_REPLACE(event_id,'^ANH_([0-9]{1,3})_((Captura manual)|(Pitfall)|(Trampa de caída atún)|(Winkler))([0-9]{1,2})_(202[12])-[0-9][0-9]-[0-9][0-9](/202[12]-[0-9][0-9]-[0-9][0-9])?','\7')::int repli,
 REGEXP_REPLACE(event_id,'^ANH_([0-9]{1,3})_((Captura manual)|(Pitfall)|(Trampa de caída atún)|(Winkler))([0-9]{1,2})_(202[12])-[0-9][0-9]-[0-9][0-9](/202[12]-[0-9][0-9]-[0-9][0-9])?','\8') año,
  cd_pt_ref
FROM raw_dwc.hormigas_event
), campaign AS(
SELECT año, anh_num, ROW_NUMBER() OVER (PARTITION BY anh_num ORDER BY año) campaign_nb
FROM a
GROUP BY año, anh_num
ORDER BY año, anh_num
)
SELECT 'horm',
  CASE
    WHEN metodo='Captura manual' THEN (SELECT cd_protocol FROM main.def_protocol WHERE protocol='Ant hand collection')
    WHEN metodo='Pitfall' THEN (SELECT cd_protocol FROM main.def_protocol WHERE protocol='Ant pitfall')
    WHEN metodo='Trampa de caída atún' THEN (SELECT cd_protocol FROM main.def_protocol WHERE protocol='Ant tuna fall trap')
    WHEN metodo='Winkler' THEN (SELECT cd_protocol FROM main.def_protocol WHERE protocol='Ant winkler')
  END cd_protocol,
  cd_pt_ref,
  c.campaign_nb
FROM a
LEFT JOIN campaign c USING (año, anh_num)
LEFT JOIN main.punto_referencia USING (cd_pt_ref)
GROUP BY cd_pt_ref, name_pt_ref, año, metodo, c.campaign_nb
ORDER BY año,cd_pt_ref,cd_protocol
RETURNING cd_gp_event,cd_gp_biol,cd_protocol,cd_pt_ref,campaign_nb
;
```

Attributing the gp_event

```{sql}
ALTER TABLE raw_dwc.hormigas_event ADD COLUMN cd_gp_event int REFERENCES main.gp_event(cd_gp_event) ON DELETE SET NULL;


WITH a AS(
SELECT 
  event_id,
 REGEXP_REPLACE(event_id,'^ANH_([0-9]{1,3})_((Captura manual)|(Pitfall)|(Trampa de caída atún)|(Winkler))([0-9]{1,2})_(202[12])-[0-9][0-9]-[0-9][0-9](/202[12]-[0-9][0-9]-[0-9][0-9])?','\1')::int anh_num,
 REGEXP_REPLACE(event_id,'^ANH_([0-9]{1,3})_((Captura manual)|(Pitfall)|(Trampa de caída atún)|(Winkler))([0-9]{1,2})_(202[12])-[0-9][0-9]-[0-9][0-9](/202[12]-[0-9][0-9]-[0-9][0-9])?','\2') metodo,
 REGEXP_REPLACE(event_id,'^ANH_([0-9]{1,3})_((Captura manual)|(Pitfall)|(Trampa de caída atún)|(Winkler))([0-9]{1,2})_(202[12])-[0-9][0-9]-[0-9][0-9](/202[12]-[0-9][0-9]-[0-9][0-9])?','\7')::int repli,
 REGEXP_REPLACE(event_id,'^ANH_([0-9]{1,3})_((Captura manual)|(Pitfall)|(Trampa de caída atún)|(Winkler))([0-9]{1,2})_(202[12])-[0-9][0-9]-[0-9][0-9](/202[12]-[0-9][0-9]-[0-9][0-9])?','\8') año,
  cd_pt_ref
FROM raw_dwc.hormigas_event
), campaign AS(
SELECT año, anh_num, ROW_NUMBER() OVER (PARTITION BY anh_num ORDER BY año) campaign_nb
FROM a
GROUP BY año, anh_num
ORDER BY año, anh_num
), b AS(
SELECT
  CASE
    WHEN metodo='Captura manual' THEN (SELECT cd_protocol FROM main.def_protocol WHERE protocol='Ant hand collection')
    WHEN metodo='Pitfall' THEN (SELECT cd_protocol FROM main.def_protocol WHERE protocol='Ant pitfall')
    WHEN metodo='Trampa de caída atún' THEN (SELECT cd_protocol FROM main.def_protocol WHERE protocol='Ant tuna fall trap')
    WHEN metodo='Winkler' THEN (SELECT cd_protocol FROM main.def_protocol WHERE protocol='Ant winkler')
  END cd_protocol,
  cd_pt_ref,
  c.campaign_nb,
  event_id
FROM a
LEFT JOIN campaign c USING (año, anh_num)
LEFT JOIN main.punto_referencia USING (cd_pt_ref)
),d AS(
SELECT b.*, cd_gp_event
FROM b
LEFT JOIN main.gp_event ge ON cd_gp_biol='horm' AND b.cd_protocol=ge.cd_protocol AND b.cd_pt_ref=ge.cd_pt_ref AND b.campaign_nb=ge.campaign_nb
)
UPDATE raw_dwc.hormigas_event e
SET cd_gp_event=d.cd_gp_event
FROM d
WHERE d.event_id=e.event_id
RETURNING e.event_id, e.cd_gp_event
;
```

## event

TODO: ARREGLAR PROBLEMA DE HORA FALTANTE PARA ALGUNOS WINKLERS
Note: maybe it would not be idiot to leave it empty... and to give the date as an extra variable, as text... and for mariposas as well...


\footnotesize

```{sql}
INSERT INTO main.event(cd_gp_event,event_id,num_replicate, description_replicate, date_time_begin, date_time_end, locality_verb, event_remarks, samp_effort_1, samp_effort_2, pt_geom)
WITH a AS(
SELECT cd_gp_event,
  event_id, 
 REGEXP_REPLACE(event_id,'^ANH_([0-9]{1,3})_((Captura manual)|(Pitfall)|(Trampa de caída atún)|(Winkler))([0-9]{1,2})_(202[12])-[0-9][0-9]-[0-9][0-9](/202[12]-[0-9][0-9]-[0-9][0-9])?','\7')::int num_replicate,
 REGEXP_REPLACE(event_id,'^ANH_([0-9]{1,3})_((Captura manual)|(Pitfall)|(Trampa de caída atún)|(Winkler)[0-9]{1,2}_202[12]-[0-9][0-9]-[0-9][0-9](/202[12]-[0-9][0-9]-[0-9][0-9])?)','\2') description_replicate,
  TO_DATE(SPLIT_PART(event_date,'/',1), 'YYYY-MM-DD') date_1,
  CASE 
    WHEN SPLIT_PART(event_date,'/',2)='' THEN NULL
    ELSE TO_DATE(SPLIT_PART(event_date,'/',2), 'YYYY-MM-DD')
  END date_2,
  REGEXP_REPLACE(SPLIT_PART(event_time,'/',1),'\s+','','g') hora_1,
  CASE
  	WHEN REGEXP_REPLACE(SPLIT_PART(event_time,'/',2),'\s+','','g')='' THEN NULL
	ELSE REGEXP_REPLACE(SPLIT_PART(event_time,'/',2),'\s+','','g')
  END hora_2,
  locality locality_verb,
  sample_size_value,
  event_remarks,
  decimal_latitude::double precision,
  decimal_longitude::double precision
FROM raw_dwc.hormigas_event
)
SELECT 
  cd_gp_event,
  event_id, 
  num_replicate,
  description_replicate,
  CASE
    WHEN date_1 IS NULL OR hora_1 IS NULL THEN NULL
    ELSE (date_1||' '||hora_1)::timestamp 
  END date_time_begin,
  CASE
    WHEN date_2 IS NULL OR hora_2 IS NULL THEN NULL
    ELSE (date_2||' '||hora_2)::timestamp
  END date_time_end,
  locality_verb,
  REGEXP_REPLACE(REGEXP_REPLACE(event_remarks ,'\| La hora inicial corresponde al día que se instaló la trampa y la hora final al día que se retiró',''),'\| Sin registro de individuos','') event_remarks,
  CASE
   WHEN protocol='Ant hand collection' THEN sample_size_value
   ELSE NULL
  END samp_eff_1,
  CASE
   WHEN protocol='Ant hand collection' THEN 12
   ELSE NULL
  END,
  ST_SetSRID(ST_Transform(ST_SetSRID(ST_MakePoint(decimal_longitude,decimal_latitude),4326), (SELECT proj4text FROM spatial_ref_sys WHERE srid=3116)),3116)
FROM a
LEFT JOIN main.gp_event USING (cd_gp_event)
LEFT JOIN main.def_protocol p USING (cd_protocol)
ORDER BY cd_gp_event, event_id, num_replicate


RETURNING main.event.cd_event, main.event.cd_gp_event, main.event.event_id, main.event.num_replicate, main.event.description_replicate, main.event.date_time_begin, main.event.date_time_end, main.event.locality_verb, main.event.event_remarks, main.event.pt_geom
```

Damos los cd_event a todos las filas:

```{sql}
ALTER TABLE raw_dwc.hormigas_event ADD COLUMN cd_event int REFERENCES main.event(cd_event) ON DELETE SET NULL;
ALTER TABLE raw_dwc.hormigas_registros ADD COLUMN cd_event int REFERENCES main.event(cd_event);

UPDATE raw_dwc.hormigas_event AS t
SET cd_event=e.cd_event
FROM main.event e
WHERE t.event_id=e.event_id;

UPDATE raw_dwc.hormigas_registros AS t
SET cd_event=e.cd_event
FROM main.event e
WHERE t.event_id=e.event_id;

SELECT true;
```

Añadir fechas en la tabla extra cuando las horas no son disponibles

```{sql}
INSERT INTO main.event_extra(cd_event, cd_var_event_extra,value_text)
WITH a AS(
SELECT cd_event,ef.date_time_begin,
  TO_DATE(SPLIT_PART(event_date,'/',1), 'YYYY-MM-DD') date_1
FROM raw_dwc.hormigas_event e
LEFT JOIN main.event ef USING (cd_event)
WHERE date_time_begin IS NULL
),b AS(
SELECT cd_event,
  CASE
   WHEN date_time_begin IS NULL THEN date_1
   ELSE NULL
  END date_begin
FROM a
)
SELECT 
 cd_event,
 (SELECT cd_var_event_extra FROM main.def_var_event_extra WHERE var_event_extra='date_begin'),
 to_char(date_begin,'yyyy-mm-dd')::text
FROM b
WHERE date_begin IS NOT NULL
RETURNING main.event_extra.cd_event, main.event_extra.cd_var_event_extra, main.event_extra.value_text
;

INSERT INTO main.event_extra(cd_event, cd_var_event_extra,value_text)
WITH a AS(
SELECT cd_event,ef.date_time_end,
  e.event_id,
  REGEXP_REPLACE(e.event_id,'^ANH_([0-9]{1,3})_((Captura manual)|(Pitfall)|(Trampa de caída atún)|(Winkler))([0-9]{1,2})_(202[12])-[0-9][0-9]-[0-9][0-9](/202[12]-[0-9][0-9]-[0-9][0-9])?','\2') metodo,
  TO_DATE(REGEXP_REPLACE(e.event_id,'^ANH_[0-9]{1,3}_((Captura manual)|(Pitfall)|(Trampa de caída atún)|(Winkler))([0-9]{1,2})_(202[12])-[0-9][0-9]-[0-9][0-9](/(202[12]-[0-9][0-9]-[0-9][0-9]))?','\9'),'YYYY-MM-DD') date_2_from_eid,
  TO_DATE(SPLIT_PART(event_date,'/',1), 'YYYY-MM-DD') date_1,
  CASE 
    WHEN SPLIT_PART(event_date,'/',2)='' THEN NULL
    ELSE TO_DATE(SPLIT_PART(event_date,'/',2), 'YYYY-MM-DD')
  END date_2
FROM raw_dwc.hormigas_event e
LEFT JOIN main.event ef USING (cd_event)
WHERE date_time_end IS NULL
),b AS(
SELECT cd_event,
  CASE
   WHEN metodo='Captura manual' THEN date_1
   ELSE COALESCE(date_2,date_2_from_eid)
  END date_end
FROM a
)
SELECT 
 cd_event,
 (SELECT cd_var_event_extra FROM main.def_var_event_extra WHERE var_event_extra='date_end'),
 to_char(date_end,'yyyy-mm-dd')::text
FROM b
WHERE date_end IS NOT NULL
RETURNING main.event_extra.cd_event, main.event_extra.cd_var_event_extra, main.event_extra.value_text
;

```

## registros

```{sql}
SELECT occurrence_id, count(*)
FROM raw_dwc.hormigas_registros 
GROUP BY occurrence_id
HAVING count(*)>1;
```

```{sql}

INSERT INTO main.registros(cd_event, cds_recorded_by, date_time, cd_tax, cd_morfo, date_ident, cds_identified_by, qt_int,remarks, occurrence_id, organism_id)
SELECT 
 cd_event,
 cds_recorded_by,
 (e.date_time_begin::date||' '||event_time)::timestamp date_time,
 tt.cd_tax,
 tt.cd_morfo,
 TO_DATE(date_identified,'YYYY-MM-DD') date_ident,
 cds_identified_by,
 organism_quantity::double precision::int qt_int,
 r.event_remarks,
 occurrence_id,
 SPLIT_PART(occurrence_id,':',7) organism_id
 --ROW_NUMBER() OVER (ORDER BY (e.date_time_begin::date||' '||event_time)::timestamp)
 --organism_id::text
FROM raw_dwc.hormigas_registros r
LEFT JOIN raw_dwc.taxonomy_total tt ON tt."row.names"=r."row.names" AND tt.table_orig='hormigas_registros'
LEFT JOIN main.event e USING (cd_event)
ORDER BY date_time
RETURNING cd_event, cds_recorded_by, date_time, cd_tax, cd_morfo, cds_identified_by, qt_int,remarks, occurrence_id, organism_id
```

```{sql}
ALTER TABLE raw_dwc.hormigas_registros ADD COLUMN cd_reg int REFERENCES main.registros(cd_reg);
UPDATE raw_dwc.hormigas_registros AS ar
SET cd_reg=r.cd_reg
FROM main.registros r
WHERE ar.cd_event=r.cd_event AND ar.occurrence_id=r.occurrence_id;

-- Check cd_reg are unique in the source table
SELECT cd_reg,count(*) FROM  raw_dwc.hormigas_registros GROUP BY cd_reg HAVING count(*)>1;
```

TODO: poner los occurrenceRemarks en individual characteristics para poder filtrar los alados

# Escarabajos

Para entender el plan de muestreo:



```{sql}
WITH a AS(
SELECT event_id,
  REGEXP_REPLACE(event_id,'^ANH_([0-9]{1,3}).*$','\1')::int anh_num,
  CASE
     WHEN event_id ~ '^ANH_[0-9]{1,3}_Captura manual[0-9]_202[12]-[0-9]{2}-[0-9]{2}$' THEN 'Captura manual'
     WHEN event_id ~ '^ANH_[0-9]{1,3}_T. Exc. Human[0-9]_202[12]-[0-9]{2}-[0-9]{2}/202[12]-[0-9]{2}-[0-9]{2}$' THEN 'Tramp Exc'
  END metodo,
  CASE
     WHEN event_id ~ '^ANH_[0-9]{1,3}_Captura manual[0-9]_202[12]-[0-9]{2}-[0-9]{2}$' THEN REGEXP_REPLACE(event_id,'^ANH_[0-9]{1,3}_Captura manual([0-9])_202[12]-[0-9]{2}-[0-9]{2}$','\1')::int
     WHEN event_id ~ '^ANH_[0-9]{1,3}_T. Exc. Human[0-9]_202[12]-[0-9]{2}-[0-9]{2}/202[12]-[0-9]{2}-[0-9]{2}$' THEN REGEXP_REPLACE(event_id,'^ANH_[0-9]{1,3}_T. Exc. Human([0-9])_202[12]-[0-9]{2}-[0-9]{2}/202[12]-[0-9]{2}-[0-9]{2}$','\1')::int
  END trap_num,
  CASE
     WHEN event_id ~ '^ANH_[0-9]{1,3}_Captura manual[0-9]_202[12]-[0-9]{2}-[0-9]{2}$' THEN REGEXP_REPLACE(event_id,'^ANH_[0-9]{1,3}_Captura manual[0-9]_(202[12])-[0-9]{2}-[0-9]{2}$','\1')
     WHEN event_id ~ '^ANH_[0-9]{1,3}_T. Exc. Human[0-9]_202[12]-[0-9]{2}-[0-9]{2}/202[12]-[0-9]{2}-[0-9]{2}$' THEN REGEXP_REPLACE(event_id,'^ANH_[0-9]{1,3}_T. Exc. Human[0-9]_(202[12])-[0-9]{2}-[0-9]{2}/202[12]-[0-9]{2}-[0-9]{2}$','\1')
  END "year"
FROM raw_dwc.escarabajos_event
)
SELECT anh_num,"year",metodo,ARRAY_AGG(trap_num ORDER BY trap_num) traps
FROM a
GROUP BY anh_num,"year",metodo
ORDER BY anh_num,"year",metodo
;
```

## ANH


Insertar los datos de anh:

```{sql}
INSERT INTO main.punto_referencia(name_pt_ref, num_anh)
WITH a AS(
SELECT
  REGEXP_REPLACE(event_id,'^ANH_([0-9]{1,3}).*$','\1')::int anh_num,
  REGEXP_REPLACE(event_id,'^(ANH_[0-9]{1,3}).*$','\1') anh_name
FROM raw_dwc.escarabajos_event
)
SELECT anh_name, anh_num
FROM a
GROUP BY anh_name,anh_num
ORDER BY anh_num
ON CONFLICT (name_pt_ref) DO NOTHING
RETURNING cd_pt_ref, name_pt_ref
;
```

dar las referencias en las tablas de escarabajos

```{sql}
ALTER TABLE raw_dwc.escarabajos_event ADD COLUMN cd_pt_ref int REFERENCES main.punto_referencia(cd_pt_ref) ON DELETE SET NULL ON UPDATE CASCADE;
ALTER TABLE raw_dwc.escarabajos_registros ADD COLUMN cd_pt_ref int REFERENCES main.punto_referencia(cd_pt_ref) ON DELETE SET NULL ON UPDATE CASCADE;

UPDATE raw_dwc.escarabajos_event
SET cd_pt_ref=pr.cd_pt_ref
FROM main.punto_referencia pr
WHERE REGEXP_REPLACE(event_id,'^(ANH_[0-9]{1,3}).*$','\1') = name_pt_ref
;

UPDATE raw_dwc.escarabajos_registros
SET cd_pt_ref=pr.cd_pt_ref
FROM main.punto_referencia pr
WHERE  REGEXP_REPLACE(event_id,'^(ANH_[0-9]{1,3}).*$','\1') = name_pt_ref
;

SELECT true;
```

Averiguando que ninguna fila no tenga anh

```{sql}
SELECT * FROM raw_dwc.escarabajos_event WHERE cd_pt_ref IS NULL;
```

```{sql}
SELECT * FROM raw_dwc.escarabajos_registros WHERE cd_pt_ref IS NULL;
```

## Unit, sampling efforts definition, abundance definition, protocolo

No hay nuevas unidades, ni variables que añadir (vamos a utilizar minutos para el tiempo de sampling effort), y 'Duración' para la variable de sampling effort


```{sql}
INSERT INTO main.def_protocol(protocol,protocol_spa,cd_var_samp_eff_1,cd_var_samp_eff_2,samp_eff_1_implicit,samp_eff_2_implicit,cd_var_ind_qt,description_spa)
VALUES(
  'Insect hand collection',
  'Captura manual de insectos',
  (SELECT cd_var_samp_eff FROM main.def_var_samp_eff WHERE var_samp_eff='Sampling area'),
  (SELECT cd_var_samp_eff FROM main.def_var_samp_eff WHERE var_samp_eff='Elapsed time'),
  false,
  false,
  (SELECT cd_var_ind_qt FROM main.def_var_ind_qt WHERE var_qt_ind='Number of individuals'),
  'Nota: eso no concierne la hormigas, que manejan solamente presence/absence'
),(
  'Human excrement trap',
  'Trampa de excrementos humanos',
  (SELECT cd_var_samp_eff FROM main.def_var_samp_eff WHERE var_samp_eff='Elapsed time'),
  NULL,
  false,
  NULL,
  (SELECT cd_var_ind_qt FROM main.def_var_ind_qt WHERE var_qt_ind='Number of individuals'),
  'Nota: eso no concierne la hormigas, que manejan solamente presence/absence'
)
RETURNING cd_protocol,protocol,protocol_spa;
```

## Personas

```{sql}
INSERT INTO main.people(verbatim_person)
WITH a AS(
SELECT DISTINCT INITCAP(TRIM(UNNEST(STRING_TO_ARRAY(recorded_by, ' | ')))) AS name_person
FROM raw_dwc.escarabajos_registros
UNION
SELECT DISTINCT INITCAP(TRIM(UNNEST(STRING_TO_ARRAY(identified_by, ' | '))))
FROM raw_dwc.escarabajos_registros
)
SELECT DISTINCT REGEXP_REPLACE(name_person, '- ','-')
FROM a 
ORDER BY REGEXP_REPLACE(name_person, '- ','-')
ON CONFLICT(verbatim_person) DO NOTHING
RETURNING cd_person, verbatim_person
```

Dar los codigos a las tables de origen:

```{sql}
ALTER TABLE raw_dwc.escarabajos_registros ADD COLUMN cds_recorded_by int[];

WITH a AS(
SELECT "row.names", REGEXP_REPLACE(INITCAP(TRIM(UNNEST(STRING_TO_ARRAY(recorded_by, ' | ')))),'- ','-') AS name_person
FROM raw_dwc.escarabajos_registros
),b AS(
SELECT "row.names", ARRAY_AGG(cd_person) cds
FROM a 
LEFT JOIN main.people p ON a.name_person=p.verbatim_person
GROUP BY "row.names"
)
UPDATE raw_dwc.escarabajos_registros AS r
SET cds_recorded_by=b.cds
FROM b
WHERE r."row.names"=b."row.names"
RETURNING r."row.names", cds_recorded_by
;

ALTER TABLE raw_dwc.escarabajos_registros ADD COLUMN cds_identified_by int[];

WITH a AS(
SELECT "row.names", REGEXP_REPLACE(INITCAP(TRIM(UNNEST(STRING_TO_ARRAY(identified_by, ' | ')))),'- ','-') AS name_person
FROM raw_dwc.escarabajos_registros
),b AS(
SELECT "row.names", ARRAY_AGG(cd_person) cds
FROM a 
LEFT JOIN main.people p ON a.name_person=p.verbatim_person
GROUP BY "row.names"
)
UPDATE raw_dwc.escarabajos_registros AS r
SET cds_identified_by=b.cds
FROM b
WHERE r."row.names"=b."row.names"
RETURNING r."row.names", cds_identified_by
;

SELECT 1;
```

## gp_event

```{sql}
WITH a AS(
SELECT 
  event_id,
  REGEXP_REPLACE(event_id,'^ANH_([0-9]{1,3}).*$','\1')::int anh_num,
  CASE
     WHEN event_id ~ '^ANH_[0-9]{1,3}_Captura manual[0-9]_202[12]-[0-9]{2}-[0-9]{2}$' THEN 'Captura manual'
     WHEN event_id ~ '^ANH_[0-9]{1,3}_T. Exc. Human[0-9]_202[12]-[0-9]{2}-[0-9]{2}/202[12]-[0-9]{2}-[0-9]{2}$' THEN 'Tramp Exc'
  END metodo,
  CASE
     WHEN event_id ~ '^ANH_[0-9]{1,3}_Captura manual[0-9]_202[12]-[0-9]{2}-[0-9]{2}$' THEN REGEXP_REPLACE(event_id,'^ANH_[0-9]{1,3}_Captura manual([0-9])_202[12]-[0-9]{2}-[0-9]{2}$','\1')::int
     WHEN event_id ~ '^ANH_[0-9]{1,3}_T. Exc. Human[0-9]_202[12]-[0-9]{2}-[0-9]{2}/202[12]-[0-9]{2}-[0-9]{2}$' THEN REGEXP_REPLACE(event_id,'^ANH_[0-9]{1,3}_T. Exc. Human([0-9])_202[12]-[0-9]{2}-[0-9]{2}/202[12]-[0-9]{2}-[0-9]{2}$','\1')::int
  END trap_num,
  CASE
     WHEN event_id ~ '^ANH_[0-9]{1,3}_Captura manual[0-9]_202[12]-[0-9]{2}-[0-9]{2}$' THEN REGEXP_REPLACE(event_id,'^ANH_[0-9]{1,3}_Captura manual[0-9]_(202[12])-[0-9]{2}-[0-9]{2}$','\1')
     WHEN event_id ~ '^ANH_[0-9]{1,3}_T. Exc. Human[0-9]_202[12]-[0-9]{2}-[0-9]{2}/202[12]-[0-9]{2}-[0-9]{2}$' THEN REGEXP_REPLACE(event_id,'^ANH_[0-9]{1,3}_T. Exc. Human[0-9]_(202[12])-[0-9]{2}-[0-9]{2}/202[12]-[0-9]{2}-[0-9]{2}$','\1')
  END año
FROM raw_dwc.escarabajos_event
)
SELECT año, anh_num,metodo, ARRAY_AGG(trap_num), count(*)
FROM a
GROUP BY año, anh_num, metodo
ORDER BY año, anh_num, metodo
;
```

Because there is more than a method, the number of the campaign should be determined this way:

```{sql}
WITH a AS(
SELECT 
  event_id,
  REGEXP_REPLACE(event_id,'^ANH_([0-9]{1,3}).*$','\1')::int anh_num,
  CASE
     WHEN event_id ~ '^ANH_[0-9]{1,3}_Captura manual[0-9]_202[12]-[0-9]{2}-[0-9]{2}$' THEN 'Captura manual'
     WHEN event_id ~ '^ANH_[0-9]{1,3}_T. Exc. Human[0-9]_202[12]-[0-9]{2}-[0-9]{2}/202[12]-[0-9]{2}-[0-9]{2}$' THEN 'Tramp Exc'
  END metodo,
  CASE
     WHEN event_id ~ '^ANH_[0-9]{1,3}_Captura manual[0-9]_202[12]-[0-9]{2}-[0-9]{2}$' THEN REGEXP_REPLACE(event_id,'^ANH_[0-9]{1,3}_Captura manual([0-9])_202[12]-[0-9]{2}-[0-9]{2}$','\1')::int
     WHEN event_id ~ '^ANH_[0-9]{1,3}_T. Exc. Human[0-9]_202[12]-[0-9]{2}-[0-9]{2}/202[12]-[0-9]{2}-[0-9]{2}$' THEN REGEXP_REPLACE(event_id,'^ANH_[0-9]{1,3}_T. Exc. Human([0-9])_202[12]-[0-9]{2}-[0-9]{2}/202[12]-[0-9]{2}-[0-9]{2}$','\1')::int
  END trap_num,
  CASE
     WHEN event_id ~ '^ANH_[0-9]{1,3}_Captura manual[0-9]_202[12]-[0-9]{2}-[0-9]{2}$' THEN REGEXP_REPLACE(event_id,'^ANH_[0-9]{1,3}_Captura manual[0-9]_(202[12])-[0-9]{2}-[0-9]{2}$','\1')
     WHEN event_id ~ '^ANH_[0-9]{1,3}_T. Exc. Human[0-9]_202[12]-[0-9]{2}-[0-9]{2}/202[12]-[0-9]{2}-[0-9]{2}$' THEN REGEXP_REPLACE(event_id,'^ANH_[0-9]{1,3}_T. Exc. Human[0-9]_(202[12])-[0-9]{2}-[0-9]{2}/202[12]-[0-9]{2}-[0-9]{2}$','\1')
  END año
FROM raw_dwc.escarabajos_event
)
SELECT año, anh_num, ROW_NUMBER() OVER (PARTITION BY anh_num ORDER BY año) campaign_nb
FROM a
GROUP BY año, anh_num
ORDER BY año, anh_num
;
```


```{sql}
INSERT INTO main.gp_event(cd_gp_biol,cd_protocol,cd_pt_ref,campaign_nb)
WITH a AS(
SELECT 
  event_id,
  REGEXP_REPLACE(event_id,'^ANH_([0-9]{1,3}).*$','\1')::int anh_num,
  CASE
     WHEN event_id ~ '^ANH_[0-9]{1,3}_Captura manual[0-9]_202[12]-[0-9]{2}-[0-9]{2}$' THEN 'Captura manual'
     WHEN event_id ~ '^ANH_[0-9]{1,3}_T. Exc. Human[0-9]_202[12]-[0-9]{2}-[0-9]{2}/202[12]-[0-9]{2}-[0-9]{2}$' THEN 'Tramp Exc'
  END metodo,
  CASE
     WHEN event_id ~ '^ANH_[0-9]{1,3}_Captura manual[0-9]_202[12]-[0-9]{2}-[0-9]{2}$' THEN REGEXP_REPLACE(event_id,'^ANH_[0-9]{1,3}_Captura manual([0-9])_202[12]-[0-9]{2}-[0-9]{2}$','\1')::int
     WHEN event_id ~ '^ANH_[0-9]{1,3}_T. Exc. Human[0-9]_202[12]-[0-9]{2}-[0-9]{2}/202[12]-[0-9]{2}-[0-9]{2}$' THEN REGEXP_REPLACE(event_id,'^ANH_[0-9]{1,3}_T. Exc. Human([0-9])_202[12]-[0-9]{2}-[0-9]{2}/202[12]-[0-9]{2}-[0-9]{2}$','\1')::int
  END trap_num,
  CASE
     WHEN event_id ~ '^ANH_[0-9]{1,3}_Captura manual[0-9]_202[12]-[0-9]{2}-[0-9]{2}$' THEN REGEXP_REPLACE(event_id,'^ANH_[0-9]{1,3}_Captura manual[0-9]_(202[12])-[0-9]{2}-[0-9]{2}$','\1')
     WHEN event_id ~ '^ANH_[0-9]{1,3}_T. Exc. Human[0-9]_202[12]-[0-9]{2}-[0-9]{2}/202[12]-[0-9]{2}-[0-9]{2}$' THEN REGEXP_REPLACE(event_id,'^ANH_[0-9]{1,3}_T. Exc. Human[0-9]_(202[12])-[0-9]{2}-[0-9]{2}/202[12]-[0-9]{2}-[0-9]{2}$','\1')
  END año,
  cd_pt_ref
FROM raw_dwc.escarabajos_event
), campaign AS(
SELECT año, anh_num, ROW_NUMBER() OVER (PARTITION BY anh_num ORDER BY año) campaign_nb
FROM a
GROUP BY año, anh_num
ORDER BY año, anh_num
)
SELECT 'esca',
  CASE
    WHEN metodo='Captura manual' THEN (SELECT cd_protocol FROM main.def_protocol WHERE protocol='Insect hand collection')
    WHEN metodo='Tramp Exc' THEN (SELECT cd_protocol FROM main.def_protocol WHERE protocol='Human excrement trap')
  END cd_protocol,
  cd_pt_ref,
  c.campaign_nb
FROM a
LEFT JOIN campaign c USING (año, anh_num)
LEFT JOIN main.punto_referencia USING (cd_pt_ref)
GROUP BY cd_pt_ref, name_pt_ref, año, metodo, c.campaign_nb
ORDER BY año,cd_pt_ref,cd_protocol
RETURNING cd_gp_event,cd_gp_biol,cd_protocol,cd_pt_ref,campaign_nb
;
```

Attributing the gp_event

```{sql}
ALTER TABLE raw_dwc.escarabajos_event ADD COLUMN cd_gp_event int REFERENCES main.gp_event(cd_gp_event) ON DELETE SET NULL;


WITH a AS(
SELECT 
  event_id,
  REGEXP_REPLACE(event_id,'^ANH_([0-9]{1,3}).*$','\1')::int anh_num,
  CASE
     WHEN event_id ~ '^ANH_[0-9]{1,3}_Captura manual[0-9]_202[12]-[0-9]{2}-[0-9]{2}$' THEN 'Captura manual'
     WHEN event_id ~ '^ANH_[0-9]{1,3}_T. Exc. Human[0-9]_202[12]-[0-9]{2}-[0-9]{2}/202[12]-[0-9]{2}-[0-9]{2}$' THEN 'Tramp Exc'
  END metodo,
  CASE
     WHEN event_id ~ '^ANH_[0-9]{1,3}_Captura manual[0-9]_202[12]-[0-9]{2}-[0-9]{2}$' THEN REGEXP_REPLACE(event_id,'^ANH_[0-9]{1,3}_Captura manual([0-9])_202[12]-[0-9]{2}-[0-9]{2}$','\1')::int
     WHEN event_id ~ '^ANH_[0-9]{1,3}_T. Exc. Human[0-9]_202[12]-[0-9]{2}-[0-9]{2}/202[12]-[0-9]{2}-[0-9]{2}$' THEN REGEXP_REPLACE(event_id,'^ANH_[0-9]{1,3}_T. Exc. Human([0-9])_202[12]-[0-9]{2}-[0-9]{2}/202[12]-[0-9]{2}-[0-9]{2}$','\1')::int
  END trap_num,
  CASE
     WHEN event_id ~ '^ANH_[0-9]{1,3}_Captura manual[0-9]_202[12]-[0-9]{2}-[0-9]{2}$' THEN REGEXP_REPLACE(event_id,'^ANH_[0-9]{1,3}_Captura manual[0-9]_(202[12])-[0-9]{2}-[0-9]{2}$','\1')
     WHEN event_id ~ '^ANH_[0-9]{1,3}_T. Exc. Human[0-9]_202[12]-[0-9]{2}-[0-9]{2}/202[12]-[0-9]{2}-[0-9]{2}$' THEN REGEXP_REPLACE(event_id,'^ANH_[0-9]{1,3}_T. Exc. Human[0-9]_(202[12])-[0-9]{2}-[0-9]{2}/202[12]-[0-9]{2}-[0-9]{2}$','\1')
  END año,
  cd_pt_ref
FROM raw_dwc.escarabajos_event
), campaign AS(
SELECT año, anh_num, ROW_NUMBER() OVER (PARTITION BY anh_num ORDER BY año) campaign_nb
FROM a
GROUP BY año, anh_num
ORDER BY año, anh_num
),b AS(
SELECT event_id,
  CASE
    WHEN metodo='Captura manual' THEN (SELECT cd_protocol FROM main.def_protocol WHERE protocol='Insect hand collection')
    WHEN metodo='Tramp Exc' THEN (SELECT cd_protocol FROM main.def_protocol WHERE protocol='Human excrement trap')
  END cd_protocol,
  cd_pt_ref,
  c.campaign_nb
FROM a
LEFT JOIN campaign c USING (año, anh_num)
LEFT JOIN main.punto_referencia USING (cd_pt_ref)
),d AS(
SELECT b.*, cd_gp_event
FROM b
LEFT JOIN main.gp_event ge ON cd_gp_biol='esca' AND b.cd_protocol=ge.cd_protocol AND b.cd_pt_ref=ge.cd_pt_ref AND b.campaign_nb=ge.campaign_nb
)
UPDATE raw_dwc.escarabajos_event e
SET cd_gp_event=d.cd_gp_event
FROM d
WHERE d.event_id=e.event_id
RETURNING e.event_id, e.cd_gp_event
;
```

## event

Note that a lot of temporal information is lacking... 

We need to add "esca" to the event_id, otherwise it can be on conflict with the ants

\footnotesize

```{sql}
INSERT INTO main.event(cd_gp_event,event_id,num_replicate, description_replicate, date_time_begin, date_time_end, locality_verb, event_remarks, samp_effort_1, samp_effort_2, pt_geom)
WITH a AS(
SELECT cd_gp_event,
  event_id, 
  CASE
     WHEN event_id ~ '^ANH_[0-9]{1,3}_Captura manual[0-9]_202[12]-[0-9]{2}-[0-9]{2}$' THEN REGEXP_REPLACE(event_id,'^ANH_[0-9]{1,3}_Captura manual([0-9])_202[12]-[0-9]{2}-[0-9]{2}$','\1')::int
     WHEN event_id ~ '^ANH_[0-9]{1,3}_T. Exc. Human[0-9]_202[12]-[0-9]{2}-[0-9]{2}/202[12]-[0-9]{2}-[0-9]{2}$' THEN REGEXP_REPLACE(event_id,'^ANH_[0-9]{1,3}_T. Exc. Human([0-9])_202[12]-[0-9]{2}-[0-9]{2}/202[12]-[0-9]{2}-[0-9]{2}$','\1')::int
  END num_replicate,
  CASE
     WHEN event_id ~ '^ANH_[0-9]{1,3}_Captura manual[0-9]_202[12]-[0-9]{2}-[0-9]{2}$' THEN REGEXP_REPLACE(event_id,'^ANH_[0-9]{1,3}_Captura manual([0-9]_202[12]-[0-9]{2}-[0-9]{2})$','\1')
     WHEN event_id ~ '^ANH_[0-9]{1,3}_T. Exc. Human[0-9]_202[12]-[0-9]{2}-[0-9]{2}/202[12]-[0-9]{2}-[0-9]{2}$' THEN REGEXP_REPLACE(event_id,'^ANH_[0-9]{1,3}_T. Exc. Human([0-9]_202[12]-[0-9]{2}-[0-9]{2}/202[12]-[0-9]{2}-[0-9]{2})$','\1')
  END description_replicate,
  TO_DATE(SPLIT_PART(event_date,'/',1), 'YYYY-MM-DD') date_1,
  CASE 
    WHEN SPLIT_PART(event_date,'/',2)='' THEN NULL
    ELSE TO_DATE(SPLIT_PART(event_date,'/',2), 'YYYY-MM-DD')
  END date_2,
  REGEXP_REPLACE(SPLIT_PART(event_time,'/',1),'\s+','','g') hora_1,
  CASE
  	WHEN REGEXP_REPLACE(SPLIT_PART(event_time,'/',2),'\s+','','g')='' THEN NULL
	ELSE REGEXP_REPLACE(SPLIT_PART(event_time,'/',2),'\s+','','g')
  END hora_2,
  locality locality_verb,
  sample_size_value,
  sampling_effort,
  location_remarks event_remarks,
  decimal_latitude::double precision,
  decimal_longitude::double precision
FROM raw_dwc.escarabajos_event
),b AS(--calculation of timestamps and coordinates
SELECT 
  cd_gp_event,
  event_id, 
  num_replicate,
  description_replicate,
  CASE
    WHEN date_1 IS NULL OR hora_1 IS NULL THEN NULL
    ELSE (date_1||' '||hora_1)::timestamp 
  END date_time_begin,
  CASE
    WHEN protocol='Insect hand collection' AND date_1 IS NOT NULL AND hora_2 IS NOT NULL THEN (date_1||' '||hora_2)::timestamp
    WHEN date_2 IS NULL OR hora_2 IS NULL THEN NULL
    ELSE (date_2||' '||hora_2)::timestamp
  END date_time_end,
  locality_verb,
  event_remarks ,
  sample_size_value,
  sampling_effort,
  ST_SetSRID(ST_Transform(ST_SetSRID(ST_MakePoint(decimal_longitude,decimal_latitude),4326), (SELECT proj4text FROM spatial_ref_sys WHERE srid=3116)),3116) pt_geom
FROM a
LEFT JOIN main.gp_event USING (cd_gp_event)
LEFT JOIN main.def_protocol p USING (cd_protocol)
ORDER BY cd_gp_event, event_id, num_replicate
)--calculation of sampling efforts
SELECT
  cd_gp_event,
  'esca_'||event_id event_id,
  num_replicate,
  description_replicate,
  date_time_begin,
  date_time_end,
  locality_verb,
  event_remarks,
  CASE
   WHEN protocol='Insect hand collection' THEN sample_size_value
   WHEN protocol='Human excrement trap' AND (date_time_begin IS NULL OR date_time_end IS NULL) THEN (REGEXP_REPLACE(sampling_effort,' horas','')::int)*60
   WHEN protocol='Human excrement trap' AND date_time_begin IS NOT NULL AND date_time_end IS NOT NULL THEN (EXTRACT('EPOCH' FROM (date_time_end-date_time_begin))/60)::int
   ELSE NULL
  END samp_eff_1,
  CASE
   WHEN protocol='Insect hand collection' AND date_time_begin IS NOT NULL AND date_time_end IS NOT NULL THEN (EXTRACT('EPOCH' FROM (date_time_end-date_time_begin))/60)::int
   ELSE NULL
  END samp_eff_2,
  pt_geom
FROM b
LEFT JOIN main.gp_event USING (cd_gp_event)
LEFT JOIN main.def_protocol p USING (cd_protocol)
ORDER BY cd_gp_event, event_id, num_replicate

RETURNING main.event.cd_event, main.event.cd_gp_event, main.event.event_id, main.event.num_replicate, main.event.description_replicate, main.event.date_time_begin, main.event.date_time_end, main.event.locality_verb, main.event.event_remarks, main.event.pt_geom
```

Damos los cd_event a todos las filas:

```{sql}
ALTER TABLE raw_dwc.escarabajos_event ADD COLUMN cd_event int REFERENCES main.event(cd_event) ON DELETE SET NULL;
ALTER TABLE raw_dwc.escarabajos_registros ADD COLUMN cd_event int REFERENCES main.event(cd_event);

UPDATE raw_dwc.escarabajos_event AS t
SET cd_event=e.cd_event
FROM main.event e
WHERE 'esca_'||t.event_id=e.event_id;

UPDATE raw_dwc.escarabajos_registros AS t
SET cd_event=e.cd_event
FROM main.event e
WHERE 'esca_'||t.event_id=e.event_id;

SELECT true;
```

Añadir fechas en la tabla extra cuando las horas no son disponibles

```{sql}
INSERT INTO main.event_extra(cd_event, cd_var_event_extra,value_text)
WITH a AS(
SELECT cd_event,ef.date_time_begin,
  TO_DATE(SPLIT_PART(event_date,'/',1), 'YYYY-MM-DD') date_1
FROM raw_dwc.escarabajos_event e
LEFT JOIN main.event ef USING (cd_event)
WHERE date_time_begin IS NULL
),b AS(
SELECT cd_event,
  CASE
   WHEN date_time_begin IS NULL THEN date_1
   ELSE NULL
  END date_begin
FROM a
)
SELECT 
 cd_event,
 (SELECT cd_var_event_extra FROM main.def_var_event_extra WHERE var_event_extra='date_begin'),
 to_char(date_begin,'yyyy-mm-dd')::text
FROM b
WHERE date_begin IS NOT NULL
RETURNING main.event_extra.cd_event, main.event_extra.cd_var_event_extra, main.event_extra.value_text
;

INSERT INTO main.event_extra(cd_event, cd_var_event_extra,value_text)
WITH a AS(
SELECT cd_event,ef.date_time_end,
  e.event_id,
  REGEXP_REPLACE(e.event_id,'^ANH_[0-9]{1,3}_((Captura manual)|(T. Exc. Human))[0-9].*$','\1') metodo,
  CASE
     WHEN e.event_id ~ '^ANH_[0-9]{1,3}_Captura manual[0-9]_202[12]-[0-9]{2}-[0-9]{2}$' THEN REGEXP_REPLACE(e.event_id,'^ANH_[0-9]{1,3}_Captura manual[0-9]_(202[12]-[0-9]{2}-[0-9]{2})$','\1')::date
     WHEN e.event_id ~ '^ANH_[0-9]{1,3}_T. Exc. Human[0-9]_202[12]-[0-9]{2}-[0-9]{2}/202[12]-[0-9]{2}-[0-9]{2}$' THEN REGEXP_REPLACE(e.event_id,'^ANH_[0-9]{1,3}_T. Exc. Human[0-9]_(202[12]-[0-9]{2}-[0-9]{2})/202[12]-[0-9]{2}-[0-9]{2}$','\1')::date
  END date_1_from_eid,
  CASE
  WHEN e.event_id ~ '^ANH_[0-9]{1,3}_Captura manual[0-9]_202[12]-[0-9]{2}-[0-9]{2}$' THEN REGEXP_REPLACE(e.event_id,'^ANH_[0-9]{1,3}_Captura manual[0-9]_(202[12]-[0-9]{2}-[0-9]{2})$','\1')::date
  WHEN e.event_id ~ '^ANH_[0-9]{1,3}_T. Exc. Human[0-9]_202[12]-[0-9]{2}-[0-9]{2}/202[12]-[0-9]{2}-[0-9]{2}$' THEN REGEXP_REPLACE(e.event_id,'^ANH_[0-9]{1,3}_T. Exc. Human[0-9]_202[12]-[0-9]{2}-[0-9]{2}/(202[12]-[0-9]{2}-[0-9]{2})$','\1')::date
  
  END date_2_from_eid,
  TO_DATE(SPLIT_PART(event_date,'/',1), 'YYYY-MM-DD') date_1,
  CASE 
    WHEN SPLIT_PART(event_date,'/',2)='' THEN NULL
    ELSE TO_DATE(SPLIT_PART(event_date,'/',2), 'YYYY-MM-DD')
  END date_2
FROM raw_dwc.escarabajos_event e
LEFT JOIN main.event ef USING (cd_event)
WHERE date_time_end IS NULL
),b AS(
SELECT cd_event,
  CASE
   WHEN metodo='Captura manual' THEN COALESCE(date_2,date_1,date_2_from_eid,date_1_from_eid)
   ELSE COALESCE(date_2,date_2_from_eid)
  END date_end
FROM a
)
SELECT 
 cd_event,
 (SELECT cd_var_event_extra FROM main.def_var_event_extra WHERE var_event_extra='date_end'),
 to_char(date_end,'yyyy-mm-dd')::text
FROM b
WHERE date_end IS NOT NULL
RETURNING main.event_extra.cd_event, main.event_extra.cd_var_event_extra, main.event_extra.value_text
;

```

## registros

Nota:

1. a veces la horas en registros no están en el rango de horas dadas en el evento
2. las horas dadas en registros son tambien rangos de horas: se guardará la primera hora, la siguiente se podrá añadir en una tabla registros extra...
3. Tocaría averiguar que los samplingEffort dados en event correspondan a los de registros, tengo una mala sensación comparandolos a vista...


```{sql}
SELECT occurrence_id, count(*)
FROM raw_dwc.escarabajos_registros 
GROUP BY occurrence_id
HAVING count(*)>1;
```


Parece que la fechas y horas en registros son solo el reflejo de las fechas y horas en eventos:


```{sql}
SELECT e.event_id, e.event_date, r.event_date, e.event_time, r.event_time
FROM raw_dwc.escarabajos_registros r
LEFT JOIN raw_dwc.escarabajos_event e USING(cd_event)


```



```{sql}

INSERT INTO main.registros(cd_event, cds_recorded_by, date_time, cd_tax, cd_morfo, date_ident, cds_identified_by, qt_int,remarks, occurrence_id, organism_id)
SELECT 
 cd_event,
 cds_recorded_by,
 (event_date||' '||SPLIT_PART(event_time,'/',1))::timestamp date_time,
 tt.cd_tax,
 tt.cd_morfo,
 TO_DATE(date_identified,'YYYY-MM-DD') date_ident,
 cds_identified_by,
 organism_quantity::double precision::int qt_int,
 r.event_remarks,
 occurrence_id,
 SPLIT_PART(occurrence_id,':',7) organism_id
 --ROW_NUMBER() OVER (ORDER BY (e.date_time_begin::date||' '||event_time)::timestamp)
 --organism_id::text
FROM raw_dwc.escarabajos_registros r
LEFT JOIN raw_dwc.taxonomy_total tt ON tt."row.names"=r."row.names" AND tt.table_orig='escarabajos_registros'
LEFT JOIN main.event e USING (cd_event)
ORDER BY date_time
RETURNING cd_event, cds_recorded_by, date_time, cd_tax, cd_morfo, cds_identified_by, qt_int,remarks, occurrence_id, organism_id
```

```{sql}
ALTER TABLE raw_dwc.escarabajos_registros ADD COLUMN cd_reg int REFERENCES main.registros(cd_reg);
UPDATE raw_dwc.escarabajos_registros AS ar
SET cd_reg=r.cd_reg
FROM main.registros r
WHERE ar.cd_event=r.cd_event AND ar.occurrence_id=r.occurrence_id;

-- Check cd_reg are unique in the source table
SELECT cd_reg,count(*) FROM  raw_dwc.escarabajos_registros GROUP BY cd_reg HAVING count(*)>1;
```

### Añadir la información temporal supplementaria

```{sql}
INSERT INTO main.def_var_registros_extra(var_registros_extra, type_var, var_registros_extra_spa, var_registros_extra_comment)
VALUES
  ('date_time_end',
  'free text',
  'fecha_tiempo_final',
  'En algunos casos (p.ej escarabajos, un rango de tiempo está dado tambien en los registros, en esos casos date_time da la hora inicial y la hora final está en esta variable suplementaria, as a text. el formato es YYYY-MM-DD HH:MI:SS'
  );

INSERT INTO main.registros_extra(cd_reg,cd_var_registros_extra,value_text)
SELECT cd_reg,
(SELECT cd_var_registros_extra FROM main.def_var_registros_extra WHERE var_registros_extra='date_time_end'),
(event_date||' '||SPLIT_PART(event_time,'/',2))::timestamp::text
FROM raw_dwc.escarabajos_registros
WHERE SPLIT_PART(event_time,'/',2) != '';
```

**TODO: poner los occurrenceRemarks en individual characteristics para poder filtrar las larvas etc.**


# Colémbolos

```{sql}
WITH a AS(
SELECT event_id,
  REGEXP_REPLACE(event_id, '^ANH_([0-9]{1,3})_((Pitfall)|(Berlese))([0-9])_(202[12])-[0-9]{1,2}-[0-9]{1,2}(/202[12]-[0-9]{1,2}-[0-9]{1,2})?$', '\1')::int anh_num,
  REGEXP_REPLACE(event_id, '^ANH_([0-9]{1,3})_((Pitfall)|(Berlese))([0-9])_(202[12])-[0-9]{1,2}-[0-9]{1,2}(/202[12]-[0-9]{1,2}-[0-9]{1,2})?$', '\2') metodo,
  REGEXP_REPLACE(event_id, '^ANH_([0-9]{1,3})_((Pitfall)|(Berlese))([0-9])_(202[12])-[0-9]{1,2}-[0-9]{1,2}(/202[12]-[0-9]{1,2}-[0-9]{1,2})?$', '\5')::int repli,
  REGEXP_REPLACE(event_id, '^ANH_([0-9]{1,3})_((Pitfall)|(Berlese))([0-9])_(202[12])-[0-9]{1,2}-[0-9]{1,2}(/202[12]-[0-9]{1,2}-[0-9]{1,2})?$', '\6') año
FROM raw_dwc.collembolos_event
)
SELECT anh_num, año, ARRAY_AGG(DISTINCT metodo ORDER BY metodo),  count(*)
FROM a
GROUP BY anh_num, año
;

```

```{sql}
WITH a AS(
SELECT event_id,
  REGEXP_REPLACE(event_id, '^ANH_([0-9]{1,3})_((Pitfall)|(Berlese))([0-9])_(202[12])-[0-9]{1,2}-[0-9]{1,2}(/202[12]-[0-9]{1,2}-[0-9]{1,2})?$', '\1')::int anh_num,
  REGEXP_REPLACE(event_id, '^ANH_([0-9]{1,3})_((Pitfall)|(Berlese))([0-9])_(202[12])-[0-9]{1,2}-[0-9]{1,2}(/202[12]-[0-9]{1,2}-[0-9]{1,2})?$', '\2') metodo,
  REGEXP_REPLACE(event_id, '^ANH_([0-9]{1,3})_((Pitfall)|(Berlese))([0-9])_(202[12])-[0-9]{1,2}-[0-9]{1,2}(/202[12]-[0-9]{1,2}-[0-9]{1,2})?$', '\5')::int repli,
  REGEXP_REPLACE(event_id, '^ANH_([0-9]{1,3})_((Pitfall)|(Berlese))([0-9])_(202[12])-[0-9]{1,2}-[0-9]{1,2}(/202[12]-[0-9]{1,2}-[0-9]{1,2})?$', '\6') año
FROM raw_dwc.collembolos_event
)
SELECT anh_num, año,metodo, ARRAY_AGG(DISTINCT repli ORDER BY repli) repli,  count(*)
FROM a
GROUP BY anh_num, año, metodo
;

```
Para entender el plan de muestreo:




## ANH


Insertar los datos de anh:

```{sql}
INSERT INTO main.punto_referencia(name_pt_ref, num_anh)
WITH a AS(
SELECT
  REGEXP_REPLACE(event_id,'^ANH_([0-9]{1,3}).*$','\1')::int anh_num,
  REGEXP_REPLACE(event_id,'^(ANH_[0-9]{1,3}).*$','\1') anh_name
FROM raw_dwc.collembolos_event
)
SELECT anh_name, anh_num
FROM a
GROUP BY anh_name,anh_num
ORDER BY anh_num
ON CONFLICT (name_pt_ref) DO NOTHING
RETURNING cd_pt_ref, name_pt_ref
;
```

dar las referencias en las tablas de collembolos

```{sql}
ALTER TABLE raw_dwc.collembolos_event ADD COLUMN cd_pt_ref int REFERENCES main.punto_referencia(cd_pt_ref) ON DELETE SET NULL ON UPDATE CASCADE;
ALTER TABLE raw_dwc.collembolos_registros ADD COLUMN cd_pt_ref int REFERENCES main.punto_referencia(cd_pt_ref) ON DELETE SET NULL ON UPDATE CASCADE;

UPDATE raw_dwc.collembolos_event
SET cd_pt_ref=pr.cd_pt_ref
FROM main.punto_referencia pr
WHERE REGEXP_REPLACE(event_id,'^(ANH_[0-9]{1,3}).*$','\1') = name_pt_ref
;

UPDATE raw_dwc.collembolos_registros
SET cd_pt_ref=pr.cd_pt_ref
FROM main.punto_referencia pr
WHERE  REGEXP_REPLACE(event_id,'^(ANH_[0-9]{1,3}).*$','\1') = name_pt_ref
;

SELECT true;
```

Averiguando que ninguna fila no tenga anh

```{sql}
SELECT event_id FROM raw_dwc.collembolos_event WHERE cd_pt_ref IS NULL;
```

```{sql}
SELECT occurrence_id FROM raw_dwc.collembolos_registros WHERE cd_pt_ref IS NULL;
```

## Unit, sampling efforts definition, abundance definition, protocolo

```{sql}
INSERT INTO main.def_unit(cd_measurement_type, unit, unit_spa, abbv_unit,factor)
VALUES(
  (SELECT cd_measurement_type FROM main.def_measurement_type WHERE measurement_type='volume'),
  'Cubic centimeter',
  'Centímetros cúbicos',
  'cm3',
  1
  )
RETURNING cd_unit,unit;
```

```{sql}
INSERT INTO main.def_var_samp_eff(var_samp_eff, var_samp_eff_spa, cd_unit,type_variable)
VALUES(
  'Trap volume',
  'Volumen de la trampa',
  (SELECT cd_unit FROM main.def_unit WHERE cd_measurement_type=(SELECT cd_measurement_type FROM main.def_measurement_type WHERE measurement_type='volume') AND unit='Cubic centimeter'),
  'double precision'
  )
RETURNING cd_var_samp_eff, var_samp_eff ;
```

```{sql}
INSERT INTO main.def_protocol(protocol,protocol_spa,cd_var_samp_eff_1,cd_var_samp_eff_2,samp_eff_1_implicit,samp_eff_2_implicit,cd_var_ind_qt,description_spa)
VALUES(
  'Berlese trap (arthropods)',
  'Trampa Berlese para artropodos',
  (SELECT cd_var_samp_eff FROM main.def_var_samp_eff WHERE var_samp_eff='Trap volume'),
  (SELECT cd_var_samp_eff FROM main.def_var_samp_eff WHERE var_samp_eff='Elapsed time'),
  false,
  true,
  (SELECT cd_var_ind_qt FROM main.def_var_ind_qt WHERE var_qt_ind='Number of individuals'),
  NULL
),(
  'Pitfall (arthropods)',
  'Trampa pitfall para artropodos',
  (SELECT cd_var_samp_eff FROM main.def_var_samp_eff WHERE var_samp_eff='Elapsed time'),
  NULL,
  true,
  NULL,
  (SELECT cd_var_ind_qt FROM main.def_var_ind_qt WHERE var_qt_ind='Number of individuals'),
  'Nota: eso no concierne la hormigas, que manejan solamente presence/absence'
)
RETURNING cd_protocol,protocol,protocol_spa;
```

## Personas

```{sql}
INSERT INTO main.people(verbatim_person)
WITH a AS(
SELECT DISTINCT INITCAP(TRIM(UNNEST(STRING_TO_ARRAY(recorded_by, ' | ')))) AS name_person
FROM raw_dwc.collembolos_registros
UNION
SELECT DISTINCT INITCAP(TRIM(UNNEST(STRING_TO_ARRAY(identified_by, ' | '))))
FROM raw_dwc.collembolos_registros
)
SELECT DISTINCT REGEXP_REPLACE(name_person, '- ','-')
FROM a 
ORDER BY REGEXP_REPLACE(name_person, '- ','-')
ON CONFLICT(verbatim_person) DO NOTHING
RETURNING cd_person, verbatim_person
```

Dar los codigos a las tables de origen:

```{sql}
ALTER TABLE raw_dwc.collembolos_registros ADD COLUMN cds_recorded_by int[];

WITH a AS(
SELECT "row.names", REGEXP_REPLACE(INITCAP(TRIM(UNNEST(STRING_TO_ARRAY(recorded_by, ' | ')))),'- ','-') AS name_person
FROM raw_dwc.collembolos_registros
),b AS(
SELECT "row.names", ARRAY_AGG(cd_person) cds
FROM a 
LEFT JOIN main.people p ON a.name_person=p.verbatim_person
GROUP BY "row.names"
)
UPDATE raw_dwc.collembolos_registros AS r
SET cds_recorded_by=b.cds
FROM b
WHERE r."row.names"=b."row.names"
RETURNING r."row.names", cds_recorded_by
;

ALTER TABLE raw_dwc.collembolos_registros ADD COLUMN cds_identified_by int[];

WITH a AS(
SELECT "row.names", REGEXP_REPLACE(INITCAP(TRIM(UNNEST(STRING_TO_ARRAY(identified_by, ' | ')))),'- ','-') AS name_person
FROM raw_dwc.collembolos_registros
),b AS(
SELECT "row.names", ARRAY_AGG(cd_person) cds
FROM a 
LEFT JOIN main.people p ON a.name_person=p.verbatim_person
GROUP BY "row.names"
)
UPDATE raw_dwc.collembolos_registros AS r
SET cds_identified_by=b.cds
FROM b
WHERE r."row.names"=b."row.names"
RETURNING r."row.names", cds_identified_by
;

SELECT 1;
```

## gp_event

```{sql}
WITH a AS(
SELECT 
  event_id,
  REGEXP_REPLACE(event_id, '^ANH_([0-9]{1,3})_((Pitfall)|(Berlese))([0-9])_(202[12])-[0-9]{1,2}-[0-9]{1,2}(/202[12]-[0-9]{1,2}-[0-9]{1,2})?$', '\1')::int anh_num,
  REGEXP_REPLACE(event_id, '^ANH_([0-9]{1,3})_((Pitfall)|(Berlese))([0-9])_(202[12])-[0-9]{1,2}-[0-9]{1,2}(/202[12]-[0-9]{1,2}-[0-9]{1,2})?$', '\2') metodo,
  REGEXP_REPLACE(event_id, '^ANH_([0-9]{1,3})_((Pitfall)|(Berlese))([0-9])_(202[12])-[0-9]{1,2}-[0-9]{1,2}(/202[12]-[0-9]{1,2}-[0-9]{1,2})?$', '\5')::int repli,
  REGEXP_REPLACE(event_id, '^ANH_([0-9]{1,3})_((Pitfall)|(Berlese))([0-9])_(202[12])-[0-9]{1,2}-[0-9]{1,2}(/202[12]-[0-9]{1,2}-[0-9]{1,2})?$', '\6') año
FROM raw_dwc.collembolos_event
)
SELECT año, anh_num,metodo, ARRAY_AGG(repli), count(*)
FROM a
GROUP BY año, anh_num, metodo
ORDER BY año, anh_num, metodo
;
```

Because there is more than a method, the number of the campaign should be determined this way:

```{sql}
WITH a AS(
SELECT 
  event_id,
  REGEXP_REPLACE(event_id, '^ANH_([0-9]{1,3})_((Pitfall)|(Berlese))([0-9])_(202[12])-[0-9]{1,2}-[0-9]{1,2}(/202[12]-[0-9]{1,2}-[0-9]{1,2})?$', '\1')::int anh_num,
  REGEXP_REPLACE(event_id, '^ANH_([0-9]{1,3})_((Pitfall)|(Berlese))([0-9])_(202[12])-[0-9]{1,2}-[0-9]{1,2}(/202[12]-[0-9]{1,2}-[0-9]{1,2})?$', '\2') metodo,
  REGEXP_REPLACE(event_id, '^ANH_([0-9]{1,3})_((Pitfall)|(Berlese))([0-9])_(202[12])-[0-9]{1,2}-[0-9]{1,2}(/202[12]-[0-9]{1,2}-[0-9]{1,2})?$', '\5')::int repli,
  REGEXP_REPLACE(event_id, '^ANH_([0-9]{1,3})_((Pitfall)|(Berlese))([0-9])_(202[12])-[0-9]{1,2}-[0-9]{1,2}(/202[12]-[0-9]{1,2}-[0-9]{1,2})?$', '\6') año
FROM raw_dwc.collembolos_event
)
SELECT año, anh_num, ROW_NUMBER() OVER (PARTITION BY anh_num ORDER BY año) campaign_nb
FROM a
GROUP BY año, anh_num
ORDER BY año, anh_num
;
```


```{sql}
INSERT INTO main.gp_event(cd_gp_biol,cd_protocol,cd_pt_ref,campaign_nb)
WITH a AS(
SELECT 
  event_id,
  REGEXP_REPLACE(event_id, '^ANH_([0-9]{1,3})_((Pitfall)|(Berlese))([0-9])_(202[12])-[0-9]{1,2}-[0-9]{1,2}(/202[12]-[0-9]{1,2}-[0-9]{1,2})?$', '\1')::int anh_num,
  REGEXP_REPLACE(event_id, '^ANH_([0-9]{1,3})_((Pitfall)|(Berlese))([0-9])_(202[12])-[0-9]{1,2}-[0-9]{1,2}(/202[12]-[0-9]{1,2}-[0-9]{1,2})?$', '\2') metodo,
  REGEXP_REPLACE(event_id, '^ANH_([0-9]{1,3})_((Pitfall)|(Berlese))([0-9])_(202[12])-[0-9]{1,2}-[0-9]{1,2}(/202[12]-[0-9]{1,2}-[0-9]{1,2})?$', '\5')::int repli,
  REGEXP_REPLACE(event_id, '^ANH_([0-9]{1,3})_((Pitfall)|(Berlese))([0-9])_(202[12])-[0-9]{1,2}-[0-9]{1,2}(/202[12]-[0-9]{1,2}-[0-9]{1,2})?$', '\6') año,
  cd_pt_ref
FROM raw_dwc.collembolos_event
), campaign AS(
SELECT año, anh_num, ROW_NUMBER() OVER (PARTITION BY anh_num ORDER BY año) campaign_nb
FROM a
GROUP BY año, anh_num
ORDER BY año, anh_num
)
SELECT 'cole',
  CASE
    WHEN metodo='Pitfall' THEN (SELECT cd_protocol FROM main.def_protocol WHERE protocol='Pitfall (arthropods)')
    WHEN metodo='Berlese' THEN (SELECT cd_protocol FROM main.def_protocol WHERE protocol='Berlese trap (arthropods)')
  END cd_protocol,
  cd_pt_ref,
  c.campaign_nb
FROM a
LEFT JOIN campaign c USING (año, anh_num)
LEFT JOIN main.punto_referencia USING (cd_pt_ref)
GROUP BY cd_pt_ref, name_pt_ref, año, metodo, c.campaign_nb
ORDER BY año,cd_pt_ref,cd_protocol
RETURNING cd_gp_event,cd_gp_biol,cd_protocol,cd_pt_ref,campaign_nb
;
```

Attributing the gp_event

```{sql}
ALTER TABLE raw_dwc.collembolos_event ADD COLUMN cd_gp_event int REFERENCES main.gp_event(cd_gp_event) ON DELETE SET NULL;


WITH a AS(
SELECT 
  event_id,
  REGEXP_REPLACE(event_id, '^ANH_([0-9]{1,3})_((Pitfall)|(Berlese))([0-9])_(202[12])-[0-9]{1,2}-[0-9]{1,2}(/202[12]-[0-9]{1,2}-[0-9]{1,2})?$', '\1')::int anh_num,
  REGEXP_REPLACE(event_id, '^ANH_([0-9]{1,3})_((Pitfall)|(Berlese))([0-9])_(202[12])-[0-9]{1,2}-[0-9]{1,2}(/202[12]-[0-9]{1,2}-[0-9]{1,2})?$', '\2') metodo,
  REGEXP_REPLACE(event_id, '^ANH_([0-9]{1,3})_((Pitfall)|(Berlese))([0-9])_(202[12])-[0-9]{1,2}-[0-9]{1,2}(/202[12]-[0-9]{1,2}-[0-9]{1,2})?$', '\5')::int repli,
  REGEXP_REPLACE(event_id, '^ANH_([0-9]{1,3})_((Pitfall)|(Berlese))([0-9])_(202[12])-[0-9]{1,2}-[0-9]{1,2}(/202[12]-[0-9]{1,2}-[0-9]{1,2})?$', '\6') año,
  cd_pt_ref
FROM raw_dwc.collembolos_event
), campaign AS(
SELECT año, anh_num, ROW_NUMBER() OVER (PARTITION BY anh_num ORDER BY año) campaign_nb
FROM a
GROUP BY año, anh_num
ORDER BY año, anh_num
),b AS(
SELECT event_id,
  CASE
    WHEN metodo='Pitfall' THEN (SELECT cd_protocol FROM main.def_protocol WHERE protocol='Pitfall (arthropods)')
    WHEN metodo='Berlese' THEN (SELECT cd_protocol FROM main.def_protocol WHERE protocol='Berlese trap (arthropods)')
  END cd_protocol,
  cd_pt_ref,
  c.campaign_nb
FROM a
LEFT JOIN campaign c USING (año, anh_num)
LEFT JOIN main.punto_referencia USING (cd_pt_ref)
),d AS(
SELECT b.*, cd_gp_event
FROM b
LEFT JOIN main.gp_event ge ON cd_gp_biol='cole' AND b.cd_protocol=ge.cd_protocol AND b.cd_pt_ref=ge.cd_pt_ref AND b.campaign_nb=ge.campaign_nb
)
UPDATE raw_dwc.collembolos_event e
SET cd_gp_event=d.cd_gp_event
FROM d
WHERE d.event_id=e.event_id
RETURNING e.event_id, e.cd_gp_event
;
```

## event


\footnotesize

```{sql}
INSERT INTO main.event(cd_gp_event,event_id,num_replicate, description_replicate, date_time_begin, date_time_end, locality_verb, event_remarks, samp_effort_1, samp_effort_2, pt_geom)
WITH a AS(
SELECT cd_gp_event,
  event_id, 
  REGEXP_REPLACE(event_id, '^ANH_([0-9]{1,3})_((Pitfall)|(Berlese))([0-9])_(202[12])-[0-9]{1,2}-[0-9]{1,2}(/202[12]-[0-9]{1,2}-[0-9]{1,2})?$', '\5')::int num_replicate,
  REGEXP_REPLACE(event_id, '^ANH_([0-9]{1,3})_((Pitfall)|(Berlese))([0-9]_202[12]-[0-9]{1,2}-[0-9]{1,2}(/202[12]-[0-9]{1,2}-[0-9]{1,2})?)$', '\5') description_replicate,
  TO_DATE(SPLIT_PART(event_date,'/',1), 'YYYY-MM-DD') date_1,
  CASE 
    WHEN SPLIT_PART(event_date,'/',2)='' THEN NULL
    ELSE TO_DATE(SPLIT_PART(event_date,'/',2), 'YYYY-MM-DD')
  END date_2,
  REGEXP_REPLACE(SPLIT_PART(event_time,'/',1),'\s+','','g') hora_1,
  CASE
  	WHEN REGEXP_REPLACE(SPLIT_PART(event_time,'/',2),'\s+','','g')='' THEN NULL
	ELSE REGEXP_REPLACE(SPLIT_PART(event_time,'/',2),'\s+','','g')
  END hora_2,
  locality locality_verb,
  sample_size_value,
  sampling_effort,
  REGEXP_REPLACE(REGEXP_REPLACE(event_remarks,'\| ?La hora inicial corresponde al día que se instaló la trampa y la hora final al día que se retiró',''),'\| Sin registros de individuos','') event_remarks,
  --locality_remarks,
  decimal_latitude::double precision,
  decimal_longitude::double precision
FROM raw_dwc.collembolos_event
),b AS(--calculation of timestamps and coordinates
SELECT 
  cd_gp_event,
  event_id, 
  num_replicate,
  description_replicate,
  CASE
    WHEN date_1 IS NULL OR hora_1 IS NULL THEN NULL
    ELSE (date_1||' '||hora_1)::timestamp 
  END date_time_begin,
  CASE
    WHEN date_2 IS NULL OR hora_2 IS NULL THEN NULL
    ELSE (date_2||' '||hora_2)::timestamp
  END date_time_end,
  locality_verb,
  event_remarks ,
  sample_size_value,
  sampling_effort,
  ST_SetSRID(ST_Transform(ST_SetSRID(ST_MakePoint(decimal_longitude,decimal_latitude),4326), (SELECT proj4text FROM spatial_ref_sys WHERE srid=3116)),3116) pt_geom
FROM a
LEFT JOIN main.gp_event USING (cd_gp_event)
LEFT JOIN main.def_protocol p USING (cd_protocol)
ORDER BY cd_gp_event, event_id, num_replicate
)--calculation of sampling efforts
SELECT
  cd_gp_event,
  'cole_'||event_id event_id,
  num_replicate,
  description_replicate,
  date_time_begin,
  date_time_end,
  locality_verb,
  event_remarks,
  CASE
   WHEN protocol='Berlese trap (arthropods)' THEN sample_size_value
   WHEN protocol='Pitfall (arthropods)' AND (date_time_begin IS NULL OR date_time_end IS NULL) THEN (REGEXP_REPLACE(sampling_effort,' horas','')::int)*60
   WHEN protocol='Pitfall (arthropods)' AND date_time_begin IS NOT NULL AND date_time_end IS NOT NULL THEN (EXTRACT('EPOCH' FROM (date_time_end-date_time_begin))/60)::int
   ELSE NULL
  END samp_eff_1,
  CASE
   WHEN protocol='Berlese trap (arthropods)' AND date_time_begin IS NOT NULL AND date_time_end IS NOT NULL THEN (EXTRACT('EPOCH' FROM (date_time_end-date_time_begin))/60)::int
   ELSE NULL
  END samp_eff_2,
  pt_geom
FROM b
LEFT JOIN main.gp_event USING (cd_gp_event)
LEFT JOIN main.def_protocol p USING (cd_protocol)
ORDER BY cd_gp_event, event_id, num_replicate

RETURNING main.event.cd_event, main.event.cd_gp_event, main.event.event_id, main.event.num_replicate, main.event.description_replicate, main.event.date_time_begin, main.event.date_time_end, main.event.locality_verb, main.event.event_remarks, main.event.pt_geom
```

Damos los cd_event a todos las filas:

```{sql}
ALTER TABLE raw_dwc.collembolos_event ADD COLUMN cd_event int REFERENCES main.event(cd_event) ON DELETE SET NULL;
ALTER TABLE raw_dwc.collembolos_registros ADD COLUMN cd_event int REFERENCES main.event(cd_event);

UPDATE raw_dwc.collembolos_event AS t
SET cd_event=e.cd_event
FROM main.event e
WHERE 'cole_'||t.event_id=e.event_id;

UPDATE raw_dwc.collembolos_registros AS t
SET cd_event=e.cd_event
FROM main.event e
WHERE 'cole_'||t.event_id=e.event_id;

SELECT true;
```

Acá las fechas/horas inicial y final son siempre limpias... 


## registros


```{sql}
SELECT occurrence_id, count(*)
FROM raw_dwc.collembolos_registros 
GROUP BY occurrence_id
HAVING count(*)>1;
```


Parece que la fechas y horas en registros están bien!


```{sql}
SELECT e.event_id, e.event_date, r.event_date, e.event_time, r.event_time
FROM raw_dwc.collembolos_registros r
LEFT JOIN raw_dwc.collembolos_event e USING(cd_event)
ORDER BY r.event_date::date, r.event_time::time

```



```{sql}

INSERT INTO main.registros(cd_event, cds_recorded_by, date_time, cd_tax, cd_morfo, date_ident, cds_identified_by, qt_int,remarks, occurrence_id, organism_id)
SELECT 
 cd_event,
 cds_recorded_by,
 (event_date||' '||event_time)::timestamp date_time,
 tt.cd_tax,
 tt.cd_morfo,
 TO_DATE(date_identified,'YYYY-MM-DD') date_ident,
 cds_identified_by,
 organism_quantity::double precision::int qt_int,
 r.event_remarks,
 occurrence_id,
 SPLIT_PART(occurrence_id,':',7) organism_id
 --ROW_NUMBER() OVER (ORDER BY (e.date_time_begin::date||' '||event_time)::timestamp)
 --organism_id::text
FROM raw_dwc.collembolos_registros r
LEFT JOIN raw_dwc.taxonomy_total tt ON tt."row.names"=r."row.names" AND tt.table_orig='collembolos_registros'
LEFT JOIN main.event e USING (cd_event)
ORDER BY date_time
RETURNING cd_event, cds_recorded_by, date_time, cd_tax, cd_morfo, cds_identified_by, qt_int,remarks, occurrence_id, organism_id
```

```{sql}
ALTER TABLE raw_dwc.collembolos_registros ADD COLUMN cd_reg int REFERENCES main.registros(cd_reg);
UPDATE raw_dwc.collembolos_registros AS ar
SET cd_reg=r.cd_reg
FROM main.registros r
WHERE ar.cd_event=r.cd_event AND ar.occurrence_id=r.occurrence_id;

-- Check cd_reg are unique in the source table
SELECT cd_reg,count(*) FROM  raw_dwc.collembolos_registros GROUP BY cd_reg HAVING count(*)>1;
```


# Aves

Para entender el plan de muestreo

Para aves (y para mamiferos), existen eventos particulares que no entran en el plan de muestreo...


```{sql}
SELECT occurrence_id event_id,sampling_protocol
FROM raw_dwc.aves_event
WHERE occurrence_id !~'^ANH_[0-9]{1,3}_A(_(P[123]))?_R[0-9]{1,2}_T[12]'
```

```{sql}
WITH a AS(
SELECT occurrence_id,
  CASE
    WHEN occurrence_id ~ '^ANH_([0-9]{1,3})_.*$' THEN REGEXP_REPLACE(occurrence_id,'^ANH_([0-9]{1,3})_.*$','\1')
    ELSE NULL
  END anh_num,
  CASE 
    WHEN sampling_protocol ~ '[Rr]ecorrido' THEN 'recorrido'
    WHEN occurrence_id ~ '^ANH_[0-9]{1,3}_A(_(P[123]))?_R[0-9]{1,2}_T[12]' AND sampling_protocol ~ '[Nn]iebla' THEN 'niebla'
    WHEN occurrence_id ~ '^ANH_[0-9]{1,3}_A(_(P[123]))?_R[0-9]{1,2}_T[12]' AND sampling_protocol ~ '[Pp]unto [Ff]ijo' THEN 'punto fijo'
    ELSE 'accidental'
  END metodo,
  CASE
    WHEN sampling_protocol ~ '[Pp]unto [Ff]ijo' THEN REGEXP_REPLACE(occurrence_id,'^ANH_([0-9]{1,3})_A(_(P[123]))?_R([0-9]{1,2})_(T[12])','\3')
    ELSE NULL
  END punto,
  CASE
    WHEN occurrence_id ~ '^ANH_[0-9]{1,3}_A(_(P[123]))?_R[0-9]{1,2}_T[12]' THEN REGEXP_REPLACE(occurrence_id,'^ANH_([0-9]{1,3})_A(_(P[123]))?_R([0-9]{1,2})_(T[12])','\4')::int
    ELSE NULL
  END repli,
  UNNEST(REGEXP_MATCH(occurrence_id,'^.*(T[12])$')) tempo
FROM raw_dwc.aves_event
)
SELECT anh_num, tempo, ARRAY_AGG(DISTINCT metodo ORDER BY metodo),  count(*)
FROM a
GROUP BY anh_num, tempo
;

```

```{sql}
WITH a AS(
SELECT occurrence_id,
  CASE
    WHEN occurrence_id ~ '^ANH_([0-9]{1,3})_.*$' THEN REGEXP_REPLACE(occurrence_id,'^ANH_([0-9]{1,3})_.*$','\1')::int
    ELSE NULL
  END anh_num,
  CASE 
    WHEN sampling_protocol ~ '[Rr]ecorrido' THEN 'recorrido'
    WHEN occurrence_id ~ '^ANH_[0-9]{1,3}_A(_(P[123]))?_R[0-9]{1,2}_T[12]' AND sampling_protocol ~ '[Nn]iebla' THEN 'niebla'
    WHEN occurrence_id ~ '^ANH_[0-9]{1,3}_A(_(P[123]))?_R[0-9]{1,2}_T[12]' AND sampling_protocol ~ '[Pp]unto [Ff]ijo' THEN 'punto fijo'
    ELSE 'accidental'
  END metodo,
  CASE
    WHEN sampling_protocol ~ '[Pp]unto [Ff]ijo' THEN REGEXP_REPLACE(occurrence_id,'^ANH_([0-9]{1,3})_A(_(P[123]))?_R([0-9]{1,2})_(T[12])','\3')
    ELSE NULL
  END punto,
  CASE
    WHEN occurrence_id ~ '^ANH_[0-9]{1,3}_A(_(P[123]))?_R[0-9]{1,2}_T[12]' THEN REGEXP_REPLACE(occurrence_id,'^ANH_([0-9]{1,3})_A(_(P[123]))?_R([0-9]{1,2})_(T[12])','\4')::int
    ELSE NULL
  END repli,
  UNNEST(REGEXP_MATCH(occurrence_id,'^.*(T[12])$')) tempo
FROM raw_dwc.aves_event
)
SELECT anh_num, tempo,metodo, ARRAY_AGG(DISTINCT repli ORDER BY repli) repli,  count(*)
FROM a
GROUP BY anh_num, tempo, metodo
ORDER BY anh_num,tempo, metodo
;

```




## ANH

* **utilizar occurrenceID para el eventID puede ser muy confuso cuando este juego de datos vaya a pasar a las bases de datos internacionales como GBIF, debería ser eventID**

Insertar los datos de anh:

```{sql}
INSERT INTO main.punto_referencia(name_pt_ref, num_anh)
WITH a AS(
SELECT
  REGEXP_REPLACE(occurrence_id,'^ANH_([0-9]{1,3}).*$','\1')::int anh_num,
  REGEXP_REPLACE(occurrence_id,'^(ANH_[0-9]{1,3}).*$','\1') anh_name
FROM raw_dwc.aves_event
WHERE occurrence_id ~ '^ANH_([0-9]{1,3})'
)
SELECT anh_name, anh_num
FROM a
GROUP BY anh_name,anh_num
ORDER BY anh_num
ON CONFLICT (name_pt_ref) DO NOTHING
RETURNING cd_pt_ref, name_pt_ref
;
```

dar las referencias en las tablas de aves

```{sql}
ALTER TABLE raw_dwc.aves_event ADD COLUMN cd_pt_ref int REFERENCES main.punto_referencia(cd_pt_ref) ON DELETE SET NULL ON UPDATE CASCADE;
ALTER TABLE raw_dwc.aves_registros ADD COLUMN cd_pt_ref int REFERENCES main.punto_referencia(cd_pt_ref) ON DELETE SET NULL ON UPDATE CASCADE;

UPDATE raw_dwc.aves_event
SET cd_pt_ref=pr.cd_pt_ref
FROM main.punto_referencia pr
WHERE REGEXP_REPLACE(occurrence_id,'^(ANH_[0-9]{1,3}).*$','\1') = name_pt_ref
;

UPDATE raw_dwc.aves_registros
SET cd_pt_ref=pr.cd_pt_ref
FROM main.punto_referencia pr
WHERE  REGEXP_REPLACE(event_id,'^(ANH_[0-9]{1,3}).*$','\1') = name_pt_ref
;

SELECT true;
```

Averiguando que ninguna fila no tenga anh

```{sql}
SELECT occurrence_id FROM raw_dwc.aves_event WHERE cd_pt_ref IS NULL;
```

```{sql}
SELECT occurrence_id,event_id FROM raw_dwc.aves_registros WHERE cd_pt_ref IS NULL;
```

## Unit, sampling efforts definition, abundance definition, protocolo

```{sql}
INSERT INTO main.def_var_samp_eff(var_samp_eff, var_samp_eff_spa, cd_unit,type_variable)
VALUES(
  'Trap area',
  'Superficie de la trampa',
  (SELECT cd_unit FROM main.def_unit WHERE cd_measurement_type=(SELECT cd_measurement_type FROM main.def_measurement_type WHERE measurement_type='area') AND unit='Square meter'),
  'double precision'
  )
RETURNING cd_var_samp_eff, var_samp_eff ;
```

```{sql}
INSERT INTO main.def_protocol(protocol,protocol_spa,cd_var_samp_eff_1,cd_var_samp_eff_2,samp_eff_1_implicit,samp_eff_2_implicit,cd_var_ind_qt,description_spa)
VALUES(
  'Mist nets',
  'Redes de niebla',
  (SELECT cd_var_samp_eff FROM main.def_var_samp_eff WHERE var_samp_eff='Trap area'),
  (SELECT cd_var_samp_eff FROM main.def_var_samp_eff WHERE var_samp_eff='Elapsed time'),
  false,
  false,
  (SELECT cd_var_ind_qt FROM main.def_var_ind_qt WHERE var_qt_ind='Number of individuals'),
  NULL
),(
  'Bird point count',
  'Punto fijo',
  (SELECT cd_var_samp_eff FROM main.def_var_samp_eff WHERE var_samp_eff='Elapsed time'),
  NULL,
  true,
  NULL,
  (SELECT cd_var_ind_qt FROM main.def_var_ind_qt WHERE var_qt_ind='Number of individuals'),
  NULL
),(
  'Free transect',
  'Recorrido libre',
  (SELECT cd_var_samp_eff FROM main.def_var_samp_eff WHERE var_samp_eff='Covered distance'),
  (SELECT cd_var_samp_eff FROM main.def_var_samp_eff WHERE var_samp_eff='Elapsed time'),
  false,
  false,
  (SELECT cd_var_ind_qt FROM main.def_var_ind_qt WHERE var_qt_ind='Number of individuals'),
  NULL
),(
  'Accidental encounter',
  'Encuentro accidental',
  NULL,
  NULL,
  NULL,
  NULL,
  (SELECT cd_var_ind_qt FROM main.def_var_ind_qt WHERE var_qt_ind='Number of individuals'),
  'Puede representar encuentros de individuos en eventos de muestreos pensados para otros grupos biologicos, o encuentros accidentales fuera de todo evento de muestreo'
)
RETURNING cd_protocol,protocol,protocol_spa;
```

## Personas

```{sql}
INSERT INTO main.people(verbatim_person)
WITH a AS(
SELECT DISTINCT INITCAP(TRIM(UNNEST(STRING_TO_ARRAY(recorded_by, ' | ')))) AS name_person
FROM raw_dwc.aves_registros
UNION
SELECT DISTINCT INITCAP(TRIM(UNNEST(STRING_TO_ARRAY(identified_by, ' | '))))
FROM raw_dwc.aves_registros
)
SELECT DISTINCT REGEXP_REPLACE(name_person, '- ','-')
FROM a 
ORDER BY REGEXP_REPLACE(name_person, '- ','-')
ON CONFLICT(verbatim_person) DO NOTHING
RETURNING cd_person, verbatim_person
```

Dar los codigos a las tables de origen:

```{sql}
ALTER TABLE raw_dwc.aves_registros ADD COLUMN cds_recorded_by int[];

WITH a AS(
SELECT "row.names", REGEXP_REPLACE(INITCAP(TRIM(UNNEST(STRING_TO_ARRAY(recorded_by, ' | ')))),'- ','-') AS name_person
FROM raw_dwc.aves_registros
),b AS(
SELECT "row.names", ARRAY_AGG(cd_person) cds
FROM a 
LEFT JOIN main.people p ON a.name_person=p.verbatim_person
GROUP BY "row.names"
)
UPDATE raw_dwc.aves_registros AS r
SET cds_recorded_by=b.cds
FROM b
WHERE r."row.names"=b."row.names"
RETURNING r."row.names", cds_recorded_by
;

ALTER TABLE raw_dwc.aves_registros ADD COLUMN cds_identified_by int[];

WITH a AS(
SELECT "row.names", REGEXP_REPLACE(INITCAP(TRIM(UNNEST(STRING_TO_ARRAY(identified_by, ' | ')))),'- ','-') AS name_person
FROM raw_dwc.aves_registros
),b AS(
SELECT "row.names", ARRAY_AGG(cd_person) cds
FROM a 
LEFT JOIN main.people p ON a.name_person=p.verbatim_person
GROUP BY "row.names"
)
UPDATE raw_dwc.aves_registros AS r
SET cds_identified_by=b.cds
FROM b
WHERE r."row.names"=b."row.names"
RETURNING r."row.names", cds_identified_by
;

SELECT 1;
```

## gp_event

```{sql}
WITH a AS(
SELECT 
  occurrence_id,
  CASE
    WHEN occurrence_id ~ '^ANH_([0-9]{1,3})_.*$' THEN REGEXP_REPLACE(occurrence_id,'^ANH_([0-9]{1,3})_.*$','\1')::int
    ELSE NULL
  END anh_num,
  CASE 
    WHEN sampling_protocol ~ '[Rr]ecorrido' THEN 'recorrido'
    WHEN occurrence_id ~ '^ANH_[0-9]{1,3}_A(_(P[123]))?_R[0-9]{1,2}_T[12]' AND sampling_protocol ~ '[Nn]iebla' THEN 'niebla'
    WHEN occurrence_id ~ '^ANH_[0-9]{1,3}_A(_(P[123]))?_R[0-9]{1,2}_T[12]' AND sampling_protocol ~ '[Pp]unto [Ff]ijo' THEN 'punto fijo'
    ELSE 'accidental'
  END metodo,
  CASE
    WHEN sampling_protocol ~ '[Pp]unto [Ff]ijo' THEN REGEXP_REPLACE(occurrence_id,'^ANH_([0-9]{1,3})_A(_(P[123]))?_R([0-9]{1,2})_(T[12])','\3')
    ELSE NULL
  END punto,
  CASE
    WHEN occurrence_id ~ '^ANH_[0-9]{1,3}_A(_(P[123]))?_R[0-9]{1,2}_T[12]' THEN REGEXP_REPLACE(occurrence_id,'^ANH_([0-9]{1,3})_A(_(P[123]))?_R([0-9]{1,2})_(T[12])','\4')::int
    ELSE NULL
  END repli,
  UNNEST(REGEXP_MATCH(occurrence_id,'^.*(T[12])$')) tempo
FROM raw_dwc.aves_event
)
SELECT tempo, anh_num,metodo, ARRAY_AGG(repli), count(*)
FROM a
GROUP BY tempo, anh_num, metodo
ORDER BY tempo, anh_num, metodo
;
```

Because there is more than a method, the number of the campaign should be determined this way:

```{sql}
WITH a AS(
SELECT 
  occurrence_id,
  CASE
    WHEN occurrence_id ~ '^ANH_([0-9]{1,3})_.*$' THEN REGEXP_REPLACE(occurrence_id,'^ANH_([0-9]{1,3})_.*$','\1')::int
    ELSE NULL
  END anh_num,
  CASE 
    WHEN sampling_protocol ~ '[Rr]ecorrido' THEN 'recorrido'
    WHEN occurrence_id ~ '^ANH_[0-9]{1,3}_A(_(P[123]))?_R[0-9]{1,2}_T[12]' AND sampling_protocol ~ '[Nn]iebla' THEN 'niebla'
    WHEN occurrence_id ~ '^ANH_[0-9]{1,3}_A(_(P[123]))?_R[0-9]{1,2}_T[12]' AND sampling_protocol ~ '[Pp]unto [Ff]ijo' THEN 'punto fijo'
    ELSE 'accidental'
  END metodo,
  CASE
    WHEN sampling_protocol ~ '[Pp]unto [Ff]ijo' THEN REGEXP_REPLACE(occurrence_id,'^ANH_([0-9]{1,3})_A(_(P[123]))?_R([0-9]{1,2})_(T[12])','\3')
    ELSE NULL
  END punto,
  CASE
    WHEN occurrence_id ~ '^ANH_[0-9]{1,3}_A(_(P[123]))?_R[0-9]{1,2}_T[12]' THEN REGEXP_REPLACE(occurrence_id,'^ANH_([0-9]{1,3})_A(_(P[123]))?_R([0-9]{1,2})_(T[12])','\4')::int
    ELSE NULL
  END repli,
  UNNEST(REGEXP_MATCH(occurrence_id,'^.*(T[12])$')) tempo
FROM raw_dwc.aves_event
)
SELECT tempo, anh_num, ROW_NUMBER() OVER (PARTITION BY anh_num ORDER BY tempo) campaign_nb
FROM a
GROUP BY tempo, anh_num
ORDER BY tempo, anh_num
;
```


```{sql}
INSERT INTO main.gp_event(cd_gp_biol,cd_protocol,cd_pt_ref,campaign_nb, subpart)
WITH a AS(
SELECT 
  occurrence_id,
  CASE
    WHEN occurrence_id ~ '^ANH_([0-9]{1,3})_.*$' THEN REGEXP_REPLACE(occurrence_id,'^ANH_([0-9]{1,3})_.*$','\1')::int
    ELSE NULL
  END anh_num,
  CASE 
    WHEN sampling_protocol ~ '[Rr]ecorrido' THEN 'recorrido'
    WHEN occurrence_id ~ '^ANH_[0-9]{1,3}_A(_(P[123]))?_R[0-9]{1,2}_T[12]' AND sampling_protocol ~ '[Nn]iebla' THEN 'niebla'
    WHEN occurrence_id ~ '^ANH_[0-9]{1,3}_A(_(P[123]))?_R[0-9]{1,2}_T[12]' AND sampling_protocol ~ '[Pp]unto [Ff]ijo' THEN 'punto fijo'
    ELSE 'accidental'
  END metodo,
  CASE
    WHEN sampling_protocol ~ '[Pp]unto [Ff]ijo' THEN REGEXP_REPLACE(occurrence_id,'^ANH_([0-9]{1,3})_A(_(P[123]))?_R([0-9]{1,2})_(T[12])','\3')
    ELSE NULL
  END punto,
  CASE
    WHEN occurrence_id ~ '^ANH_[0-9]{1,3}_A(_(P[123]))?_R[0-9]{1,2}_T[12]' THEN REGEXP_REPLACE(occurrence_id,'^ANH_([0-9]{1,3})_A(_(P[123]))?_R([0-9]{1,2})_(T[12])','\4')::int
    ELSE NULL
  END repli,
  UNNEST(REGEXP_MATCH(occurrence_id,'^.*(T[12])$')) tempo,
  cd_pt_ref
FROM raw_dwc.aves_event
), campaign AS(
SELECT tempo, anh_num, ROW_NUMBER() OVER (PARTITION BY anh_num ORDER BY tempo) campaign_nb
FROM a
GROUP BY tempo, anh_num
ORDER BY tempo, anh_num
)
SELECT 'aves',
  CASE
    WHEN metodo='punto fijo' THEN (SELECT cd_protocol FROM main.def_protocol WHERE protocol='Bird point count')
    WHEN metodo='niebla' THEN (SELECT cd_protocol FROM main.def_protocol WHERE protocol='Mist nets')
    WHEN metodo='recorrido' THEN (SELECT cd_protocol FROM main.def_protocol WHERE protocol='Free transect')
    WHEN metodo='accidental' THEN (SELECT cd_protocol FROM main.def_protocol WHERE protocol='Accidental encounter')
  END cd_protocol,
  cd_pt_ref,
  c.campaign_nb,
  punto
FROM a
LEFT JOIN campaign c ON c.tempo=a.tempo AND (c.anh_num=a.anh_num OR (c.anh_num IS NULL AND a.anh_num IS NULL))
LEFT JOIN main.punto_referencia USING (cd_pt_ref)
GROUP BY cd_pt_ref, name_pt_ref, a.tempo, metodo, c.campaign_nb, punto
ORDER BY a.tempo,cd_pt_ref,cd_protocol,punto
RETURNING cd_gp_event,cd_gp_biol,cd_protocol,cd_pt_ref,campaign_nb,subpart
;
```

Attributing the gp_event

```{sql}
ALTER TABLE raw_dwc.aves_event ADD COLUMN cd_gp_event int REFERENCES main.gp_event(cd_gp_event) ON DELETE SET NULL;


WITH a AS(
SELECT 
  occurrence_id,
  CASE
    WHEN occurrence_id ~ '^ANH_([0-9]{1,3})_.*$' THEN REGEXP_REPLACE(occurrence_id,'^ANH_([0-9]{1,3})_.*$','\1')::int
    ELSE NULL
  END anh_num,
  CASE 
    WHEN sampling_protocol ~ '[Rr]ecorrido' THEN 'recorrido'
    WHEN occurrence_id ~ '^ANH_[0-9]{1,3}_A(_(P[123]))?_R[0-9]{1,2}_T[12]' AND sampling_protocol ~ '[Nn]iebla' THEN 'niebla'
    WHEN occurrence_id ~ '^ANH_[0-9]{1,3}_A(_(P[123]))?_R[0-9]{1,2}_T[12]' AND sampling_protocol ~ '[Pp]unto [Ff]ijo' THEN 'punto fijo'
    ELSE 'accidental'
  END metodo,
  CASE
    WHEN sampling_protocol ~ '[Pp]unto [Ff]ijo' THEN REGEXP_REPLACE(occurrence_id,'^ANH_([0-9]{1,3})_A(_(P[123]))?_R([0-9]{1,2})_(T[12])','\3')
    ELSE NULL
  END punto,
  CASE
    WHEN occurrence_id ~ '^ANH_[0-9]{1,3}_A(_(P[123]))?_R[0-9]{1,2}_T[12]' THEN REGEXP_REPLACE(occurrence_id,'^ANH_([0-9]{1,3})_A(_(P[123]))?_R([0-9]{1,2})_(T[12])','\4')::int
    ELSE NULL
  END repli,
  UNNEST(REGEXP_MATCH(occurrence_id,'^.*(T[12])$')) tempo,
  cd_pt_ref
FROM raw_dwc.aves_event
), campaign AS(
SELECT tempo, anh_num, ROW_NUMBER() OVER (PARTITION BY anh_num ORDER BY tempo) campaign_nb
FROM a
GROUP BY tempo, anh_num
ORDER BY tempo, anh_num
),b AS(
SELECT occurrence_id,
  CASE
    WHEN metodo='punto fijo' THEN (SELECT cd_protocol FROM main.def_protocol WHERE protocol='Bird point count')
    WHEN metodo='niebla' THEN (SELECT cd_protocol FROM main.def_protocol WHERE protocol='Mist nets')
    WHEN metodo='recorrido' THEN (SELECT cd_protocol FROM main.def_protocol WHERE protocol='Free transect')
    WHEN metodo='accidental' THEN (SELECT cd_protocol FROM main.def_protocol WHERE protocol='Accidental encounter')
  END cd_protocol,
  cd_pt_ref,
  c.campaign_nb,
  a.punto
FROM a
LEFT JOIN campaign c ON c.tempo=a.tempo AND (c.anh_num=a.anh_num OR (c.anh_num IS NULL AND a.anh_num IS NULL))
LEFT JOIN main.punto_referencia USING (cd_pt_ref)
),d AS(
SELECT b.*, cd_gp_event
FROM b
LEFT JOIN main.gp_event ge ON cd_gp_biol='aves' AND b.cd_protocol=ge.cd_protocol AND ((b.cd_pt_ref=ge.cd_pt_ref) OR (b.cd_pt_ref IS NULL AND ge.cd_pt_ref IS NULL)) AND b.campaign_nb=ge.campaign_nb AND ((b.punto=ge.subpart) OR (b.punto IS NULL AND ge.subpart IS NULL))
)
UPDATE raw_dwc.aves_event e
SET cd_gp_event=d.cd_gp_event
FROM d
WHERE d.occurrence_id=e.occurrence_id
RETURNING e.occurrence_id, e.cd_gp_event
;
```

## event
**Note los sampling effort no corresponden en termino de tiempo a lo que hay en las fechas/horas inicial y final**
Eso es verdad tanto para las redes de niebla que para los recorridos.
Es muy posible que en el caso de las redes de niebla, sea un calculo un poco complejo en funcion del numero de trampas

\footnotesize

```{sql}
INSERT INTO main.event(cd_gp_event,event_id,num_replicate, description_replicate, date_time_begin, date_time_end, locality_verb, event_remarks, samp_effort_1, samp_effort_2, pt_geom)
WITH a AS(
SELECT cd_gp_event,
  occurrence_id, 
  CASE
    WHEN occurrence_id ~ '^ANH_[0-9]{1,3}_A(_(P[123]))?_R[0-9]{1,2}_T[12]' THEN REGEXP_REPLACE(occurrence_id,'^ANH_([0-9]{1,3})_A(_(P[123]))?_R([0-9]{1,2})_(T[12])','\4')::int
    ELSE NULL
  END repli,
  TO_DATE(SPLIT_PART(event_date,'/',1), 'YYYY-MM-DD') date_1,
  CASE 
    WHEN SPLIT_PART(event_date,'/',2)='' THEN NULL
    ELSE TO_DATE(SPLIT_PART(event_date,'/',2), 'YYYY-MM-DD')
  END date_2,
  REGEXP_REPLACE(SPLIT_PART(event_time,'/',1),'\s+','','g') hora_1,
  CASE
  	WHEN REGEXP_REPLACE(SPLIT_PART(event_time,'/',2),'\s+','','g')='' THEN NULL
	ELSE REGEXP_REPLACE(SPLIT_PART(event_time,'/',2),'\s+','','g')
  END hora_2,
  locality locality_verb,
  --sample_size_value,
  sampling_size_value,
  sampling_size_unit,
  sampling_effort,
  event_remarks,
  --locality_remarks,
  decimal_latitude::double precision,
  decimal_longitude::double precision
FROM raw_dwc.aves_event
),b AS(--calculation of timestamps, coordinates and num_replicate
SELECT 
  cd_gp_event,
  occurrence_id, 
  ROW_NUMBER() OVER (PARTITION BY cd_gp_event ORDER BY repli) num_replicate,
  'R'||repli description_replicate,
  CASE
    WHEN date_1 IS NULL OR hora_1 IS NULL THEN NULL
    ELSE (date_1||' '||hora_1)::timestamp 
  END date_time_begin,
  CASE
    WHEN hora_2 IS NULL THEN NULL
    WHEN date_2 IS NULL AND (date_1||' '||hora_2)::timestamp::time='00:00'::time THEN ((date_1::date)+1 ||' '||hora_2)::timestamp
    WHEN date_2 IS NULL AND (date_1||' '||hora_2)::timestamp::time!='00:00'::time THEN (date_1||' '||hora_2)::timestamp
    ELSE (date_2||' '||hora_2)::timestamp
  END date_time_end,
  locality_verb,
  event_remarks ,
  sampling_size_value,
  sampling_size_unit,
  sampling_effort,
  ST_SetSRID(ST_Transform(ST_SetSRID(ST_MakePoint(decimal_longitude,decimal_latitude),4326),(SELECT proj4text FROM spatial_ref_sys WHERE srid=3116)),3116) pt_geom
FROM a
LEFT JOIN main.gp_event USING (cd_gp_event)
LEFT JOIN main.def_protocol p USING (cd_protocol)
ORDER BY cd_gp_event, occurrence_id, num_replicate
)--calculation of sampling efforts
SELECT
  cd_gp_event,
  'aves_'||occurrence_id occurrence_id,
  num_replicate,
  description_replicate,
  date_time_begin,
  date_time_end,
  locality_verb,
  event_remarks,
  CASE
   WHEN protocol='Bird point count' THEN sampling_size_value::double precision
   WHEN protocol='Mist nets' THEN NULL -- to check later
   WHEN protocol='Free transect' AND sampling_size_unit='Kilometros' THEN (sampling_size_value::double precision)*1000
   WHEN protocol='Free transect' AND sampling_size_unit='Metros' THEN (sampling_size_value::double precision)
   ELSE NULL
  END samp_eff_1,
  CASE
   WHEN protocol='Mist nets' THEN sampling_size_value::double precision*60 -- to check later
   WHEN protocol='Free transect' AND sampling_effort ~ 'en [0-9]+ ?min' THEN REGEXP_REPLACE(sampling_effort, '^.*en ([0-9]+) ?min.*$','\1')::int   
   WHEN protocol='Free transect' AND sampling_effort !~ 'en [0-9]+ ?min' THEN EXTRACT(EPOCH FROM(date_time_end-date_time_begin))/60
   ELSE NULL
  END samp_eff_2,
  pt_geom
FROM b
LEFT JOIN main.gp_event USING (cd_gp_event)
LEFT JOIN main.def_protocol p USING (cd_protocol)
ORDER BY cd_gp_event, occurrence_id, num_replicate

RETURNING main.event.cd_event, main.event.cd_gp_event, main.event.event_id, main.event.num_replicate, main.event.description_replicate, main.event.date_time_begin, main.event.date_time_end, main.event.locality_verb, main.event.event_remarks, main.event.pt_geom
```

Damos los cd_event a todos las filas:

```{sql}
ALTER TABLE raw_dwc.aves_event ADD COLUMN cd_event int REFERENCES main.event(cd_event) ON DELETE SET NULL;
ALTER TABLE raw_dwc.aves_registros ADD COLUMN cd_event int REFERENCES main.event(cd_event);

UPDATE raw_dwc.aves_event AS t
SET cd_event=e.cd_event
FROM main.event e
WHERE 'aves_'||t.occurrence_id=e.event_id;

UPDATE raw_dwc.aves_registros AS t
SET cd_event=e.cd_event
FROM main.event e
WHERE 'aves_'||t.event_id=e.event_id;

SELECT true;
```

Acá las fechas/horas inicial y final son siempre limpias... 


## registros


```{sql}
SELECT occurrence_id, count(*)
FROM raw_dwc.aves_registros 
GROUP BY occurrence_id
HAVING count(*)>1;
```


**Parece que la fechas y horas en registros correspondan usualmente a la fechas y horas iniciales de los eventos, tambien en algunos casos falta la hora**


```{sql}
SELECT e.occurrence_id, e.event_date, r.event_date, e.event_time, r.event_time
FROM raw_dwc.aves_registros r
LEFT JOIN raw_dwc.aves_event e USING(cd_event)
ORDER BY r.event_date::date, r.event_time::time

```



```{sql}
INSERT INTO main.registros(cd_event, cds_recorded_by, date_time, cd_tax, cd_morfo, date_ident, cds_identified_by, qt_int,remarks, occurrence_id, organism_id)
SELECT 
 cd_event,
 cds_recorded_by,
 CASE 
   WHEN event_date IS NULL OR event_time IS NULL THEN NULL
   ELSE (event_date||' '||event_time)::timestamp 
 END date_time,
 tt.cd_tax,
 tt.cd_morfo,
 TO_DATE(date_identified,'YYYY-MM-DD') date_ident,
 cds_identified_by,
 organism_quantity::double precision::int qt_int,
 r.event_remarks,
 r.occurrence_id,
 --SPLIT_PART(occurrence_id,':',7) organism_id
 --ROW_NUMBER() OVER (ORDER BY (e.date_time_begin::date||' '||event_time)::timestamp)
 organism_id::text
 --ST_SetSRID(ST_Transform(ST_SetSRID(ST_MakePoint(measurement_value__longitud_,measurement_value__latitud_), 4326),  (SELECT proj4text FROM spatial_ref_sys WHERE srid=3116)),3116)
FROM raw_dwc.aves_registros r
LEFT JOIN raw_dwc.taxonomy_total tt ON tt."row.names"=r."row.names" AND tt.table_orig='aves_registros'
LEFT JOIN main.event e USING (cd_event)
ORDER BY date_time
RETURNING cd_event, cds_recorded_by, date_time, cd_tax, cd_morfo, cds_identified_by, qt_int,remarks, occurrence_id, organism_id
```

```{sql}
ALTER TABLE raw_dwc.aves_registros ADD COLUMN cd_reg int REFERENCES main.registros(cd_reg);
UPDATE raw_dwc.aves_registros AS ar
SET cd_reg=r.cd_reg
FROM main.registros r
WHERE ar.cd_event=r.cd_event AND ar.occurrence_id=r.occurrence_id;

-- Check cd_reg are unique in the source table
SELECT cd_reg,count(*) FROM  raw_dwc.aves_registros GROUP BY cd_reg HAVING count(*)>1;
```


### Añadir la información temporal supplementaria

```{sql}
INSERT INTO main.def_var_registros_extra(var_registros_extra, type_var, var_registros_extra_spa, var_registros_extra_comment)
VALUES
  ('date_registro',
  'free text',
  'fecha_registro',
  'En algunos casos (p.ej aves), solo la fecha (sin tiempo) es dada para los registros. En este case el date_time es NULL, y devemos dar la fecha como variable extra (texto) el formato es YYYY-MM-DD HH:MI:SS'
  );

INSERT INTO main.registros_extra(cd_reg,cd_var_registros_extra,value_text)
SELECT cd_reg,
(SELECT cd_var_registros_extra FROM main.def_var_registros_extra WHERE var_registros_extra='date_registro'),
event_date::timestamp::text
FROM raw_dwc.aves_registros
WHERE event_time IS NULL OR event_time='';
```


# Mamiferos 

## Crear la tabla total de eventos

Antes de poder tratar de manera eficiente los datos de mamiferos, necesitamos ver si es posible asociar los datos de ultrasonidos con los datos clasicos de mamiferos

```{sql}
WITH a AS(
SELECT table_name, column_name, ordinal_position, data_type
FROM information_schema.columns
WHERE table_name='mamiferos_event'
),b AS(
SELECT table_name, column_name, ordinal_position, data_type
FROM information_schema.columns
WHERE table_name='mamiferos_us_event'
)
SELECT column_name, ARRAY[a.table_name,b.table_name], ARRAY[a.data_type,b.data_type]
FROM a
FULL OUTER JOIN b USING (column_name)
ORDER BY COALESCE(a.ordinal_position,b.ordinal_position);
```

Associar las tablas de eventos (Anotar: yo no utilizo un VIEW acá, porque voy a necesitar añadir column más tarde):

*note: ver archivo <./meta_prog_asociacion_table.sql> para entender como crear el comando siguiente*

```{sql}
CREATE TABLE raw_dwc.mamiferos_tot_event AS(
SELECT 
 'mamiferos_event' AS table_orig,
 "row.names",
 "occurrence_id" AS event_id,
 NULL::text AS "parent_event_id",
 "basis_of_record",
 "sampling_size_value"::text AS sample_size_value,
 "sampling_size_unit" AS "sample_size_unit",
 "sampling_protocol",
 "sampling_effort",
 "event_date",
 "event_time",
 "habitat",
 "event_remarks",
 "continent",
 "country",
 "country_code",
 "state_province",
 "county",
 "locality",
 "minimum_elevation_in_meters",
 "maximum_elevation_in_meters",
 "verbatim_latitude",
 "verbatim_longitude",
 "verbatim_coordinate_system",
 "verbatim_srs",
 "decimal_latitude",
 "decimal_longitude",
 "geodetic_datum",
 "coordinate_uncertainty_in_meters",
 "identified_by",
 NULL::text AS "title",
 "measurement_type__plataforma_",
 NULL::text AS "type",
 NULL::text AS "format",
 "measurement_value__plataforma_",
 "measurement_type__distancia_",
 NULL::text AS "creator",
 NULL::text AS "created",
 "measurement_value__distancia_",
 "measurement_unit__distancia_",
 "measurement_type__tipo_de_palma_",
 "measurement_value__tipo_de_palma_",
 "measurement_type__edad_",
 "measurement_value__edad_",
 "measurement_type__altura_promedio_de_la_vegetación_",
 NULL::text AS "measurement_type__grupo_",
 NULL::text AS "measurement_value__grupo_",
 "measurement_value__altura_promedio_de_la_vegetación_",
 "measurement_unit__altura_promedio_de_la_vegetación_",
 "measurement_type__cobertura_del_dosel_índice_ca_co_",
 "measurement_value__cobertura_del_dosel_índice_ca_co_",
 "measurement_unit__cobertura_del_dosel_índice_ca_co_"
FROM raw_dwc.mamiferos_event
UNION ALL
SELECT 
  'mamiferos_us_event' AS table_orig,
   "row.names",
 "event_id",
 "parent_event_id",
 NULL::text AS "basis_of_record",
 "sample_size_value"::text,
 "sample_size_unit",
 "sampling_protocol",
 "sampling_effort",
 "event_date",
 "event_time",
 "habitat",
 "event_remarks",
 "continent",
 "country",
 "country_code",
 "state_province",
 "county",
 "locality",
 "minimum_elevation_in_meters",
 "maximum_elevation_in_meters",
 "verbatim_latitude",
 "verbatim_longitude",
 "verbatim_coordinate_system",
 "verbatim_srs",
 "decimal_latitude",
 "decimal_longitude",
 "geodetic_datum",
 "coordinate_uncertainty_in_meters",
 NULL::text AS "identified_by",
 "title",
 "measurement_type__plataforma_",
 "type",
 "format",
 "measurement_value__plataforma_",
 "measurement_type__distancia_",
 "creator",
 "created",
 "measurement_value__distancia_",
 "measurement_unit__distancia_",
 NULL::text AS "measurement_type__tipo_de_palma_",
 NULL::text AS "measurement_value__tipo_de_palma_",
 NULL::text AS "measurement_type__edad_",
 NULL::text AS "measurement_value__edad_",
 NULL::text AS "measurement_type__altura_promedio_de_la_vegetación_",
 "measurement_type__grupo_",
 "measurement_value__grupo_",
 NULL::text AS "measurement_value__altura_promedio_de_la_vegetación_",
 NULL::text AS "measurement_unit__altura_promedio_de_la_vegetación_",
 NULL::text AS "measurement_type__cobertura_del_dosel_índice_ca_co_",
 NULL::double precision AS "measurement_value__cobertura_del_dosel_índice_ca_co_",
 NULL::text AS "measurement_unit__cobertura_del_dosel_índice_ca_co_"
FROM raw_dwc.mamiferos_us_event
);

SELECT event_id,count(*)
FROM raw_dwc.mamiferos_tot_event
GROUP BY event_id
HAVING count(*)>1;
```

Podemos ver que, a pesar de esta asociación, los event_id son unicos en la tabla total.

## Crear la tabla total de registros


```{sql}
WITH a AS(
SELECT table_name, column_name, ordinal_position, data_type
FROM information_schema.columns
WHERE table_name='mamiferos_registros'
),b AS(
SELECT table_name, column_name, ordinal_position, data_type
FROM information_schema.columns
WHERE table_name='mamiferos_us_registros'
)
SELECT column_name, ARRAY[a.table_name,b.table_name], ARRAY[a.data_type,b.data_type]
FROM a
FULL OUTER JOIN b USING (column_name)
ORDER BY COALESCE(a.ordinal_position,b.ordinal_position);
```

```{sql}
CREATE TABLE raw_dwc.mamiferos_tot_registros AS(
SELECT 
 'mamiferos_registros' AS table_orig,
 "row.names",
 "occurrence_id",
 "event_id",
 "basis_of_record",
 "type",
 "institution_code",
 "collection_code",
 "catalog_number",
 "other_catalog_numbers",
 "dynamic_properties",
 "occurrence_remarks",
 "record_number",
 "recorded_by",
 "organism_id",
 "organism_quantity",
 organism_quantity_1 "organism_quantity_type",
 "sex",
 "life_stage",
 "reproductive_condition",
 "preparations",
 "sampling_protocol",
 "sampling_effort",
 "event_date",
 "event_time",
 "event_remarks",
 "scientific_name",
 "identification_qualifier",
 "kingdom",
 "phylum",
 "class",
 "order",
 "family",
 "genus",
 "specific_epithet",
 "taxon_rank",
 "identified_by",
 "date_identified",
 NULL::text AS "measurement_type__temperatura_",
 NULL::text AS "measurement_value__temperatura_",
 "scientific_name_authorship",
 "tipo_de_tejido",
 NULL::text AS "measurement_unit__temperatura_",
 "preparación_del_tejido",
 NULL::text AS "measurement_type__presión_sonora_n_",
 NULL::text AS "measurement_value__presión_sonora_n_",
 "colector_del_tejido",
 "código_del_tejido",
 NULL::text AS "measurement_unit__presión_sonora_n_",
 NULL::text AS "measurement_type__presión_sonora_s_",
 "title",
 "type_1",
 NULL::text AS "measurement_value__presión_sonora_s_",
 "format",
 NULL::text AS "measurement_unit__presión_sonora_s_",
 "creator",
 NULL::text AS "measurement_type__presión_sonora_e_",
 NULL::text AS "measurement_value__presión_sonora_e_",
 "created",
 "measurement_type__peso_",
 NULL::text AS "measurement_unit__presión_sonora_e_",
 NULL::text AS "measurement_type__presión_sonora_w_",
 "measurement_value__peso_",
 NULL::text AS "measurement_value__presión_sonora_w_",
 "measurement_unit__peso_",
 NULL::text AS "measurement_unit__presión_sonora_w_",
 "measurement_type__longitud_total_",
 "measurement_value__longitud_total_",
 "measurement_unit__longitud_total_",
 "measurement_type__longitud_cola_",
 "measurement_value__longitud_cola_",
 "measurement_unit__longitud_cola_",
 "measurement_type__longitud_oreja_",
 "measurement_value__longitud_oreja_",
 "measurement_unit__longitud_oreja_",
 "measurement_type__longitud_pata_",
 "measurement_value__longitud_pata_",
 "measurement_unit__longitud_pata_",
 "measurement_type__antebrazo_",
 "measurement_value__antebrazo_",
 "measurement_unit__antebrazo_",
 "measurement_type__envergadura_",
 "measurement_value__envergadura_",
 "measurement_unit__envergadura_"
FROM raw_dwc.mamiferos_registros
UNION ALL
SELECT 
 'mamiferos_us_registros' AS table_orig,
  "row.names",
 "occurrence_id",
 "event_id",
 "basis_of_record",
 "type",
 "institution_code",
 "collection_code",
 "catalog_number",
 "other_catalog_numbers",
 "dynamic_properties",
 "occurrence_remarks",
 "record_number",
 "recorded_by",
 NULL::text AS "organism_id",
 NULL::text AS "organism_quantity",
 NULL::text AS "organism_quantity_type",
 NULL::text AS "sex",
 NULL::text AS "life_stage",
 NULL::text AS "reproductive_condition",
 "preparations",
 "sampling_protocol",
 "sampling_effort",
 "event_date",
 "event_time",
 NULL::text AS "event_remarks",
 "scientific_name",
 "identification_qualifier",
 "kingdom",
 "phylum",
 "class",
 "order",
 "family",
 "genus",
 "specific_epithet",
 "taxon_rank",
 "identified_by",
 "date_identified",
 "measurement_type__temperatura_",
 "measurement_value__temperatura_",
 "scientific_name_authorship",
 NULL::text AS "tipo_de_tejido",
 "measurement_unit__temperatura_",
 NULL::text AS "preparación_del_tejido",
 "measurement_type__presión_sonora_n_",
 "measurement_value__presión_sonora_n_",
 NULL::text AS "colector_del_tejido",
 NULL::text AS "código_del_tejido",
 "measurement_unit__presión_sonora_n_",
 "measurement_type__presión_sonora_s_",
 "title",
 "type_1",
 "measurement_value__presión_sonora_s_",
 "format",
 "measurement_unit__presión_sonora_s_",
 "creator",
 "measurement_type__presión_sonora_e_",
 "measurement_value__presión_sonora_e_",
 "created",
 NULL::text AS "measurement_type__peso_",
 "measurement_unit__presión_sonora_e_",
 "measurement_type__presión_sonora_w_",
 NULL::text AS "measurement_value__peso_",
 "measurement_value__presión_sonora_w_",
 NULL::text AS "measurement_unit__peso_",
 "measurement_unit__presión_sonora_w_",
 NULL::text AS "measurement_type__longitud_total_",
 NULL::text AS "measurement_value__longitud_total_",
 NULL::text AS "measurement_unit__longitud_total_",
 NULL::text AS "measurement_type__longitud_cola_",
 NULL::text AS "measurement_value__longitud_cola_",
 NULL::text AS "measurement_unit__longitud_cola_",
 NULL::text AS "measurement_type__longitud_oreja_",
 NULL::double precision AS "measurement_value__longitud_oreja_",
 NULL::text AS "measurement_unit__longitud_oreja_",
 NULL::text AS "measurement_type__longitud_pata_",
 NULL::double precision AS "measurement_value__longitud_pata_",
 NULL::text AS "measurement_unit__longitud_pata_",
 NULL::text AS "measurement_type__antebrazo_",
 NULL::text AS "measurement_value__antebrazo_",
 NULL::text AS "measurement_unit__antebrazo_",
 NULL::text AS "measurement_type__envergadura_",
 NULL::text AS "measurement_value__envergadura_",
 NULL::text AS "measurement_unit__envergadura_"
FROM raw_dwc.mamiferos_us_registros
);
SELECT occurrence_id,count(*)
FROM raw_dwc.mamiferos_tot_registros
GROUP BY occurrence_id
HAVING count(*)>1;
```

Podemos ver que, a pesar de esta asociación, los occurrence_id son unicos en la tabla total.


## Entender el plan de muestreo


**Que hacemos con el event sin punto de referencia (ANH_M_CM_4_T2)?**
 
**Existen 3 eventos de pitfall en los mamiferos, pero la información sobre esos eventos es minima, no entiendo si vienen de pitfall de otros grupos (en aquellos casos se anota 'accidental' en la base de datos. Si se tratan de trampa pitfall especificas entonces se debe añadir el protocolo especifico en la base de datos.**


**No hay Sherman en 2022, averiguar que está bien**

**Averiguar que entendí bien lo que son los metodos menos representado**:

* Captura manual son eventos puntuales que puedo categorizar como accidental en el sentido que no hacen parte de un plan de muestreo a larga escala
* Pitfall vienen de planes de muestreo de otros grupos
* Busqueda por encuentros visuales vienen de herpetos
* Existen accidentales que vienen de las redes de niebla de los aves ('Redes de niebla' en lugar de 'Red niebla'
* Un evento 'Encuentro ' corresponde a un encuentro accidental
* Parece que hay grabaciones que no son de ultrasonidos, pero se describe en las variables extra de las grabaciones
* No separo las grabaciones en varios metodos (tal vez se justifica? automatico o no? us o no, etc.)

```{sql}
SELECT table_orig,event_id,sampling_protocol
FROM raw_dwc.mamiferos_tot_event
WHERE event_id!~'^ANH_[0-9]{1,3}_M_[RS][0-9]{1,3}(_T2)?$' AND event_id !~ '^ANH_[0-9]{1,3}_[0-9]{1,2}(_T2)?'
```

```{sql}
WITH a AS(
SELECT event_id,sampling_protocol,
 CASE
   WHEN event_id ~ '^ANH_[0-9]{1,3}_.*' THEN REGEXP_REPLACE(event_id,'^(ANH_[0-9]{1,3})_.*','\1')
   WHEN event_id ~ '^ANH_[0-9]{1,3}$' THEN event_id
   WHEN event_id ~ '[Hh]otel' THEN 'Hotel'
 END anh_name,
 CASE
   WHEN event_id ~ '^ANH_[0-9]{1,3}_.*' THEN REGEXP_REPLACE(event_id,'^ANH_([0-9]{1,3})_.*','\1')::int
   WHEN event_id ~ '^ANH_[0-9]{1,3}$' THEN REGEXP_REPLACE(event_id,'^ANH_([0-9]{1,3})$','\1')::int
   ELSE NULL
 END anh_num,
 CASE
   WHEN event_id ~ '^ANH_[0-9]{1,3}_M_[RS][0-9]{1,3}(_T2)?$' AND sampling_protocol='Red niebla' THEN 'niebla'
   WHEN event_id ~ '^ANH_[0-9]{1,3}_M_[RS][0-9]{1,3}(_T2)?$' AND sampling_protocol='Trampa Sherman' THEN 'sherman'
   WHEN sampling_protocol ~ '^Punto( de)? grabación' THEN 'grabación'
   WHEN event_id ~ 'Herp' OR event_id ~ '^ANH_[0-9]{1,3}_A_' THEN 'accidental (otro grupo)'
   WHEN sampling_protocol='Captura manual' THEN 'accidental' 
   WHEN sampling_protocol~'^Encuentro ?$' THEN 'accidental' 
   WHEN sampling_protocol='Trampa pitfall' THEN 'accidental (pitfall)'
 END metodo,
 CASE
   WHEN event_id ~ '^ANH_[0-9]{1,3}_M_[RS]([0-9]{1,3})(_T2)?$' THEN REGEXP_REPLACE(event_id,'^ANH_[0-9]{1,3}_M_[RS]([0-9]{1,3})(_T2)?$','\1')::int
   WHEN sampling_protocol ~ '^Punto( de)? grabación' AND event_id ~ '^ANH_[0-9]{1,3}_([0-9]{1,2})(_T2)?' THEN REGEXP_REPLACE(event_id,'^ANH_[0-9]{1,3}_([0-9]{1,2})(_T2)?','\1')::int
   WHEN event_id ~ '^Hotel_[0-9]' THEN REGEXP_REPLACE(event_id,'^Hotel_([0-9]).*','\1')::int
   WHEN event_id ~ 'ANH_[0-9]{1,3}_M_P_[0-9](_T2)?' THEN REGEXP_REPLACE(event_id, 'ANH_[0-9]{1,3}_M_P_([0-9])(_T2)?$', '\1')::int
   WHEN event_id ~ 'ANH_([0-9]{1,3}_)?M_CM_[0-9]_T2' THEN REGEXP_REPLACE(event_id, 'ANH_([0-9]{1,3}_)?M_CM_([0-9])(_T2)?$', '\2')::int
   ELSE NULL
 END repli,
 CASE
   WHEN event_id ~ 'T2$' THEN 'T2'
   ELSE 'T1'
 END tempo,
 EXTRACT(YEAR FROM (SPLIT_PART(event_date,'/',1)::date)) año
FROM raw_dwc.mamiferos_tot_event
)
SELECT  tempo, metodo,año,count(*)-- ARRAY_AGG(event_id)
FROM a
--WHERE NOT((tempo='T1' AND año=2021) OR (tempo='t2' AND año=2022))
GROUP BY tempo,año,metodo
ORDER BY tempo,metodo
;
```

```{sql}
WITH a AS(
SELECT event_id,
 CASE
   WHEN event_id ~ '^ANH_[0-9]{1,3}_.*' THEN REGEXP_REPLACE(event_id,'^(ANH_[0-9]{1,3})_.*','\1')
   WHEN event_id ~ '^ANH_[0-9]{1,3}$' THEN event_id
   WHEN event_id ~ '[Hh]otel' THEN 'Hotel'
 END anh_name,
 CASE
   WHEN event_id ~ '^ANH_[0-9]{1,3}_.*' THEN REGEXP_REPLACE(event_id,'^ANH_([0-9]{1,3})_.*','\1')::int
   WHEN event_id ~ '^ANH_[0-9]{1,3}$' THEN REGEXP_REPLACE(event_id,'^ANH_([0-9]{1,3})$','\1')::int
   ELSE NULL
 END anh_num,
 CASE
   WHEN event_id ~ '^ANH_[0-9]{1,3}_M_[RS][0-9]{1,3}(_T2)?$' AND sampling_protocol='Red niebla' THEN 'niebla'
   WHEN event_id ~ '^ANH_[0-9]{1,3}_M_[RS][0-9]{1,3}(_T2)?$' AND sampling_protocol='Trampa Sherman' THEN 'sherman'
   WHEN sampling_protocol ~ '^Punto( de)? grabación' THEN 'grabación'
   WHEN event_id ~ 'Herp' OR event_id ~ '^ANH_[0-9]{1,3}_A_' THEN 'accidental (otro grupo)'
   WHEN sampling_protocol='Captura manual' THEN 'accidental' 
   WHEN sampling_protocol~'^Encuentro ?$' THEN 'accidental' 
   WHEN sampling_protocol='Trampa pitfall' THEN 'accidental (pitfall)'
 END metodo,
 CASE
   WHEN event_id ~ '^ANH_[0-9]{1,3}_M_[RS]([0-9]{1,3})(_T2)?$' THEN REGEXP_REPLACE(event_id,'^ANH_[0-9]{1,3}_M_[RS]([0-9]{1,3})(_T2)?$','\1')::int
   WHEN sampling_protocol ~ '^Punto( de)? grabación' AND event_id ~ '^ANH_[0-9]{1,3}_([0-9]{1,2})(_T2)?' THEN REGEXP_REPLACE(event_id,'^ANH_[0-9]{1,3}_([0-9]{1,2})(_T2)?','\1')::int
   WHEN event_id ~ '^Hotel_[0-9]' THEN REGEXP_REPLACE(event_id,'^Hotel_([0-9]).*','\1')::int
   WHEN event_id ~ 'ANH_[0-9]{1,3}_M_P_[0-9](_T2)?' THEN REGEXP_REPLACE(event_id, 'ANH_[0-9]{1,3}_M_P_([0-9])(_T2)?$', '\1')::int
   WHEN event_id ~ 'ANH_([0-9]{1,3}_)?M_CM_[0-9]_T2' THEN REGEXP_REPLACE(event_id, 'ANH_([0-9]{1,3}_)?M_CM_([0-9])(_T2)?$', '\2')::int
   ELSE NULL
 END repli,
 CASE
   WHEN event_id ~ 'T2$' THEN 'T2'
   ELSE 'T1'
 END tempo

FROM raw_dwc.mamiferos_tot_event
)
SELECT anh_name,tempo,metodo, /*ARRAY_AGG(DISTINCT repli ORDER BY repli) repli,*/  count(*)
FROM a
GROUP BY anh_num,anh_name, tempo, metodo
ORDER BY anh_num IS NOT NULL,anh_num,tempo, metodo
;

```




## ANH


Anotar, 'Hotel' no es un anh, pero lo incluyo como punto de referencia

Insertar los datos de anh:

```{sql}
INSERT INTO main.punto_referencia(name_pt_ref, num_anh)
WITH a AS(
SELECT
 CASE
   WHEN event_id ~ '^ANH_[0-9]{1,3}_.*' THEN REGEXP_REPLACE(event_id,'^(ANH_[0-9]{1,3})_.*','\1')
   WHEN event_id ~ '^ANH_[0-9]{1,3}$' THEN event_id
   WHEN event_id ~ '[Hh]otel' THEN 'Hotel'
 END anh_name,
 CASE
   WHEN event_id ~ '^ANH_[0-9]{1,3}_.*' THEN REGEXP_REPLACE(event_id,'^ANH_([0-9]{1,3})_.*','\1')::int
   WHEN event_id ~ '^ANH_[0-9]{1,3}$' THEN REGEXP_REPLACE(event_id,'^ANH_([0-9]{1,3})$','\1')::int
   ELSE NULL
 END anh_num
FROM raw_dwc.mamiferos_tot_event
)
SELECT anh_name, anh_num
FROM a
WHERE anh_name IS NOT NULL
GROUP BY anh_name,anh_num
ORDER BY anh_num
ON CONFLICT (name_pt_ref) DO NOTHING
RETURNING cd_pt_ref, name_pt_ref
;
```

dar las referencias en las tablas totales de mamiferos

```{sql}
ALTER TABLE raw_dwc.mamiferos_tot_event ADD COLUMN cd_pt_ref int REFERENCES main.punto_referencia(cd_pt_ref) ON DELETE SET NULL ON UPDATE CASCADE;
ALTER TABLE raw_dwc.mamiferos_tot_registros ADD COLUMN cd_pt_ref int REFERENCES main.punto_referencia(cd_pt_ref) ON DELETE SET NULL ON UPDATE CASCADE;

WITH a AS(
SELECT event_id,
 CASE
   WHEN event_id ~ '^ANH_[0-9]{1,3}_.*' THEN REGEXP_REPLACE(event_id,'^(ANH_[0-9]{1,3})_.*','\1')
   WHEN event_id ~ '^ANH_[0-9]{1,3}$' THEN event_id
   WHEN event_id ~ '[Hh]otel' THEN 'Hotel'
   ELSE NULL
 END anh_name
FROM raw_dwc.mamiferos_tot_event
)
UPDATE raw_dwc.mamiferos_tot_event AS m
SET cd_pt_ref=pr.cd_pt_ref
FROM main.punto_referencia pr, a
WHERE m.event_id=a.event_id AND a.anh_name = name_pt_ref
;

WITH a AS(
SELECT event_id,
 CASE
   WHEN event_id ~ '^ANH_[0-9]{1,3}_.*' THEN REGEXP_REPLACE(event_id,'^(ANH_[0-9]{1,3})_.*','\1')
   WHEN event_id ~ '^ANH_[0-9]{1,3}$' THEN event_id
   WHEN event_id ~ '[Hh]otel' THEN 'Hotel'
   ELSE NULL
 END anh_name
FROM raw_dwc.mamiferos_tot_registros
)
UPDATE raw_dwc.mamiferos_tot_registros AS m
SET cd_pt_ref=pr.cd_pt_ref
FROM main.punto_referencia pr, a
WHERE m.event_id=a.event_id AND a.anh_name = name_pt_ref
;

SELECT true;
```

Averiguando que ninguna fila no tenga anh

```{sql}
SELECT event_id FROM raw_dwc.mamiferos_tot_event WHERE cd_pt_ref IS NULL;
```

```{sql}
SELECT event_id,occurrence_id FROM raw_dwc.mamiferos_tot_registros WHERE cd_pt_ref IS NULL;
```

## Unit, sampling efforts definition, abundance definition, protocolo

**Anotar: en las trampas Sherman, solo está la hora 7:00, pero imagino que se instalarón a las 6 de la noche porque el tiempo está anotado en numero de noches**


```{sql}
INSERT INTO main.def_unit(cd_measurement_type, unit, unit_spa, abbv_unit,factor)
VALUES(
  (SELECT cd_measurement_type FROM main.def_measurement_type WHERE measurement_type='time'),
  'Number of nights',
  'Número de noches',
  'nights',
  12*60--Acá considero noches de 12 horas
  ),(
  (SELECT cd_measurement_type FROM main.def_measurement_type WHERE measurement_type='presence/absence'),
  'Occurrence',
  'Occurrencia',
  NULL,
  1
  )
RETURNING cd_unit, unit, unit_spa
```

```{sql}
INSERT INTO main.def_var_ind_qt(var_qt_ind, var_qt_ind_spa, cd_unit, type_variable)
VALUES(
  'Occurrence',
  'Occurrencia',
  (SELECT cd_unit FROM main.def_unit WHERE cd_measurement_type=(SELECT cd_measurement_type FROM main.def_measurement_type WHERE measurement_type='presence/absence') AND unit='Occurrence'),
  'int'
)
RETURNING cd_var_ind_qt,var_qt_ind
;
```

```{sql}
INSERT INTO main.def_var_samp_eff(var_samp_eff, var_samp_eff_spa, cd_unit,type_variable)
VALUES(
  'Time elapsed (nights)',
  'Duración (numero de noches)',
  (SELECT cd_unit FROM main.def_unit WHERE cd_measurement_type=(SELECT cd_measurement_type FROM main.def_measurement_type WHERE measurement_type='time') AND unit='Number of nights'),
  'int'
  )
RETURNING cd_var_samp_eff, var_samp_eff ;
```

```{sql}
INSERT INTO main.def_protocol(protocol,protocol_spa,cd_var_samp_eff_1,cd_var_samp_eff_2,samp_eff_1_implicit,samp_eff_2_implicit,cd_var_ind_qt,description_spa)
VALUES(
  'Sherman trap',
  'Trampa Sherman',
  (SELECT cd_var_samp_eff FROM main.def_var_samp_eff WHERE var_samp_eff='Elapsed time'),
  NULL,
  false,
  NULL,
  (SELECT cd_var_ind_qt FROM main.def_var_ind_qt WHERE var_qt_ind='Number of individuals'),
  'Tal vez sería bueno añadir la superficie o la area de la trampa, pero no tengo acceso a esta información'
),(
  'Sound recording',
  'Grabación sonora',
  (SELECT cd_var_samp_eff FROM main.def_var_samp_eff WHERE var_samp_eff='Elapsed time'),
  NULL,
  false,
  NULL,
  (SELECT cd_var_ind_qt FROM main.def_var_ind_qt WHERE var_qt_ind='Occurrence'),
  NULL
)
RETURNING cd_protocol,protocol,protocol_spa;
```

## Personas

```{sql}
INSERT INTO main.people(verbatim_person)
WITH a AS(
SELECT DISTINCT INITCAP(TRIM(UNNEST(STRING_TO_ARRAY(recorded_by, ' | ')))) AS name_person
FROM raw_dwc.mamiferos_tot_registros
UNION
SELECT DISTINCT INITCAP(TRIM(UNNEST(STRING_TO_ARRAY(identified_by, ' | '))))
FROM raw_dwc.mamiferos_tot_registros
)
SELECT DISTINCT REGEXP_REPLACE(name_person, '- ','-')
FROM a 
ORDER BY REGEXP_REPLACE(name_person, '- ','-')
ON CONFLICT(verbatim_person) DO NOTHING
RETURNING cd_person, verbatim_person
```

Dar los codigos a las tables de origen:

```{sql}
ALTER TABLE raw_dwc.mamiferos_tot_registros ADD COLUMN cds_recorded_by int[];

WITH a AS(
SELECT table_orig,"row.names", REGEXP_REPLACE(INITCAP(TRIM(UNNEST(STRING_TO_ARRAY(recorded_by, ' | ')))),'- ','-') AS name_person
FROM raw_dwc.mamiferos_tot_registros
),b AS(
SELECT table_orig,"row.names", ARRAY_AGG(cd_person) cds
FROM a 
LEFT JOIN main.people p ON a.name_person=p.verbatim_person
GROUP BY table_orig, "row.names"
)
UPDATE raw_dwc.mamiferos_tot_registros AS r
SET cds_recorded_by=b.cds
FROM b
WHERE r."row.names"=b."row.names" AND r.table_orig=b.table_orig
RETURNING r."row.names", cds_recorded_by
;

ALTER TABLE raw_dwc.mamiferos_tot_registros ADD COLUMN cds_identified_by int[];

WITH a AS(
SELECT table_orig,"row.names", REGEXP_REPLACE(INITCAP(TRIM(UNNEST(STRING_TO_ARRAY(identified_by, ' | ')))),'- ','-') AS name_person
FROM raw_dwc.mamiferos_tot_registros
),b AS(
SELECT table_orig,"row.names", ARRAY_AGG(cd_person) cds
FROM a 
LEFT JOIN main.people p ON a.name_person=p.verbatim_person
GROUP BY table_orig,"row.names"
)
UPDATE raw_dwc.mamiferos_tot_registros AS r
SET cds_identified_by=b.cds
FROM b
WHERE r."row.names"=b."row.names" AND r.table_orig=b.table_orig
RETURNING r."row.names", cds_identified_by
;

SELECT 1;
```

## gp_event

```{sql}
WITH a AS(
SELECT 
  event_id,
 CASE
   WHEN event_id ~ '^ANH_[0-9]{1,3}_.*' THEN REGEXP_REPLACE(event_id,'^(ANH_[0-9]{1,3})_.*','\1')
   WHEN event_id ~ '^ANH_[0-9]{1,3}$' THEN event_id
   WHEN event_id ~ '[Hh]otel' THEN 'Hotel'
 END anh_name,
 CASE
   WHEN event_id ~ '^ANH_[0-9]{1,3}_.*' THEN REGEXP_REPLACE(event_id,'^ANH_([0-9]{1,3})_.*','\1')::int
   WHEN event_id ~ '^ANH_[0-9]{1,3}$' THEN REGEXP_REPLACE(event_id,'^ANH_([0-9]{1,3})$','\1')::int
   ELSE NULL
 END anh_num,
 CASE
   WHEN event_id ~ '^ANH_[0-9]{1,3}_M_[RS][0-9]{1,3}(_T2)?$' AND sampling_protocol='Red niebla' THEN 'niebla'
   WHEN event_id ~ '^ANH_[0-9]{1,3}_M_[RS][0-9]{1,3}(_T2)?$' AND sampling_protocol='Trampa Sherman' THEN 'sherman'
   WHEN sampling_protocol ~ '^Punto( de)? grabación' THEN 'grabación'
   WHEN event_id ~ 'Herp' OR event_id ~ '^ANH_[0-9]{1,3}_A_' THEN 'accidental (otro grupo)'
   WHEN sampling_protocol='Captura manual' THEN 'accidental' 
   WHEN sampling_protocol~'^Encuentro ?$' THEN 'accidental' 
   WHEN sampling_protocol='Trampa pitfall' THEN 'accidental (pitfall)'
 END metodo,
 CASE
   WHEN event_id ~ '^ANH_[0-9]{1,3}_M_[RS]([0-9]{1,3})(_T2)?$' THEN REGEXP_REPLACE(event_id,'^ANH_[0-9]{1,3}_M_[RS]([0-9]{1,3})(_T2)?$','\1')::int
   WHEN sampling_protocol ~ '^Punto( de)? grabación' AND event_id ~ '^ANH_[0-9]{1,3}_([0-9]{1,2})(_T2)?' THEN REGEXP_REPLACE(event_id,'^ANH_[0-9]{1,3}_([0-9]{1,2})(_T2)?','\1')::int
   WHEN event_id ~ '^Hotel_[0-9]' THEN REGEXP_REPLACE(event_id,'^Hotel_([0-9]).*','\1')::int
   WHEN event_id ~ 'ANH_[0-9]{1,3}_M_P_[0-9](_T2)?' THEN REGEXP_REPLACE(event_id, 'ANH_[0-9]{1,3}_M_P_([0-9])(_T2)?$', '\1')::int
   WHEN event_id ~ 'ANH_([0-9]{1,3}_)?M_CM_[0-9]_T2' THEN REGEXP_REPLACE(event_id, 'ANH_([0-9]{1,3}_)?M_CM_([0-9])(_T2)?$', '\2')::int
   ELSE NULL
 END repli,
 CASE
   WHEN event_id ~ 'T2$' THEN 'T2'
   ELSE 'T1'
 END tempo
FROM raw_dwc.mamiferos_tot_event
)
SELECT tempo, anh_num,metodo, ARRAY_AGG(repli), count(*)
FROM a
GROUP BY tempo, anh_num, metodo
ORDER BY tempo, anh_num, metodo
;
```

Because there is more than a method, the number of the campaign should be determined this way:

```{sql}
WITH a AS(
SELECT 
  event_id,
 CASE
   WHEN event_id ~ '^ANH_[0-9]{1,3}_.*' THEN REGEXP_REPLACE(event_id,'^(ANH_[0-9]{1,3})_.*','\1')
   WHEN event_id ~ '^ANH_[0-9]{1,3}$' THEN event_id
   WHEN event_id ~ '[Hh]otel' THEN 'Hotel'
 END anh_name,
 CASE
   WHEN event_id ~ '^ANH_[0-9]{1,3}_.*' THEN REGEXP_REPLACE(event_id,'^ANH_([0-9]{1,3})_.*','\1')::int
   WHEN event_id ~ '^ANH_[0-9]{1,3}$' THEN REGEXP_REPLACE(event_id,'^ANH_([0-9]{1,3})$','\1')::int
   ELSE NULL
 END anh_num,
 CASE
   WHEN event_id ~ '^ANH_[0-9]{1,3}_M_[RS][0-9]{1,3}(_T2)?$' AND sampling_protocol='Red niebla' THEN 'niebla'
   WHEN event_id ~ '^ANH_[0-9]{1,3}_M_[RS][0-9]{1,3}(_T2)?$' AND sampling_protocol='Trampa Sherman' THEN 'sherman'
   WHEN sampling_protocol ~ '^Punto( de)? grabación' THEN 'grabación'
   WHEN event_id ~ 'Herp' OR event_id ~ '^ANH_[0-9]{1,3}_A_' THEN 'accidental (otro grupo)'
   WHEN sampling_protocol='Captura manual' THEN 'accidental' 
   WHEN sampling_protocol~'^Encuentro ?$' THEN 'accidental' 
   WHEN sampling_protocol='Trampa pitfall' THEN 'accidental (pitfall)'
 END metodo,
 CASE
   WHEN event_id ~ '^ANH_[0-9]{1,3}_M_[RS]([0-9]{1,3})(_T2)?$' THEN REGEXP_REPLACE(event_id,'^ANH_[0-9]{1,3}_M_[RS]([0-9]{1,3})(_T2)?$','\1')::int
   WHEN sampling_protocol ~ '^Punto( de)? grabación' AND event_id ~ '^ANH_[0-9]{1,3}_([0-9]{1,2})(_T2)?' THEN REGEXP_REPLACE(event_id,'^ANH_[0-9]{1,3}_([0-9]{1,2})(_T2)?','\1')::int
   WHEN event_id ~ '^Hotel_[0-9]' THEN REGEXP_REPLACE(event_id,'^Hotel_([0-9]).*','\1')::int
   WHEN event_id ~ 'ANH_[0-9]{1,3}_M_P_[0-9](_T2)?' THEN REGEXP_REPLACE(event_id, 'ANH_[0-9]{1,3}_M_P_([0-9])(_T2)?$', '\1')::int
   WHEN event_id ~ 'ANH_([0-9]{1,3}_)?M_CM_[0-9]_T2' THEN REGEXP_REPLACE(event_id, 'ANH_([0-9]{1,3}_)?M_CM_([0-9])(_T2)?$', '\2')::int
   ELSE NULL
 END repli,
 CASE
   WHEN event_id ~ 'T2$' THEN 'T2'
   ELSE 'T1'
 END tempo
FROM raw_dwc.mamiferos_tot_event
)
SELECT tempo, anh_name, ROW_NUMBER() OVER (PARTITION BY anh_name ORDER BY tempo) campaign_nb
FROM a
GROUP BY tempo, anh_name
ORDER BY tempo, anh_name
;
```


```{sql}
INSERT INTO main.gp_event(cd_gp_biol,cd_protocol,cd_pt_ref,campaign_nb)
WITH a AS(
SELECT 
  event_id,
 CASE
   WHEN event_id ~ '^ANH_[0-9]{1,3}_.*' THEN REGEXP_REPLACE(event_id,'^(ANH_[0-9]{1,3})_.*','\1')
   WHEN event_id ~ '^ANH_[0-9]{1,3}$' THEN event_id
   WHEN event_id ~ '[Hh]otel' THEN 'Hotel'
 END anh_name,
 CASE
   WHEN event_id ~ '^ANH_[0-9]{1,3}_.*' THEN REGEXP_REPLACE(event_id,'^ANH_([0-9]{1,3})_.*','\1')::int
   WHEN event_id ~ '^ANH_[0-9]{1,3}$' THEN REGEXP_REPLACE(event_id,'^ANH_([0-9]{1,3})$','\1')::int
   ELSE NULL
 END anh_num,
 CASE
   WHEN event_id ~ '^ANH_[0-9]{1,3}_M_[RS][0-9]{1,3}(_T2)?$' AND sampling_protocol='Red niebla' THEN 'niebla'
   WHEN event_id ~ '^ANH_[0-9]{1,3}_M_[RS][0-9]{1,3}(_T2)?$' AND sampling_protocol='Trampa Sherman' THEN 'sherman'
   WHEN sampling_protocol ~ '^Punto( de)? grabación' THEN 'grabación'
   WHEN event_id ~ 'Herp' OR event_id ~ '^ANH_[0-9]{1,3}_A_' THEN 'accidental (otro grupo)'
   WHEN sampling_protocol='Captura manual' THEN 'accidental' 
   WHEN sampling_protocol~'^Encuentro ?$' THEN 'accidental' 
   WHEN sampling_protocol='Trampa pitfall' THEN 'accidental (pitfall)'
 END metodo,
 CASE
   WHEN event_id ~ '^ANH_[0-9]{1,3}_M_[RS]([0-9]{1,3})(_T2)?$' THEN REGEXP_REPLACE(event_id,'^ANH_[0-9]{1,3}_M_[RS]([0-9]{1,3})(_T2)?$','\1')::int
   WHEN sampling_protocol ~ '^Punto( de)? grabación' AND event_id ~ '^ANH_[0-9]{1,3}_([0-9]{1,2})(_T2)?' THEN REGEXP_REPLACE(event_id,'^ANH_[0-9]{1,3}_([0-9]{1,2})(_T2)?','\1')::int
   WHEN event_id ~ '^Hotel_[0-9]' THEN REGEXP_REPLACE(event_id,'^Hotel_([0-9]).*','\1')::int
   WHEN event_id ~ 'ANH_[0-9]{1,3}_M_P_[0-9](_T2)?' THEN REGEXP_REPLACE(event_id, 'ANH_[0-9]{1,3}_M_P_([0-9])(_T2)?$', '\1')::int
   WHEN event_id ~ 'ANH_([0-9]{1,3}_)?M_CM_[0-9]_T2' THEN REGEXP_REPLACE(event_id, 'ANH_([0-9]{1,3}_)?M_CM_([0-9])(_T2)?$', '\2')::int
   ELSE NULL
 END repli,
 CASE
   WHEN event_id ~ 'T2$' THEN 'T2'
   ELSE 'T1'
 END tempo,
  cd_pt_ref
FROM raw_dwc.mamiferos_tot_event
), campaign AS(
SELECT tempo, anh_name, ROW_NUMBER() OVER (PARTITION BY anh_name ORDER BY tempo) campaign_nb
FROM a
GROUP BY tempo, anh_name
ORDER BY tempo, anh_name
)
SELECT 'mami',
  CASE
    WHEN metodo~'accidental' THEN (SELECT cd_protocol FROM main.def_protocol WHERE protocol='Accidental encounter')
    WHEN metodo='niebla' THEN (SELECT cd_protocol FROM main.def_protocol WHERE protocol='Mist nets')
    WHEN metodo='sherman' THEN (SELECT cd_protocol FROM main.def_protocol WHERE protocol='Sherman trap')
    WHEN metodo='grabación' THEN (SELECT cd_protocol FROM main.def_protocol WHERE protocol='Sound recording')
  END cd_protocol,
  cd_pt_ref,
  c.campaign_nb
FROM a
LEFT JOIN campaign c ON c.tempo=a.tempo AND (c.anh_name=a.anh_name OR (c.anh_name IS NULL AND a.anh_name IS NULL))
LEFT JOIN main.punto_referencia USING (cd_pt_ref)
GROUP BY cd_pt_ref, name_pt_ref, a.tempo, metodo, c.campaign_nb
ORDER BY a.tempo,cd_pt_ref,cd_protocol
RETURNING cd_gp_event,cd_gp_biol,cd_protocol,cd_pt_ref,campaign_nb,subpart
;
```

Attributing the gp_event

```{sql}
ALTER TABLE raw_dwc.mamiferos_tot_event ADD COLUMN cd_gp_event int REFERENCES main.gp_event(cd_gp_event) ON DELETE SET NULL;


WITH a AS(
SELECT 
  event_id,
 CASE
   WHEN event_id ~ '^ANH_[0-9]{1,3}_.*' THEN REGEXP_REPLACE(event_id,'^(ANH_[0-9]{1,3})_.*','\1')
   WHEN event_id ~ '^ANH_[0-9]{1,3}$' THEN event_id
   WHEN event_id ~ '[Hh]otel' THEN 'Hotel'
 END anh_name,
 CASE
   WHEN event_id ~ '^ANH_[0-9]{1,3}_.*' THEN REGEXP_REPLACE(event_id,'^ANH_([0-9]{1,3})_.*','\1')::int
   WHEN event_id ~ '^ANH_[0-9]{1,3}$' THEN REGEXP_REPLACE(event_id,'^ANH_([0-9]{1,3})$','\1')::int
   ELSE NULL
 END anh_num,
 CASE
   WHEN event_id ~ '^ANH_[0-9]{1,3}_M_[RS][0-9]{1,3}(_T2)?$' AND sampling_protocol='Red niebla' THEN 'niebla'
   WHEN event_id ~ '^ANH_[0-9]{1,3}_M_[RS][0-9]{1,3}(_T2)?$' AND sampling_protocol='Trampa Sherman' THEN 'sherman'
   WHEN sampling_protocol ~ '^Punto( de)? grabación' THEN 'grabación'
   WHEN event_id ~ 'Herp' OR event_id ~ '^ANH_[0-9]{1,3}_A_' THEN 'accidental (otro grupo)'
   WHEN sampling_protocol='Captura manual' THEN 'accidental' 
   WHEN sampling_protocol~'^Encuentro ?$' THEN 'accidental' 
   WHEN sampling_protocol='Trampa pitfall' THEN 'accidental (pitfall)'
 END metodo,
 CASE
   WHEN event_id ~ '^ANH_[0-9]{1,3}_M_[RS]([0-9]{1,3})(_T2)?$' THEN REGEXP_REPLACE(event_id,'^ANH_[0-9]{1,3}_M_[RS]([0-9]{1,3})(_T2)?$','\1')::int
   WHEN sampling_protocol ~ '^Punto( de)? grabación' AND event_id ~ '^ANH_[0-9]{1,3}_([0-9]{1,2})(_T2)?' THEN REGEXP_REPLACE(event_id,'^ANH_[0-9]{1,3}_([0-9]{1,2})(_T2)?','\1')::int
   WHEN event_id ~ '^Hotel_[0-9]' THEN REGEXP_REPLACE(event_id,'^Hotel_([0-9]).*','\1')::int
   WHEN event_id ~ 'ANH_[0-9]{1,3}_M_P_[0-9](_T2)?' THEN REGEXP_REPLACE(event_id, 'ANH_[0-9]{1,3}_M_P_([0-9])(_T2)?$', '\1')::int
   WHEN event_id ~ 'ANH_([0-9]{1,3}_)?M_CM_[0-9]_T2' THEN REGEXP_REPLACE(event_id, 'ANH_([0-9]{1,3}_)?M_CM_([0-9])(_T2)?$', '\2')::int
   ELSE NULL
 END repli,
 CASE
   WHEN event_id ~ 'T2$' THEN 'T2'
   ELSE 'T1'
 END tempo,
  cd_pt_ref
FROM raw_dwc.mamiferos_tot_event
), campaign AS(
SELECT tempo, anh_name, ROW_NUMBER() OVER (PARTITION BY anh_name ORDER BY tempo) campaign_nb
FROM a
GROUP BY tempo, anh_name
ORDER BY tempo, anh_name
),b AS(
SELECT event_id,
  CASE
    WHEN metodo~'accidental' THEN (SELECT cd_protocol FROM main.def_protocol WHERE protocol='Accidental encounter')
    WHEN metodo='niebla' THEN (SELECT cd_protocol FROM main.def_protocol WHERE protocol='Mist nets')
    WHEN metodo='sherman' THEN (SELECT cd_protocol FROM main.def_protocol WHERE protocol='Sherman trap')
    WHEN metodo='grabación' THEN (SELECT cd_protocol FROM main.def_protocol WHERE protocol='Sound recording')
  END cd_protocol,
  cd_pt_ref,
  c.campaign_nb
FROM a
LEFT JOIN campaign c ON c.tempo=a.tempo AND (c.anh_name=a.anh_name OR (c.anh_name IS NULL AND a.anh_name IS NULL))
LEFT JOIN main.punto_referencia USING (cd_pt_ref)
),d AS(
SELECT b.*, cd_gp_event
FROM b
LEFT JOIN main.gp_event ge ON cd_gp_biol='mami' AND b.cd_protocol=ge.cd_protocol AND ((b.cd_pt_ref=ge.cd_pt_ref) OR (b.cd_pt_ref IS NULL AND ge.cd_pt_ref IS NULL)) AND b.campaign_nb=ge.campaign_nb 
)
UPDATE raw_dwc.mamiferos_tot_event e
SET cd_gp_event=d.cd_gp_event
FROM d
WHERE d.event_id=e.event_id
RETURNING e.event_id, e.cd_gp_event
;

SELECT event_id
FROM raw_dwc.mamiferos_tot_event
WHERE cd_gp_event IS NULL;
```

## event

**Aves has sampl*ing* while the others have sampl*e* in the name of the columns**

**Existen rangos de horas que utilizan '-' como separador en lugar de '/'**

**En las grabaciones del hotel una fecha no tiene el milenario ('2022-03-19/22-04-08')**

**Acá voy a reemplazar la hora inicial de los Sherman por 18:00:00 en lugar de 07:00:00 porque me parece que las trampas funcionan durante la noche, me parece que la hora indicada es la hora final**

**las grabaciones no tienen hora final... voy a considerar que la hora + tiempo de grabación da la hora final**


```{sql}
SELECT event_id, event_time
FROM raw_dwc.mamiferos_tot_event
WHERE event_time ~ '-';
```


\footnotesize

```{sql}
INSERT INTO main.event(cd_gp_event,event_id,num_replicate, description_replicate, date_time_begin, date_time_end, locality_verb, event_remarks, samp_effort_1, samp_effort_2, pt_geom)
WITH a AS(
SELECT cd_gp_event,
  event_id, 
 CASE
   WHEN event_id ~ '^ANH_[0-9]{1,3}_.*' THEN REGEXP_REPLACE(event_id,'^(ANH_[0-9]{1,3})_.*','\1')
   WHEN event_id ~ '^ANH_[0-9]{1,3}$' THEN event_id
   WHEN event_id ~ '[Hh]otel' THEN 'Hotel'
 END anh_name,
 CASE
   WHEN event_id ~ '^ANH_[0-9]{1,3}_.*' THEN REGEXP_REPLACE(event_id,'^ANH_([0-9]{1,3})_.*','\1')::int
   WHEN event_id ~ '^ANH_[0-9]{1,3}$' THEN REGEXP_REPLACE(event_id,'^ANH_([0-9]{1,3})$','\1')::int
   ELSE NULL
 END anh_num,
 CASE
   WHEN event_id ~ '^ANH_[0-9]{1,3}_M_[RS][0-9]{1,3}(_T2)?$' AND sampling_protocol='Red niebla' THEN 'niebla'
   WHEN event_id ~ '^ANH_[0-9]{1,3}_M_[RS][0-9]{1,3}(_T2)?$' AND sampling_protocol='Trampa Sherman' THEN 'sherman'
   WHEN sampling_protocol ~ '^Punto( de)? grabación' THEN 'grabación'
   WHEN event_id ~ 'Herp' OR event_id ~ '^ANH_[0-9]{1,3}_A_' THEN 'accidental (otro grupo)'
   WHEN sampling_protocol='Captura manual' THEN 'accidental' 
   WHEN sampling_protocol~'^Encuentro ?$' THEN 'accidental' 
   WHEN sampling_protocol='Trampa pitfall' THEN 'accidental (pitfall)'
 END metodo,
 CASE
   WHEN event_id ~ '^ANH_[0-9]{1,3}_M_[RS]([0-9]{1,3})(_T2)?$' THEN REGEXP_REPLACE(event_id,'^ANH_[0-9]{1,3}_M_[RS]([0-9]{1,3})(_T2)?$','\1')::int
   WHEN sampling_protocol ~ '^Punto( de)? grabación' AND event_id ~ '^ANH_[0-9]{1,3}_([0-9]{1,2})(_T2)?' THEN REGEXP_REPLACE(event_id,'^ANH_[0-9]{1,3}_([0-9]{1,2})(_T2)?','\1')::int
   WHEN event_id ~ '^Hotel_[0-9]' THEN REGEXP_REPLACE(event_id,'^Hotel_([0-9]).*','\1')::int
   WHEN event_id ~ 'ANH_[0-9]{1,3}_M_P_[0-9](_T2)?' THEN REGEXP_REPLACE(event_id, 'ANH_[0-9]{1,3}_M_P_([0-9])(_T2)?$', '\1')::int
   WHEN event_id ~ 'ANH_([0-9]{1,3}_)?M_CM_[0-9]_T2' THEN REGEXP_REPLACE(event_id, 'ANH_([0-9]{1,3}_)?M_CM_([0-9])(_T2)?$', '\2')::int
   ELSE NULL
 END repli,
 CASE
   WHEN event_id ~ 'T2$' THEN 'T2'
   ELSE 'T1'
 END tempo,
  TO_DATE(SPLIT_PART(event_date,'/',1), 'YYYY-MM-DD') date_1,
  CASE 
    WHEN SPLIT_PART(event_date,'/',2)='' THEN NULL
    WHEN SPLIT_PART(event_date,'/',2) ~ '^[0-9]{2}-[0-9]{2}-[0-9]{2}$' THEN TO_DATE('20'||SPLIT_PART(event_date,'/',2), 'YYYY-MM-DD')

    ELSE TO_DATE(SPLIT_PART(event_date,'/',2), 'YYYY-MM-DD')
  END date_2,
  REGEXP_REPLACE(SPLIT_PART(REGEXP_REPLACE(event_time,'-','/'),'/',1),'\s+','','g')::time hora_1,
  CASE
  	WHEN REGEXP_REPLACE(SPLIT_PART(REGEXP_REPLACE(event_time,'-','/'),'/',2),'\s+','','g')='' THEN NULL
	ELSE REGEXP_REPLACE(SPLIT_PART(REGEXP_REPLACE(event_time,'-','/'),'/',2),'\s+','','g')::time
  END hora_2,
  locality locality_verb,
  sample_size_value,
  --sampling_size_value,
  sample_size_unit,
  --sampling_size_unit,
  sampling_effort,
  REGEXP_REPLACE(REGEXP_REPLACE(event_remarks, '\|? ?No hay registros de individuos ?',''),'\|? ?No se registran individuos','') event_remarks,
  --locality_remarks,
  decimal_latitude::double precision,
  decimal_longitude::double precision
FROM raw_dwc.mamiferos_tot_event
),b AS(--calculation of timestamps, coordinates and num_replicate
SELECT 
  cd_gp_event,
  event_id, 
  ROW_NUMBER() OVER (PARTITION BY cd_gp_event ORDER BY repli) num_replicate,
  CASE
  WHEN metodo='niebla' THEN 'R'||repli::text
  WHEN metodo='sherman' THEN 'S'||repli::text
    ELSE repli::text
  END description_replicate,
  CASE
    WHEN metodo = 'sherman' AND hora_1<'18:00:00' THEN (date_1||' '||'18:00:00')::timestamp
    WHEN date_1 IS NULL OR hora_1 IS NULL THEN NULL
    ELSE (date_1||' '||hora_1)::timestamp 
  END date_time_begin,
  CASE
    WHEN metodo='grabación' AND sampling_effort IS NOT NULL THEN ((date_1||' '||hora_1)::timestamp) + (REGEXP_REPLACE(REGEXP_REPLACE(sampling_effort,'[mM]inutos?','minutes'),'[Hh]oras?','hours'))::interval
    WHEN metodo='sherman' THEN (date_2||' '||hora_1)::timestamp
    WHEN date_2 IS NULL AND hora_2 IS NOT NULL THEN (date_1||' '||hora_2)::timestamp
    WHEN date_2 IS NOT NULL AND hora_2 IS NOT NULL THEN (date_2||' '||hora_2)::timestamp
    --WHEN date_2 IS NULL AND (date_1||' '||hora_2)::timestamp::time='00:00'::time THEN ((date_1::date)+1 ||' '||hora_2)::timestamp
  END date_time_end,
  locality_verb,
  event_remarks ,
  --sampling_size_value,
  sample_size_value,
  --sampling_size_unit,
  sample_size_unit,
  sampling_effort,
  ST_SetSRID(ST_Transform(ST_SetSRID(ST_MakePoint(decimal_longitude,decimal_latitude),4326),(SELECT proj4text FROM spatial_ref_sys WHERE srid=3116)),3116) pt_geom
FROM a
LEFT JOIN main.gp_event USING (cd_gp_event)
LEFT JOIN main.def_protocol p USING (cd_protocol)
ORDER BY cd_gp_event, event_id, num_replicate
)--calculation of sampling efforts and modification of existing event_id
SELECT
  cd_gp_event,
  CASE
    WHEN event_id ~ 'Herp' THEN 'mami_'||event_id
    ELSE event_id
  END event_id,
  num_replicate,
  description_replicate,
  date_time_begin,
  date_time_end,
  locality_verb,
  event_remarks,
  CASE
   WHEN protocol='Accidental encounter' THEN NULL::double precision
   WHEN protocol='Mist nets' THEN sample_size_value::double precision
   WHEN protocol='Sherman trap' AND sample_size_value='1 trampa x 5 noches' THEN 5::double precision
   WHEN protocol='Sound recording' AND sampling_effort IS NOT NULL THEN EXTRACT(EPOCH FROM REGEXP_REPLACE(REGEXP_REPLACE(sampling_effort,'[mM]inutos?','minutes'),'[Hh]oras?','hours')::interval)/60
  END samp_eff_1,
  CASE
    WHEN protocol='Mist nets' THEN EXTRACT(EPOCH FROM (date_time_end-date_time_begin))/60
  END samp_eff_2,
  pt_geom
FROM b
LEFT JOIN main.gp_event USING (cd_gp_event)
LEFT JOIN main.def_protocol p USING (cd_protocol)
ORDER BY cd_gp_event, event_id, num_replicate

RETURNING main.event.cd_event, main.event.cd_gp_event, main.event.event_id, main.event.num_replicate, main.event.description_replicate, main.event.date_time_begin, main.event.date_time_end, main.event.locality_verb, main.event.event_remarks, main.event.pt_geom
```

Damos los cd_event a todos las filas:

```{sql}
ALTER TABLE raw_dwc.mamiferos_tot_event ADD COLUMN cd_event int REFERENCES main.event(cd_event) ON DELETE SET NULL;
ALTER TABLE raw_dwc.mamiferos_tot_registros ADD COLUMN cd_event int REFERENCES main.event(cd_event);

UPDATE raw_dwc.mamiferos_tot_event AS t
SET cd_event=e.cd_event
FROM main.event e
WHERE t.event_id=REGEXP_REPLACE(e.event_id,'^mami_','') AND e.cd_gp_event IN (SELECT cd_gp_event FROM main.gp_event WHERE cd_gp_biol='mami');

UPDATE raw_dwc.mamiferos_tot_registros AS t
SET cd_event=e.cd_event
FROM main.event e
WHERE t.event_id=REGEXP_REPLACE(e.event_id,'^mami_','') AND e.cd_gp_event IN (SELECT cd_gp_event FROM main.gp_event WHERE cd_gp_biol='mami');

SELECT true;
```

### Añadir información temporal faltante

Casos donde date_time_begin está NULL pero la fecha es disponible:


```{sql}
INSERT INTO main.event_extra(cd_event, cd_var_event_extra,value_text)
WITH a AS(
SELECT cd_event,ef.date_time_begin,ef.date_time_end, event_time, event_date,
  TO_DATE(SPLIT_PART(event_date,'/',1), 'YYYY-MM-DD') date_1,
  TO_DATE(SPLIT_PART(event_date,'/',2), 'YYYY-MM-DD') date_2
FROM raw_dwc.mamiferos_tot_event e
LEFT JOIN main.event ef USING (cd_event)
WHERE date_time_begin IS NULL
),b AS(
SELECT cd_event,
  CASE
   WHEN date_time_begin IS NULL THEN date_1
   ELSE NULL
  END date_begin
FROM a
)
SELECT 
 cd_event,
 (SELECT cd_var_event_extra FROM main.def_var_event_extra WHERE var_event_extra='date_begin'),
 to_char(date_begin,'yyyy-mm-dd')::text
FROM b
WHERE date_begin IS NOT NULL
RETURNING main.event_extra.cd_event, main.event_extra.cd_var_event_extra, main.event_extra.value_text
;
INSERT INTO main.event_extra(cd_event, cd_var_event_extra,value_text)
WITH a AS(
SELECT cd_event,ef.date_time_begin,ef.date_time_end,event_time, event_date,
TO_DATE(SPLIT_PART(event_date,'/',2), 'YYYY-MM-DD')::date date_2
FROM raw_dwc.mamiferos_tot_event e
LEFT JOIN main.event ef USING (cd_event)
WHERE date_time_begin IS NULL OR date_time_end IS NULL
),b AS(
SELECT cd_event,
  CASE
   WHEN date_time_end IS NULL AND EXTRACT(YEAR FROM date_2)>1 THEN date_2
   ELSE NULL
  END date_end
FROM a
)
SELECT 
 cd_event,
 (SELECT cd_var_event_extra FROM main.def_var_event_extra WHERE var_event_extra='date_end'),
 to_char(date_end,'yyyy-mm-dd')::text
FROM b
WHERE date_end IS NOT NULL
RETURNING main.event_extra.cd_event, main.event_extra.cd_var_event_extra, main.event_extra.value_text
;
```



## registros


```{sql}
SELECT occurrence_id, count(*)
FROM raw_dwc.mamiferos_tot_registros 
GROUP BY occurrence_id
HAVING count(*)>1;
```


**Parece que la fechas y horas en registros tienen sentido, ahora hay que notar que tuvé que corregir el formato de las horas de las redes de nieblas**


```{sql}
SELECT e.event_id, e.event_date date_event, r.event_date date_registro, e.event_time time_event, r.event_time time_registro
FROM raw_dwc.mamiferos_tot_registros r
LEFT JOIN raw_dwc.mamiferos_tot_event e USING(cd_event)
ORDER BY r.event_date, r.event_time

```

**Hay formatos de horas raras**:


```{sql}
SELECT event_id, occurrence_id,event_time FROM raw_dwc.mamiferos_tot_registros WHERE event_time ~ '\.'

```

**Parece que hay una codificación de los organism_id, pero hay repeticiones y organism_id faltantes**

(anotar que la columna no existe en el archivo de ultrasonidos)

```{sql}
SELECT organism_id,count(*)
FROM raw_dwc.mamiferos_tot_registros 
GROUP BY organism_id               
HAVING count(*) > 1
;
```


Lo que voy a hacer es:

* extraer el id del occurrence_id para poner un occurrence_id cuando no haya
* contar las replicationes de occurrence_id iguales y poner \_rep[0-9] a las repeticiones
* guardar los occurrence_id que no presentan problemas

**eventRemarks esta pensado como el event_id, pero a veces no corresponden (es importante averiguar que el verdadero eventID no es lo que está escrito en event_remarks!**

```{sql}
SELECT event_id,occurrence_remarks, event_remarks FROM raw_dwc.mamiferos_tot_registros WHERE event_id!=event_remarks;
```

```{sql}
INSERT INTO main.registros(cd_event, cds_recorded_by, date_time, cd_tax, cd_morfo, date_ident, cds_identified_by, qt_int,remarks, occurrence_id, organism_id)
SELECT 
 cd_event,
 cds_recorded_by,
 CASE 
   WHEN event_date IS NULL OR event_time IS NULL THEN NULL
   WHEN event_time ~ '\.' THEN (event_date||' '||REGEXP_REPLACE(event_time,'\.',':'))::timestamp
   WHEN event_time ~ '/' THEN (event_date||' '||SPLIT_PART(event_time,'/',1))::timestamp
   ELSE (event_date||' '||event_time)::timestamp 
 END date_time,
 tt.cd_tax,
 tt.cd_morfo,
 TO_DATE(date_identified,'YYYY-MM-DD') date_ident,
 cds_identified_by,
 CASE
  WHEN var_qt_ind ='Occurrence' AND organism_quantity IS NULL THEN 1
  ELSE organism_quantity::double precision::int 
 END qt_int,
 occurrence_remarks remarks,
 --r.event_remarks remarks,
 r.occurrence_id,
 --SPLIT_PART(occurrence_id,':',7) organism_id
 --ROW_NUMBER() OVER (ORDER BY (e.date_time_begin::date||' '||event_time)::timestamp)
 --organism_id,
 CASE 
  WHEN organism_id IS NULL OR organism_id=' *' THEN SPLIT_PART(occurrence_id,':',7)::text
   WHEN  ROW_NUMBER() OVER (PARTITION BY organism_id ORDER BY event_date,event_time) >1 THEN organism_id||'_rep_'|| ROW_NUMBER() OVER (PARTITION BY organism_id ORDER BY event_date,event_time)  
   ELSE organism_id
 END organism_id_fin
 --ST_SetSRID(ST_Transform(ST_SetSRID(ST_MakePoint(measurement_value__longitud_,measurement_value__latitud_), 4326),  (SELECT proj4text FROM spatial_ref_sys WHERE srid=3116)),3116)
FROM raw_dwc.mamiferos_tot_registros r
LEFT JOIN raw_dwc.taxonomy_total tt ON tt."row.names"=r."row.names" AND tt.table_orig=r.table_orig
LEFT JOIN main.event e USING (cd_event)
LEFT JOIN main.gp_event USING (cd_gp_event)
LEFT JOIN main.def_protocol USING (cd_protocol)
LEFT JOIN main.def_var_ind_qt USING(cd_var_ind_qt)
ORDER BY date_time

RETURNING cd_event, cds_recorded_by, date_time, cd_tax, cd_morfo, cds_identified_by, qt_int,remarks, occurrence_id, organism_id
```

```{sql}
ALTER TABLE raw_dwc.mamiferos_tot_registros ADD COLUMN cd_reg int REFERENCES main.registros(cd_reg);
UPDATE raw_dwc.mamiferos_tot_registros AS ar
SET cd_reg=r.cd_reg
FROM main.registros r
WHERE ar.cd_event=r.cd_event AND ar.occurrence_id=r.occurrence_id;

-- Check cd_reg are unique in the source table
SELECT cd_reg,count(*) FROM  raw_dwc.mamiferos_tot_registros GROUP BY cd_reg HAVING count(*)>1;
```


### Añadir la información temporal supplementaria

```{sql}

INSERT INTO main.registros_extra(cd_reg,cd_var_registros_extra,value_text)
SELECT cd_reg,
(SELECT cd_var_registros_extra FROM main.def_var_registros_extra WHERE var_registros_extra='date_time_end'),
(event_date||' '||SPLIT_PART(event_time,'/',2))::timestamp::text
FROM raw_dwc.mamiferos_tot_registros
WHERE SPLIT_PART(event_time,'/',2) != '';
```



# Peces 

**Peces utiliza occurrenceID como eventID en la pestaña event, yo creo que es mala idea en caso de exportación en bases internacionales**

## Entender el plan de muestreo

```{sql}
SELECT occurrence_id,sampling_protocol
FROM raw_dwc.peces_event
WHERE occurrence_id!~'^ANH_([0-9]{1,3})_([ARET])_([DC])(_T2)?$';
```

```{sql}
WITH a AS(
SELECT occurrence_id,sampling_protocol,
  REGEXP_REPLACE(occurrence_id,'^ANH_([0-9]{1,3})_([ARET])_([DC])(_T2)?$','\1')::int anh_num,
  REGEXP_REPLACE(occurrence_id,'^ANH_([0-9]{1,3})_([ARET])_([DC])(_T2)?$','\2') metodo,
  REGEXP_REPLACE(occurrence_id,'^ANH_([0-9]{1,3})_([ARET])_([DC])(_T2)?$','\3') jornada,
  CASE 
    WHEN occurrence_id ~ 'T2$' THEN 'T2'
    ELSE 'T1'
  END tempo
FROM raw_dwc.peces_event
)
SELECT  tempo, metodo,count(*)-- ARRAY_AGG(occurrence_id)
FROM a
GROUP BY tempo,metodo
ORDER BY tempo,metodo
;
```

```{sql}
WITH a AS(
SELECT occurrence_id,
  REGEXP_REPLACE(occurrence_id,'^(ANH_[0-9]{1,3})_([ARET])_([DC])(_T2)?$','\1') anh_name,
  REGEXP_REPLACE(occurrence_id,'^ANH_([0-9]{1,3})_([ARET])_([DC])(_T2)?$','\1')::int anh_num,
  REGEXP_REPLACE(occurrence_id,'^ANH_([0-9]{1,3})_([ARET])_([DC])(_T2)?$','\2') metodo,
  REGEXP_REPLACE(occurrence_id,'^ANH_([0-9]{1,3})_([ARET])_([DC])(_T2)?$','\3') jornada,
  CASE 
    WHEN occurrence_id ~ 'T2$' THEN 'T2'
    ELSE 'T1'
  END tempo
FROM raw_dwc.peces_event
)
SELECT anh_name,tempo,metodo, ARRAY_AGG(jornada ORDER BY jornada DESC),/*ARRAY_AGG(DISTINCT repli ORDER BY repli) repli,*/  count(*)
FROM a
GROUP BY anh_num,anh_name, tempo, metodo
ORDER BY anh_num IS NOT NULL,anh_num,tempo, metodo
;

```




## ANH



Insertar los datos de anh:

```{sql}
INSERT INTO main.punto_referencia(name_pt_ref, num_anh)
WITH a AS(
SELECT occurrence_id,
  REGEXP_REPLACE(occurrence_id,'^(ANH_[0-9]{1,3})_([ARET])_([DC])(_T2)?$','\1') anh_name,
  REGEXP_REPLACE(occurrence_id,'^ANH_([0-9]{1,3})_([ARET])_([DC])(_T2)?$','\1')::int anh_num
FROM raw_dwc.peces_event
)
SELECT anh_name, anh_num
FROM a
WHERE anh_name IS NOT NULL
GROUP BY anh_name,anh_num
ORDER BY anh_num
ON CONFLICT (name_pt_ref) DO NOTHING
RETURNING cd_pt_ref, name_pt_ref
;
```

dar las referencias en las tablas totales de peces

```{sql}
ALTER TABLE raw_dwc.peces_event ADD COLUMN cd_pt_ref int REFERENCES main.punto_referencia(cd_pt_ref) ON DELETE SET NULL ON UPDATE CASCADE;
ALTER TABLE raw_dwc.peces_registros ADD COLUMN cd_pt_ref int REFERENCES main.punto_referencia(cd_pt_ref) ON DELETE SET NULL ON UPDATE CASCADE;

UPDATE raw_dwc.peces_event AS m
SET cd_pt_ref=pr.cd_pt_ref
FROM main.punto_referencia pr
WHERE REGEXP_REPLACE(m.occurrence_id,'^(ANH_[0-9]{1,3})_([ARET])_([DC])(_T2)?$','\1') = pr.name_pt_ref
;

UPDATE raw_dwc.peces_registros AS m
SET cd_pt_ref=pr.cd_pt_ref
FROM main.punto_referencia pr
WHERE REGEXP_REPLACE(m.event_id,'^(ANH_[0-9]{1,3})_([ARET])_([DC])(_T2)?$','\1') = pr.name_pt_ref
;

SELECT true;
```

Averiguando que ninguna fila no tenga anh

```{sql}
SELECT occurrence_id FROM raw_dwc.peces_event WHERE cd_pt_ref IS NULL;
```

```{sql}
SELECT occurrence_id,occurrence_id FROM raw_dwc.peces_registros WHERE cd_pt_ref IS NULL;
```

## Unit, sampling efforts definition, abundance definition, protocolo

**En peces usualmente no se anota el tiempo final, pero el tiempo inicial y el sampling effort están muy limpios entonces es relativamente facil calcularlos**
Hay un error raro y es que en caso de electropesca, sampling_size_unit da 1 minuto cuando sampling effort pueda ser muy differente, voy a utilizar sampling effort

**Not sure about the vocabulary in english, particularly the difference between dragnet and trawlnets and what would better translate redes de arrastre in a continental set**



```{sql}
INSERT INTO main.def_unit(cd_measurement_type, unit, unit_spa, abbv_unit,factor)
VALUES(
  (SELECT cd_measurement_type FROM main.def_measurement_type WHERE measurement_type='number of traps'),
  'Number of throws',
  'Número de lances',
  'throws',
  1
  ),(
  (SELECT cd_measurement_type FROM main.def_measurement_type WHERE measurement_type='number of traps'),
  'Number of drag nets',
  'Número de arrastres',
  'drag nets',
  1
  )
RETURNING cd_unit, unit, unit_spa
```


```{sql}
INSERT INTO main.def_var_samp_eff(var_samp_eff, var_samp_eff_spa, cd_unit, type_variable)
  VALUES
    (
    'Number of throws',
    'Número de lances',
    (SELECT cd_unit FROM main.def_unit WHERE unit='Number of throws'),
    'int'
    ),(
    'Number of drag nets',
    'Número de arrastres',
    (SELECT cd_unit FROM main.def_unit WHERE unit='Number of drag nets'),
    'int'
    )

RETURNING cd_var_samp_eff,var_samp_eff;



```


```{sql}
INSERT INTO main.def_protocol(protocol,protocol_spa,cd_var_samp_eff_1,cd_var_samp_eff_2,samp_eff_1_implicit,samp_eff_2_implicit,cd_var_ind_qt,description_spa)
VALUES(
  'Cast nets',
  'Atarraya',
  (SELECT cd_var_samp_eff FROM main.def_var_samp_eff WHERE var_samp_eff='Number of throws'),
  (SELECT cd_var_samp_eff FROM main.def_var_samp_eff WHERE var_samp_eff='Elapsed time'),
  false,
  true,
  (SELECT cd_var_ind_qt FROM main.def_var_ind_qt WHERE var_qt_ind='Number of individuals'),
  'Tal vez sería bueno añadir las caracteristicas de los artes de pesca, pero no tengo acceso a esta información'
),(
  'Drag net',
  'Arrastre',
  (SELECT cd_var_samp_eff FROM main.def_var_samp_eff WHERE var_samp_eff='Number of drag nets'),
  (SELECT cd_var_samp_eff FROM main.def_var_samp_eff WHERE var_samp_eff='Elapsed time'),
  false,
  true,
  (SELECT cd_var_ind_qt FROM main.def_var_ind_qt WHERE var_qt_ind='Number of individuals'),
  'Tal vez sería bueno añadir las caracteristicas de los artes de pesca, pero no tengo acceso a esta información'
),(
  'Electric fishing',
  'Electropesca',
  (SELECT cd_var_samp_eff FROM main.def_var_samp_eff WHERE var_samp_eff='Elapsed time'),
  NULL,
  true,
  NULL,
  (SELECT cd_var_ind_qt FROM main.def_var_ind_qt WHERE var_qt_ind='Number of individuals'),
  NULL
),(
  'Gillnets',
  'Trasmallo',
  (SELECT cd_var_samp_eff FROM main.def_var_samp_eff WHERE var_samp_eff='Elapsed time'),
  NULL,
  true,
  NULL,
  (SELECT cd_var_ind_qt FROM main.def_var_ind_qt WHERE var_qt_ind='Number of individuals'),
  NULL
)
RETURNING cd_protocol,protocol,protocol_spa;
```

## Personas

```{sql}
INSERT INTO main.people(verbatim_person)
WITH a AS(
SELECT DISTINCT INITCAP(TRIM(UNNEST(STRING_TO_ARRAY(recorded_by, ' | ')))) AS name_person
FROM raw_dwc.peces_registros
UNION
SELECT DISTINCT INITCAP(TRIM(UNNEST(STRING_TO_ARRAY(identified_by, ' | '))))
FROM raw_dwc.peces_registros
)
SELECT DISTINCT REGEXP_REPLACE(name_person, '- ','-')
FROM a 
ORDER BY REGEXP_REPLACE(name_person, '- ','-')
ON CONFLICT(verbatim_person) DO NOTHING
RETURNING cd_person, verbatim_person
```

Dar los codigos a las tables de origen:

```{sql}
ALTER TABLE raw_dwc.peces_registros ADD COLUMN cds_recorded_by int[];

WITH a AS(
SELECT "row.names", REGEXP_REPLACE(INITCAP(TRIM(UNNEST(STRING_TO_ARRAY(recorded_by, ' | ')))),'- ','-') AS name_person
FROM raw_dwc.peces_registros
),b AS(
SELECT "row.names", ARRAY_AGG(cd_person) cds
FROM a 
LEFT JOIN main.people p ON a.name_person=p.verbatim_person
GROUP BY "row.names"
)
UPDATE raw_dwc.peces_registros AS r
SET cds_recorded_by=b.cds
FROM b
WHERE r."row.names"=b."row.names"
RETURNING r."row.names", cds_recorded_by
;

ALTER TABLE raw_dwc.peces_registros ADD COLUMN cds_identified_by int[];

WITH a AS(
SELECT "row.names", REGEXP_REPLACE(INITCAP(TRIM(UNNEST(STRING_TO_ARRAY(identified_by, ' | ')))),'- ','-') AS name_person
FROM raw_dwc.peces_registros
),b AS(
SELECT "row.names", ARRAY_AGG(cd_person) cds
FROM a 
LEFT JOIN main.people p ON a.name_person=p.verbatim_person
GROUP BY "row.names"
)
UPDATE raw_dwc.peces_registros AS r
SET cds_identified_by=b.cds
FROM b
WHERE r."row.names"=b."row.names"
RETURNING r."row.names", cds_identified_by
;

SELECT 1;
```

## gp_event

```{sql}
WITH a AS(
SELECT 
  occurrence_id,
  REGEXP_REPLACE(occurrence_id,'^(ANH_[0-9]{1,3})_([ARET])_([DC])(_T2)?$','\1') anh_name,
  REGEXP_REPLACE(occurrence_id,'^ANH_([0-9]{1,3})_([ARET])_([DC])(_T2)?$','\1')::int anh_num,
  REGEXP_REPLACE(occurrence_id,'^ANH_([0-9]{1,3})_([ARET])_([DC])(_T2)?$','\2') metodo,
  REGEXP_REPLACE(occurrence_id,'^ANH_([0-9]{1,3})_([ARET])_([DC])(_T2)?$','\3') jornada,
  CASE 
    WHEN occurrence_id ~ 'T2$' THEN 'T2'
    ELSE 'T1'
  END tempo
FROM raw_dwc.peces_event
)
SELECT tempo, anh_num,metodo, ARRAY_AGG(jornada), count(*)
FROM a
GROUP BY tempo, anh_num, metodo
ORDER BY tempo, anh_num, metodo
;
```

```{sql}
WITH a AS(
SELECT 
  occurrence_id,
  REGEXP_REPLACE(occurrence_id,'^(ANH_[0-9]{1,3})_([ARET])_([DC])(_T2)?$','\1') anh_name,
  REGEXP_REPLACE(occurrence_id,'^ANH_([0-9]{1,3})_([ARET])_([DC])(_T2)?$','\1')::int anh_num,
  REGEXP_REPLACE(occurrence_id,'^ANH_([0-9]{1,3})_([ARET])_([DC])(_T2)?$','\2') metodo,
  REGEXP_REPLACE(occurrence_id,'^ANH_([0-9]{1,3})_([ARET])_([DC])(_T2)?$','\3') jornada,
  CASE 
    WHEN occurrence_id ~ 'T2$' THEN 'T2'
    ELSE 'T1'
  END tempo
FROM raw_dwc.peces_event
)
SELECT anh_num, ARRAY_AGG(tempo) temporadas, ARRAY_AGG(metodo) metodos, ARRAY_AGG(jornada) jornadas, count(*)
FROM a
GROUP BY anh_num
ORDER BY anh_num
;
```

Because there is more than a method, the number of the campaign should be determined this way:

```{sql}
WITH a AS(
SELECT 
  occurrence_id,
  REGEXP_REPLACE(occurrence_id,'^(ANH_[0-9]{1,3})_([ARET])_([DC])(_T2)?$','\1') anh_name,
  REGEXP_REPLACE(occurrence_id,'^ANH_([0-9]{1,3})_([ARET])_([DC])(_T2)?$','\1')::int anh_num,
  REGEXP_REPLACE(occurrence_id,'^ANH_([0-9]{1,3})_([ARET])_([DC])(_T2)?$','\2') metodo,
  REGEXP_REPLACE(occurrence_id,'^ANH_([0-9]{1,3})_([ARET])_([DC])(_T2)?$','\3') jornada,
  CASE 
    WHEN occurrence_id ~ 'T2$' THEN 'T2'
    ELSE 'T1'
  END tempo
FROM raw_dwc.peces_event
)
SELECT tempo, anh_name, ROW_NUMBER() OVER (PARTITION BY anh_name ORDER BY tempo) campaign_nb
FROM a
GROUP BY tempo, anh_name
ORDER BY tempo, anh_name
;
```


```{sql}
INSERT INTO main.gp_event(cd_gp_biol,cd_protocol,cd_pt_ref,campaign_nb)
WITH a AS(
SELECT 
  occurrence_id,
  REGEXP_REPLACE(occurrence_id,'^(ANH_[0-9]{1,3})_([ARET])_([DC])(_T2)?$','\1') anh_name,
  REGEXP_REPLACE(occurrence_id,'^ANH_([0-9]{1,3})_([ARET])_([DC])(_T2)?$','\1')::int anh_num,
  REGEXP_REPLACE(occurrence_id,'^ANH_([0-9]{1,3})_([ARET])_([DC])(_T2)?$','\2') metodo,
  REGEXP_REPLACE(occurrence_id,'^ANH_([0-9]{1,3})_([ARET])_([DC])(_T2)?$','\3') jornada,
  CASE 
    WHEN occurrence_id ~ 'T2$' THEN 'T2'
    ELSE 'T1'
  END tempo,
  cd_pt_ref
FROM raw_dwc.peces_event
), campaign AS(
SELECT tempo, anh_name, ROW_NUMBER() OVER (PARTITION BY anh_name ORDER BY tempo) campaign_nb
FROM a
GROUP BY tempo, anh_name
ORDER BY tempo, anh_name
)
SELECT 'pece',
  CASE
    WHEN metodo='A' THEN (SELECT cd_protocol FROM main.def_protocol WHERE protocol_spa='Atarraya')
    WHEN metodo='R' THEN (SELECT cd_protocol FROM main.def_protocol WHERE protocol_spa='Arrastre')
    WHEN metodo='E' THEN (SELECT cd_protocol FROM main.def_protocol WHERE protocol_spa='Electropesca')
    WHEN metodo='T' THEN (SELECT cd_protocol FROM main.def_protocol WHERE protocol_spa='Trasmallo')
  END cd_protocol,
  cd_pt_ref,
  c.campaign_nb
FROM a
LEFT JOIN campaign c ON c.tempo=a.tempo AND (c.anh_name=a.anh_name OR (c.anh_name IS NULL AND a.anh_name IS NULL))
LEFT JOIN main.punto_referencia USING (cd_pt_ref)
GROUP BY cd_pt_ref, name_pt_ref, a.tempo, metodo, c.campaign_nb
ORDER BY a.tempo,cd_pt_ref,cd_protocol
RETURNING cd_gp_event,cd_gp_biol,cd_protocol,cd_pt_ref,campaign_nb,subpart
;
```

Attributing the gp_event

```{sql}
ALTER TABLE raw_dwc.peces_event ADD COLUMN cd_gp_event int REFERENCES main.gp_event(cd_gp_event) ON DELETE SET NULL;


WITH a AS(
SELECT 
  occurrence_id,
  REGEXP_REPLACE(occurrence_id,'^(ANH_[0-9]{1,3})_([ARET])_([DC])(_T2)?$','\1') anh_name,
  REGEXP_REPLACE(occurrence_id,'^ANH_([0-9]{1,3})_([ARET])_([DC])(_T2)?$','\1')::int anh_num,
  REGEXP_REPLACE(occurrence_id,'^ANH_([0-9]{1,3})_([ARET])_([DC])(_T2)?$','\2') metodo,
  REGEXP_REPLACE(occurrence_id,'^ANH_([0-9]{1,3})_([ARET])_([DC])(_T2)?$','\3') jornada,
  CASE 
    WHEN occurrence_id ~ 'T2$' THEN 'T2'
    ELSE 'T1'
  END tempo,
  cd_pt_ref
FROM raw_dwc.peces_event
), campaign AS(
SELECT tempo, anh_name, ROW_NUMBER() OVER (PARTITION BY anh_name ORDER BY tempo) campaign_nb
FROM a
GROUP BY tempo, anh_name
ORDER BY tempo, anh_name
),b AS(
SELECT occurrence_id,
  CASE
    WHEN metodo='A' THEN (SELECT cd_protocol FROM main.def_protocol WHERE protocol_spa='Atarraya')
    WHEN metodo='R' THEN (SELECT cd_protocol FROM main.def_protocol WHERE protocol_spa='Arrastre')
    WHEN metodo='E' THEN (SELECT cd_protocol FROM main.def_protocol WHERE protocol_spa='Electropesca')
    WHEN metodo='T' THEN (SELECT cd_protocol FROM main.def_protocol WHERE protocol_spa='Trasmallo')
  END cd_protocol,
  cd_pt_ref,
  c.campaign_nb
FROM a
LEFT JOIN campaign c ON c.tempo=a.tempo AND (c.anh_name=a.anh_name OR (c.anh_name IS NULL AND a.anh_name IS NULL))
LEFT JOIN main.punto_referencia USING (cd_pt_ref)
),d AS(
SELECT b.*, cd_gp_event
FROM b
LEFT JOIN main.gp_event ge ON cd_gp_biol='pece' AND b.cd_protocol=ge.cd_protocol AND ((b.cd_pt_ref=ge.cd_pt_ref) OR (b.cd_pt_ref IS NULL AND ge.cd_pt_ref IS NULL)) AND b.campaign_nb=ge.campaign_nb 
)
UPDATE raw_dwc.peces_event e
SET cd_gp_event=d.cd_gp_event
FROM d
WHERE d.occurrence_id=e.occurrence_id
RETURNING e.occurrence_id, e.cd_gp_event
;

SELECT occurrence_id
FROM raw_dwc.peces_event
WHERE cd_gp_event IS NULL;
```

## event

**Peces (como aves) has sampl*ing* while the others have sampl*e* in the name of the columns**

**los eventos no tienen hora final... voy a considerar que la hora + tiempo de grabación da la hora final**

**los comentarios sobre los eventos son muy largos, para guardar una lisibilidad de la tabla, se van a poner en la tabla extra**

\footnotesize

```{sql}
INSERT INTO main.event(cd_gp_event,event_id,num_replicate, description_replicate, date_time_begin, date_time_end, locality_verb, event_remarks, samp_effort_1, samp_effort_2, pt_geom)
WITH a AS(
SELECT cd_gp_event,
  occurrence_id, 
  REGEXP_REPLACE(occurrence_id,'^(ANH_[0-9]{1,3})_([ARET])_([DC])(_T2)?$','\1') anh_name,
  REGEXP_REPLACE(occurrence_id,'^ANH_([0-9]{1,3})_([ARET])_([DC])(_T2)?$','\1')::int anh_num,
  REGEXP_REPLACE(occurrence_id,'^ANH_([0-9]{1,3})_([ARET])_([DC])(_T2)?$','\2') metodo,
  REGEXP_REPLACE(occurrence_id,'^ANH_([0-9]{1,3})_([ARET])_([DC])(_T2)?$','\3') jornada,
  CASE 
    WHEN occurrence_id ~ 'T2$' THEN 'T2'
    ELSE 'T1'
 END tempo,
  --TO_DATE(SPLIT_PART(event_date,'/',1), 'YYYY-MM-DD') date_1,
  TO_DATE(event_date, 'YYYY-MM-DD') date_1,
  /*CASE 
    WHEN SPLIT_PART(event_date,'/',2)='' THEN NULL
    WHEN SPLIT_PART(event_date,'/',2) ~ '^[0-9]{2}-[0-9]{2}-[0-9]{2}$' THEN TO_DATE('20'||SPLIT_PART(event_date,'/',2), 'YYYY-MM-DD')

    ELSE TO_DATE(SPLIT_PART(event_date,'/',2), 'YYYY-MM-DD')
  END date_2,*/
  NULL as date_2,
  --REGEXP_REPLACE(SPLIT_PART(REGEXP_REPLACE(event_time,'-','/'),'/',1),'\s+','','g')::time hora_1,
  REGEXP_REPLACE(event_time,'\s+','','g')::time hora_1,
  /*CASE
  	WHEN REGEXP_REPLACE(SPLIT_PART(REGEXP_REPLACE(event_time,'-','/'),'/',2),'\s+','','g')='' THEN NULL
	ELSE REGEXP_REPLACE(SPLIT_PART(REGEXP_REPLACE(event_time,'-','/'),'/',2),'\s+','','g')::time
  END hora_2,*/
  NULL hora_2,
  locality locality_verb,
  --sample_size_value,
  sampling_size_value,
  --sample_size_unit,
  sampling_size_unit,
  sampling_effort,
  REGEXP_REPLACE(REGEXP_REPLACE(location_remarks, '\|? ?No hay registros de individuos ?',''),'\|? ?No se registran individuos','') event_remarks,
  --event_remarks,
  decimal_latitude::double precision,
  decimal_longitude::double precision
FROM raw_dwc.peces_event
)--calculation of timestamps, coordinates and num_replicate
SELECT 
  cd_gp_event,
  occurrence_id, 
  ROW_NUMBER() OVER (PARTITION BY cd_gp_event ORDER BY jornada DESC) num_replicate,
  'jornada:'||jornada description_replicate,
  (date_1||' '||hora_1)::timestamp date_time_begin,
  ((date_1||' '||hora_1)::timestamp) + (REGEXP_REPLACE(REGEXP_REPLACE(sampling_effort,'[mM]inutos?','minutes'),'[Hh]oras?','hours'))::interval date_time_end,
  locality_verb,
  event_remarks ,
  CASE
   WHEN metodo IN ('A','R') THEN sampling_size_value::double precision
   WHEN metodo IN ('E','T') THEN REGEXP_REPLACE(sampling_effort,' *minutos? *','')::double precision
  END samp_eff_1,
  CASE
   WHEN metodo IN ('A','R') THEN REGEXP_REPLACE(sampling_effort,' *minutos? *','')::double precision
  END samp_eff_2,
  ST_SetSRID(ST_Transform(ST_SetSRID(ST_MakePoint(decimal_longitude,decimal_latitude),4326),(SELECT proj4text FROM spatial_ref_sys WHERE srid=3116)),3116) pt_geom
FROM a
LEFT JOIN main.gp_event USING (cd_gp_event)
LEFT JOIN main.def_protocol p USING (cd_protocol)
ORDER BY cd_gp_event, occurrence_id, num_replicate

RETURNING main.event.cd_event, main.event.cd_gp_event, event_id, main.event.num_replicate, main.event.description_replicate, main.event.date_time_begin, main.event.date_time_end, main.event.locality_verb, main.event.event_remarks, main.event.pt_geom
```

Damos los cd_event a todos las filas:

```{sql}
ALTER TABLE raw_dwc.peces_event ADD COLUMN cd_event int REFERENCES main.event(cd_event) ON DELETE SET NULL;
ALTER TABLE raw_dwc.peces_registros ADD COLUMN cd_event int REFERENCES main.event(cd_event);

UPDATE raw_dwc.peces_event AS t
SET cd_event=e.cd_event
FROM main.event e
WHERE t.occurrence_id=e.event_id;

UPDATE raw_dwc.peces_registros AS t
SET cd_event=e.cd_event
FROM main.event e
WHERE t.event_id=e.event_id;

SELECT true;
```

### comentarios largos sobre los eventos

```{sql}
INSERT INTO main.def_var_event_extra(var_event_extra, type_var, var_event_extra_spa, var_event_extra_comment)
VALUES
  ('big_remarks',
  'free text',
  'comentarios_largos',
  'This variable exists when the comments are too large to allow readibility of the event table'
  );

INSERT INTO main.event_extra(cd_event, cd_var_event_extra,value_text)
SELECT cd_event, 
  (SELECT cd_var_event_extra FROM main.def_var_event_extra WHERE var_event_extra = 'big_remarks'),
  event_remarks
FROM raw_dwc.peces_event
WHERE  event_remarks IS NOT NULL
;


```

### Añadir la jornada

```{sql}
INSERT INTO main.def_var_event_extra(var_event_extra, type_var, var_event_extra_spa, var_event_extra_comment)
VALUES
  ('period',
  'categorial',
  'jornada',
  NULL
  );
INSERT INTO main.def_categ_event_extra(categ,cd_var_event_extra,categ_spa)
VALUES
  ('Day',
  (SELECT cd_var_event_extra FROM main.def_var_event_extra WHERE var_event_extra='period'),
  'Día'
  ),
  ('Night',
  (SELECT cd_var_event_extra FROM main.def_var_event_extra WHERE var_event_extra='period'),
  'Noche'
  ),
  ('Dusk',
  (SELECT cd_var_event_extra FROM main.def_var_event_extra WHERE var_event_extra='period'),
  'Crepuscular'
  );
INSERT INTO main.event_extra(cd_event,cd_categ_event_extra,cd_var_event_extra)
SELECT cd_event,
  CASE
    WHEN description_replicate~'D$' THEN (SELECT cd_categ_event_extra FROM main.def_categ_event_extra WHERE categ='Day')
    WHEN description_replicate~'C$' THEN (SELECT cd_categ_event_extra FROM main.def_categ_event_extra WHERE categ='Dusk')
  END cd_categ,
  (SELECT cd_var_event_extra FROM main.def_var_event_extra WHERE var_event_extra='period')
FROM main.event
LEFT JOIN main.gp_event USING (cd_gp_event)
WHERE cd_gp_biol='pece' AND description_replicate ~ '[DC]$'
;


```
## registros


```{sql}
SELECT occurrence_id, count(*)
FROM raw_dwc.peces_registros 
GROUP BY occurrence_id
HAVING count(*)>1;
```


No horas ni fechas en los registros...


**No hay organism_id**


```{sql}
INSERT INTO main.registros(cd_event, cds_recorded_by, date_time, cd_tax, cd_morfo, date_ident, cds_identified_by, qt_int,remarks, occurrence_id, organism_id)
SELECT 
 cd_event,
 cds_recorded_by,
 NULL::timestamp AS date_time,
 tt.cd_tax,
 tt.cd_morfo,
 TO_DATE(date_identified,'YYYY-MM-DD') date_ident,
 cds_identified_by,
 CASE
  WHEN var_qt_ind ='Occurrence' AND organism_quantity IS NULL THEN 1
  ELSE organism_quantity::double precision::int 
 END qt_int,
 occurrence_remarks remarks,
 --r.event_remarks remarks,
 r.occurrence_id,
 SPLIT_PART(occurrence_id,':',7) organism_id
 --ROW_NUMBER() OVER (ORDER BY (e.date_time_begin::date||' '||event_time)::timestamp)
 --organism_id,
 --ST_SetSRID(ST_Transform(ST_SetSRID(ST_MakePoint(measurement_value__longitud_,measurement_value__latitud_), 4326),  (SELECT proj4text FROM spatial_ref_sys WHERE srid=3116)),3116)
FROM raw_dwc.peces_registros r
LEFT JOIN raw_dwc.taxonomy_total tt ON tt."row.names"=r."row.names" AND tt.table_orig='peces_registros'
LEFT JOIN main.event e USING (cd_event)
LEFT JOIN main.gp_event USING (cd_gp_event)
LEFT JOIN main.def_protocol USING (cd_protocol)
LEFT JOIN main.def_var_ind_qt USING(cd_var_ind_qt)
ORDER BY date_time

RETURNING cd_event, cds_recorded_by, date_time, cd_tax, cd_morfo, cds_identified_by, qt_int,remarks, occurrence_id, organism_id
```

```{sql}
ALTER TABLE raw_dwc.peces_registros ADD COLUMN cd_reg int REFERENCES main.registros(cd_reg);

UPDATE raw_dwc.peces_registros AS ar
SET cd_reg=r.cd_reg
FROM main.registros r
WHERE ar.cd_event=r.cd_event AND ar.occurrence_id=r.occurrence_id;

-- Check cd_reg are unique in the source table
SELECT cd_reg,count(*) FROM  raw_dwc.peces_registros GROUP BY cd_reg HAVING count(*)>1;
```

**TODO: Añadir la variables ambientales y las variables de habitats especificas a los habitats acuaticos**


# Hidrobiologicos 

## Crear la tabla total de registros


```{sql}
WITH fipl AS(
SELECT table_name, column_name, ordinal_position, data_type
FROM information_schema.columns
WHERE table_name='hidrobiologico_registros_fitoplancton'
),zopl AS(
SELECT table_name, column_name, ordinal_position, data_type
FROM information_schema.columns
WHERE table_name='hidrobiologico_registros_zooplancton'
),peri AS(
SELECT table_name, column_name, ordinal_position, data_type
FROM information_schema.columns
WHERE table_name='hidrobiologico_registros_perifiton'
),mafi AS(
SELECT table_name, column_name, ordinal_position, data_type
FROM information_schema.columns
WHERE table_name='hidrobiologico_registros_macrofitas'
),minv AS(
SELECT table_name, column_name, ordinal_position, data_type
FROM information_schema.columns
WHERE table_name='hidrobiologico_registros_macroinvertebrados'
)
SELECT column_name, 
ARRAY[fipl.table_name,zopl.table_name,peri.table_name,mafi.table_name,minv.table_name],
ARRAY[fipl.data_type,zopl.data_type,peri.data_type,mafi.data_type,minv.data_type]
FROM fipl
FULL OUTER JOIN zopl USING (column_name)
FULL OUTER JOIN peri USING (column_name)
FULL OUTER JOIN mafi USING (column_name)
FULL OUTER JOIN minv USING (column_name)
ORDER BY COALESCE(fipl.ordinal_position,zopl.ordinal_position,peri.ordinal_position,mafi.ordinal_position,minv.ordinal_position);
```

```{sql}
CREATE TABLE raw_dwc.hidrobiologico_registros AS(
SELECT 
 'hidrobiologico_registros_fitoplancton' AS table_orig,
 "row.names"::text,
 "occurrence_id"::text,
 "event_id"::text,
 "basis_of_record"::text,
 "type"::text,
 "institution_code"::text,
 "collection_code"::text,
 "record_number"::double precision,
 "recorded_by"::text,
 "organism_quantity"::text,
 "organism_quantity_type"::text,
 NULL::text AS "organ_ism_quant_ity_type",
 "preparations"::text,
 "sampling_protocol"::text,
 "sampling_effort"::text,
 "identified_by"::text,
 "date_identified"::text,
 NULL::text AS "identification_remarks",
 "identification_qualifier"::text,
 "scientific_name"::text,
 "kingdom"::text,
 "phylum"::text,
 "class"::text,
 "order"::text,
 "family"::text,
 "genus"::text,
 "specific_epithet"::text,
 "taxon_rank"::text,
 "scientific_name_authorship"::text,
 "title"::text,
 "type_1"::text,
 "format"::text,
 "creator"::text,
 "created"::text,
 "measurement_type__abundancia_relativa_"::text,
 "measurement_value__abundancia_relativa_"::double precision,
 NULL::text AS "measurement_type__cobertura_de_cada_una_de_las_especies__%__",
 NULL::text AS "measurement_value__cobertura_de_cada_una_de_las_especies__%__",
 "measurement_unit__abundancia_relativa_"::text,
 NULL::text AS "measurement_type__área_total_raspada_por_muestra_",
 "measurement_type__volumen_filtrado_"::text,
 NULL::text AS "measurement_unit__cobertura_de_cada_una_de_las_especies__%__",
 NULL::text AS "measurement_type__área_total_muestreada_por_estación_",
 "measurement_value__volumen_filtrado_"::double precision,
 NULL::double precision AS "measurement_value__área_total_raspada_por_muestra_",
 NULL::text AS "measurement_unit__área_total_raspada_por_muestra_",
 "measurement_unit__volumen_filtrado_"::text,
 NULL::double precision AS "measurement_value__área_total_muestreada_por_estación_",
 NULL::text AS "measurement_unit__área_total_muestreada_por_estación_",
 "measurement_type__profundidad_de_capa_fótica_"::text,
 NULL::text AS "measurement_type__área_total_muestreada_para_hidrofitos_",
 "measurement_value__profundidad_de_capa_fótica_"::double precision,
 NULL::text AS "measurement_type__área_total_raspada_por_estación_",
 "measurement_unit__profundidad_de_capa_fótica_"::text,
 NULL::double precision AS "measurement_value__área_total_raspada_por_estación_",
 NULL::double precision AS "measurement_value__área_total_muestreada_para_hidrofitos_",
 NULL::text AS "measurement_unit__área_total_muestreada_para_hidrofitos_",
 NULL::text AS "measurement_unit__área_total_raspada_por_estación_",
 "measurement_type__profundidad_total_"::text,
 "measurement_value__profundidad_total_"::double precision,
 NULL::text AS "measurement_type__área_total_muestreada_en_zona_de_helófitas_",
 NULL::double precision AS "measurement_value__área_total_muestreada_en_zona_de_helófitas",
 "measurement_unit__profundidad_total_"::text,
 NULL::text AS "measurement_unit__área_total_muestreada_en_zona_de_helófitas_"
FROM raw_dwc.hidrobiologico_registros_fitoplancton
UNION ALL
SELECT 
 'hidrobiologico_registros_zooplancton' AS table_orig,
 "row.names"::text,
 "occurrence_id"::text,
 "event_id"::text,
 "basis_of_record"::text,
 "type"::text,
 "institution_code"::text,
 "collection_code"::text,
 "record_number"::double precision,
 "recorded_by"::text,
 "organism_quantity"::text,
 "organism_quantity_type"::text,
 NULL::text AS "organ_ism_quant_ity_type",
 "preparations"::text,
 "sampling_protocol"::text,
 "sampling_effort"::text,
 "identified_by"::text,
 "date_identified"::text,
 NULL::text AS "identification_remarks",
 "identification_qualifier"::text,
 "scientific_name"::text,
 "kingdom"::text,
 "phylum"::text,
 "class"::text,
 "order"::text,
 "family"::text,
 "genus"::text,
 "specific_epithet"::text,
 "taxon_rank"::text,
 "scientific_name_authorship"::text,
 "title"::text,
 "type_1"::text,
 "format"::text,
 "creator"::text,
 "created"::text,
 "measurement_type__abundancia_relativa_"::text,
 "measurement_value__abundancia_relativa_"::double precision,
 NULL::text AS "measurement_type__cobertura_de_cada_una_de_las_especies__%__",
 NULL::text AS "measurement_value__cobertura_de_cada_una_de_las_especies__%__",
 "measurement_unit__abundancia_relativa_"::text,
 NULL::text AS "measurement_type__área_total_raspada_por_muestra_",
 "measurement_type__volumen_filtrado_"::text,
 NULL::text AS "measurement_unit__cobertura_de_cada_una_de_las_especies__%__",
 NULL::text AS "measurement_type__área_total_muestreada_por_estación_",
 "measurement_value__volumen_filtrado_"::double precision,
 NULL::double precision AS "measurement_value__área_total_raspada_por_muestra_",
 NULL::text AS "measurement_unit__área_total_raspada_por_muestra_",
 "measurement_unit__volumen_filtrado_"::text,
 NULL::double precision AS "measurement_value__área_total_muestreada_por_estación_",
 NULL::text AS "measurement_unit__área_total_muestreada_por_estación_",
 "measurement_type__profundidad_de_capa_fótica_"::text,
 NULL::text AS "measurement_type__área_total_muestreada_para_hidrofitos_",
 "measurement_value__profundidad_de_capa_fótica_"::double precision,
 NULL::text AS "measurement_type__área_total_raspada_por_estación_",
 "measurement_unit__profundidad_de_capa_fótica_"::text,
 NULL::double precision AS "measurement_value__área_total_raspada_por_estación_",
 NULL::double precision AS "measurement_value__área_total_muestreada_para_hidrofitos_",
 NULL::text AS "measurement_unit__área_total_muestreada_para_hidrofitos_",
 NULL::text AS "measurement_unit__área_total_raspada_por_estación_",
 "measurement_type__profundidad_total_"::text,
 "measurement_value__profundidad_total_"::double precision,
 NULL::text AS "measurement_type__área_total_muestreada_en_zona_de_helófitas_",
 NULL::double precision AS "measurement_value__área_total_muestreada_en_zona_de_helófitas",
 "measurement_unit__profundidad_total_"::text,
 NULL::text AS "measurement_unit__área_total_muestreada_en_zona_de_helófitas_"
FROM raw_dwc.hidrobiologico_registros_zooplancton
UNION ALL
SELECT 
 'hidrobiologico_registros_perifiton' AS table_orig,
 "row.names"::text,
 "occurrence_id"::text,
 "event_id"::text,
 "basis_of_record"::text,
 "type"::text,
 "institution_code"::text,
 "collection_code"::text,
 "record_number"::double precision,
 "recorded_by"::text,
 "organism_quantity"::text,
 NULL::text AS "organism_quantity_type",
 "organ_ism_quant_ity_type"::text,
 "preparations"::text,
 "sampling_protocol"::text,
 "sampling_effort"::text,
 "identified_by"::text,
 "date_identified"::text,
 NULL::text AS "identification_remarks",
 "identification_qualifier"::text,
 "scientific_name"::text,
 "kingdom"::text,
 "phylum"::text,
 "class"::text,
 "order"::text,
 "family"::text,
 "genus"::text,
 "specific_epithet"::text,
 "taxon_rank"::text,
 "scientific_name_authorship"::text,
 "title"::text,
 "type_1"::text,
 "format"::text,
 "creator"::text,
 "created"::text,
 "measurement_type__abundancia_relativa_"::text,
 "measurement_value__abundancia_relativa_"::double precision,
 NULL::text AS "measurement_type__cobertura_de_cada_una_de_las_especies__%__",
 NULL::text AS "measurement_value__cobertura_de_cada_una_de_las_especies__%__",
 "measurement_unit__abundancia_relativa_"::text,
 "measurement_type__área_total_raspada_por_muestra_"::text,
 NULL::text AS "measurement_type__volumen_filtrado_",
 NULL::text AS "measurement_unit__cobertura_de_cada_una_de_las_especies__%__",
 NULL::text AS "measurement_type__área_total_muestreada_por_estación_",
 NULL::double precision AS "measurement_value__volumen_filtrado_",
 "measurement_value__área_total_raspada_por_muestra_"::double precision,
 "measurement_unit__área_total_raspada_por_muestra_"::text,
 NULL::text AS "measurement_unit__volumen_filtrado_",
 NULL::double precision AS "measurement_value__área_total_muestreada_por_estación_",
 NULL::text AS "measurement_unit__área_total_muestreada_por_estación_",
 NULL::text AS "measurement_type__profundidad_de_capa_fótica_",
 NULL::text AS "measurement_type__área_total_muestreada_para_hidrofitos_",
 NULL::double precision AS "measurement_value__profundidad_de_capa_fótica_",
 NULL::text AS "measurement_type__área_total_raspada_por_estación_",
 NULL::text AS "measurement_unit__profundidad_de_capa_fótica_",
 NULL::double precision AS "measurement_value__área_total_raspada_por_estación_",
 NULL::double precision AS "measurement_value__área_total_muestreada_para_hidrofitos_",
 NULL::text AS "measurement_unit__área_total_muestreada_para_hidrofitos_",
 NULL::text AS "measurement_unit__área_total_raspada_por_estación_",
 NULL::text AS "measurement_type__profundidad_total_",
 NULL::double precision AS "measurement_value__profundidad_total_",
 NULL::text AS "measurement_type__área_total_muestreada_en_zona_de_helófitas_",
 NULL::double precision AS "measurement_value__área_total_muestreada_en_zona_de_helófitas",
 NULL::text AS "measurement_unit__profundidad_total_",
 NULL::text AS "measurement_unit__área_total_muestreada_en_zona_de_helófitas_"
FROM raw_dwc.hidrobiologico_registros_perifiton
UNION ALL
SELECT 
 'hidrobiologico_registros_macrofitas' AS table_orig,
 "row.names"::text,
 "occurrence_id"::text,
 "event_id"::text,
 "basis_of_record"::text,
 "type"::text,
 "institution_code"::text,
 "collection_code"::text,
 "record_number"::double precision,
 "recorded_by"::text,
 "organism_quantity"::text,
 "organism_quantity_type"::text,
 NULL::text AS "organ_ism_quant_ity_type",
 "preparations"::text,
 "sampling_protocol"::text,
 "sampling_effort"::text,
 "identified_by"::text,
 "date_identified"::text,
 "identification_remarks"::text,
 "identification_qualifier"::text,
 "scientific_name"::text,
 "kingdom"::text,
 "phylum"::text,
 "class"::text,
 "order"::text,
 "family"::text,
 "genus"::text,
 "specific_epithet"::text,
 "taxon_rank"::text,
 "scientific_name_authorship"::text,
 "title"::text,
 "type_1"::text,
 "format"::text,
 "creator"::text,
 "created"::text,
 NULL::text AS "measurement_type__abundancia_relativa_",
 NULL::double precision AS "measurement_value__abundancia_relativa_",
 "measurement_type__cobertura_de_cada_una_de_las_especies__%__"::text,
 "measurement_value__cobertura_de_cada_una_de_las_especies__%__"::text,
 NULL::text AS "measurement_unit__abundancia_relativa_",
 NULL::text AS "measurement_type__área_total_raspada_por_muestra_",
 NULL::text AS "measurement_type__volumen_filtrado_",
 "measurement_unit__cobertura_de_cada_una_de_las_especies__%__"::text,
 "measurement_type__área_total_muestreada_por_estación_"::text,
 NULL::double precision AS "measurement_value__volumen_filtrado_",
 NULL::double precision AS "measurement_value__área_total_raspada_por_muestra_",
 NULL::text AS "measurement_unit__área_total_raspada_por_muestra_",
 NULL::text AS "measurement_unit__volumen_filtrado_",
 "measurement_value__área_total_muestreada_por_estación_"::double precision,
 "measurement_unit__área_total_muestreada_por_estación_"::text,
 NULL::text AS "measurement_type__profundidad_de_capa_fótica_",
 "measurement_type__área_total_muestreada_para_hidrofitos_"::text,
 NULL::double precision AS "measurement_value__profundidad_de_capa_fótica_",
 NULL::text AS "measurement_type__área_total_raspada_por_estación_",
 NULL::text AS "measurement_unit__profundidad_de_capa_fótica_",
 NULL::double precision AS "measurement_value__área_total_raspada_por_estación_",
 "measurement_value__área_total_muestreada_para_hidrofitos_"::double precision,
 "measurement_unit__área_total_muestreada_para_hidrofitos_"::text,
 NULL::text AS "measurement_unit__área_total_raspada_por_estación_",
 NULL::text AS "measurement_type__profundidad_total_",
 NULL::double precision AS "measurement_value__profundidad_total_",
 "measurement_type__área_total_muestreada_en_zona_de_helófitas_"::text,
 "measurement_value__área_total_muestreada_en_zona_de_helófitas"::double precision,
 NULL::text AS "measurement_unit__profundidad_total_",
 "measurement_unit__área_total_muestreada_en_zona_de_helófitas_"::text
FROM raw_dwc.hidrobiologico_registros_macrofitas
UNION ALL
SELECT 
 'hidrobiologico_registros_macroinvertebrados' AS table_orig,
"row.names"::text,
 "occurrence_id"::text,
 "event_id"::text,
 "basis_of_record"::text,
 "type"::text,
 "institution_code"::text,
 "collection_code"::text,
 "record_number"::double precision,
 "recorded_by"::text,
 "organism_quantity"::text,
 "organism_quantity_type"::text,
 NULL::text AS "organ_ism_quant_ity_type",
 "preparations"::text,
 "sampling_protocol"::text,
 "sampling_effort"::text,
 "identified_by"::text,
 "date_identified"::text,
 "identification_remarks"::text,
 "identification_qualifier"::text,
 "scientific_name"::text,
 "kingdom"::text,
 "phylum"::text,
 "class"::text,
 "order"::text,
 "family"::text,
 "genus"::text,
 "specific_epithet"::text,
 "taxon_rank"::text,
 "scientific_name_authorship"::text,
 "title"::text,
 "type_1"::text,
 "format"::text,
 "creator"::text,
 "created"::text,
 "measurement_type__abundancia_relativa_"::text,
 "measurement_value__abundancia_relativa_"::double precision,
 NULL::text AS "measurement_type__cobertura_de_cada_una_de_las_especies__%__",
 NULL::text AS "measurement_value__cobertura_de_cada_una_de_las_especies__%__",
 "measurement_unit__abundancia_relativa_"::text,
 "measurement_type__área_total_raspada_por_muestra_"::text,
 NULL::text AS "measurement_type__volumen_filtrado_",
 NULL::text AS "measurement_unit__cobertura_de_cada_una_de_las_especies__%__",
 NULL::text AS "measurement_type__área_total_muestreada_por_estación_",
 NULL::double precision AS "measurement_value__volumen_filtrado_",
 "measurement_value__área_total_raspada_por_muestra_"::double precision,
 "measurement_unit__área_total_raspada_por_muestra_"::text,
 NULL::text AS "measurement_unit__volumen_filtrado_",
 NULL::double precision AS "measurement_value__área_total_muestreada_por_estación_",
 NULL::text AS "measurement_unit__área_total_muestreada_por_estación_",
 NULL::text AS "measurement_type__profundidad_de_capa_fótica_",
 NULL::text AS "measurement_type__área_total_muestreada_para_hidrofitos_",
 NULL::double precision AS "measurement_value__profundidad_de_capa_fótica_",
 "measurement_type__área_total_raspada_por_estación_"::text,
 NULL::text AS "measurement_unit__profundidad_de_capa_fótica_",
 "measurement_value__área_total_raspada_por_estación_"::double precision,
 NULL::double precision AS "measurement_value__área_total_muestreada_para_hidrofitos_",
 NULL::text AS "measurement_unit__área_total_muestreada_para_hidrofitos_",
 "measurement_unit__área_total_raspada_por_estación_"::text,
 NULL::text AS "measurement_type__profundidad_total_",
 NULL::double precision AS "measurement_value__profundidad_total_",
 NULL::text AS "measurement_type__área_total_muestreada_en_zona_de_helófitas_",
 NULL::double precision AS "measurement_value__área_total_muestreada_en_zona_de_helófitas",
 NULL::text AS "measurement_unit__profundidad_total_",
 NULL::text AS "measurement_unit__área_total_muestreada_en_zona_de_helófitas_"
FROM raw_dwc.hidrobiologico_registros_macroinvertebrados
);


SELECT occurrence_id,count(*)
FROM raw_dwc.hidrobiologico_registros
GROUP BY occurrence_id
HAVING count(*)>1;
```

Podemos ver que, a pesar de esta asociación, los occurrence_id son unicos en la tabla total.


## Entender el plan de muestreo

Ya tenía entendido que las campañas de 2022 correspondían al periodo de aguas bajas, pero parece que hay 3 eventos de 2021 en aguas bajas

```{sql}
SELECT event_id,sampling_protocol
FROM raw_dwc.hidrobiologico_event
WHERE event_id!~'^ANH([0-9]{1,3})-((F)|(MA)|(MI)|(P)|(Z))(-([ABC]))?(-Bajas)?$'
```

```{sql}
WITH a AS(
SELECT event_id,
  REGEXP_REPLACE(event_id,'^(ANH[0-9]{1,3})-((F)|(MA)|(MI)|(P)|(Z))(-([ABC]))?(-Bajas)?$','\1') anh_name,
  REGEXP_REPLACE(event_id,'^ANH([0-9]{1,3})-((F)|(MA)|(MI)|(P)|(Z))(-([ABC]))?(-Bajas)?$','\1')::int anh_num,
  REGEXP_REPLACE(event_id,'^ANH([0-9]{1,3})-((F)|(MA)|(MI)|(P)|(Z))(-([ABC]))?(-Bajas)?$','\2') grupo,
  REGEXP_REPLACE(event_id,'^ANH([0-9]{1,3})-((F)|(MA)|(MI)|(P)|(Z))(-([ABC]))?(-Bajas)?$','\9') repl,
  REGEXP_REPLACE(event_id,'^ANH[0-9]{1,3}-((F)|(MA)|(MI)|(P)|(Z))(-([ABC]))?(-Bajas)?$','\9') ='-Bajas' aguas_bajas,
  EXTRACT(YEAR FROM TO_DATE(event_date,'YYYY-MM-DD')) año,
  event_date
FROM raw_dwc.hidrobiologico_event
)
SELECT event_id, aguas_bajas, año, repl, event_date
FROM a
WHERE año=2021 AND aguas_bajas
```


```{sql}
WITH a AS(
SELECT event_id,
  REGEXP_REPLACE(event_id,'^ANH([0-9]{1,3})-((F)|(MA)|(MI)|(P)|(Z))(-([ABC]))?(-Bajas)?$','\1')::int anh_num,
  REGEXP_REPLACE(event_id,'^ANH([0-9]{1,3})-((F)|(MA)|(MI)|(P)|(Z))(-([ABC]))?(-Bajas)?$','\2') grupo,
  REGEXP_REPLACE(event_id,'^ANH([0-9]{1,3})-((F)|(MA)|(MI)|(P)|(Z))(-([ABC]))?(-Bajas)?$','\9') repl,
  REGEXP_REPLACE(event_id,'^ANH[0-9]{1,3}-((F)|(MA)|(MI)|(P)|(Z))(-([ABC]))?(-Bajas)?$','\9') ='-Bajas' aguas_bajas,
  EXTRACT(YEAR FROM TO_DATE(event_date,'YYYY-MM-DD')) año
FROM raw_dwc.hidrobiologico_event
)
SELECT anh_num, grupo, año, aguas_bajas, ARRAY_AGG(repl ORDER BY repl)
FROM a
GROUP BY anh_num, aguas_bajas, grupo, año
ORDER BY anh_num, grupo, año
```

**IMPORTANTE: limpiar los protocolos de muestreo del perifiton y de los macroinvertebrados**


**Acá, parecen varios "sampling_protocol" por grupo pero yo tenía entendido que había solo un protocolo de campo por grupo biologico**


```{sql}
WITH a AS(
SELECT event_id,sampling_protocol,
  REGEXP_REPLACE(event_id,'^ANH([0-9]{1,3})-((F)|(MA)|(MI)|(P)|(Z))(-([ABC]))?(-Bajas)?$','\1')::int anh_num,
  REGEXP_REPLACE(event_id,'^ANH([0-9]{1,3})-((F)|(MA)|(MI)|(P)|(Z))(-([ABC]))?(-Bajas)?$','\2') grupo,
  REGEXP_REPLACE(event_id,'^ANH([0-9]{1,3})-((F)|(MA)|(MI)|(P)|(Z))(-([ABC]))?(-Bajas)?$','\9') repl,
  REGEXP_REPLACE(event_id,'^ANH[0-9]{1,3}-((F)|(MA)|(MI)|(P)|(Z))(-([ABC]))?(-Bajas)?$','\9') ='-Bajas' aguas_bajas,
  EXTRACT(YEAR FROM TO_DATE(event_date,'YYYY-MM-DD')) año
FROM raw_dwc.hidrobiologico_event
)
SELECT grupo,sampling_protocol,count(*)
FROM a
GROUP BY sampling_protocol,grupo
ORDER BY grupo,sampling_protocol
```

Para entender los sampling protocols, intentar en los registros:

```{sql}
SELECT 
  REGEXP_REPLACE(event_id,'^ANH([0-9]{1,3})-((F)|(MA)|(MI)|(P)|(Z))(-([ABC]))?(-Bajas)?$','\2') grupo,
  e.sampling_protocol, r.sampling_protocol, count(*)
FROM raw_dwc.hidrobiologico_event e
LEFT JOIN (SELECT DISTINCT event_id,sampling_protocol FROM raw_dwc.hidrobiologico_registros) r USING (event_id)
GROUP BY  grupo, e.sampling_protocol, r.sampling_protocol
ORDER BY grupo, r.sampling_protocol, count(*)
```

Intentar los sampling_efforts

```{sql}
SELECT 
  REGEXP_REPLACE(event_id,'^ANH([0-9]{1,3})-((F)|(MA)|(MI)|(P)|(Z))(-([ABC]))?(-Bajas)?$','\2') grupo,
  sampling_protocol,e.sampling_effort, count(*)
FROM raw_dwc.hidrobiologico_event e
GROUP BY  grupo,e.sampling_protocol, e.sampling_effort
ORDER BY grupo, e.sampling_effort, count(*)
```

Parece que en macroinvertebrados hay 3 protocolos, más una asociación entre protocolos:

1. dragas
1. redes tipo D (en asociacion con macrofitas)
1. kick sampling
1. asociación (usualmente entre dragas y redes tipoD

**Anotar, veo unos sampling_protocol que son: Kick sampling red tipo d (no sé si son 2 metodos, pero como los kick sampling siempre están en este sampling_protocol, voy a considerar que es un protocolo)**


Entonces podemos adaptar los codigos anteriores así:

```{sql}
WITH a AS(
SELECT event_id,
  REGEXP_REPLACE(event_id,'^(ANH)([0-9]{1,3})-((F)|(MA)|(MI)|(P)|(Z))(-([ABC]))?(-Bajas)?$','\1_\2') anh_name,
  REGEXP_REPLACE(event_id,'^ANH([0-9]{1,3})-((F)|(MA)|(MI)|(P)|(Z))(-([ABC]))?(-Bajas)?$','\1')::int anh_num,
  REGEXP_REPLACE(event_id,'^ANH([0-9]{1,3})-((F)|(MA)|(MI)|(P)|(Z))(-([ABC]))?(-Bajas)?$','\2') grupo,
  CASE
       WHEN sampling_protocol='Draga' THEN 'D'
       WHEN sampling_protocol='Draga/Red tipo D - Asociados a macrofitas' THEN 'DR'
       WHEN sampling_protocol='Kick Sampling Red Tipo D' THEN 'K'
       WHEN sampling_protocol='Red tipo D - Asociados a macrofitas' THEN 'R'
       WHEN sampling_protocol~'[Rr]aspados' THEN 'Ra'
       WHEN sampling_protocol~'Botella Van Dorn' THEN 'B'
       WHEN sampling_protocol='Cuadrante 1x1 m' THEN 'C'
  END metodo,
  REGEXP_REPLACE(event_id,'^ANH([0-9]{1,3})-((F)|(MA)|(MI)|(P)|(Z))(-([ABC]))?(-Bajas)?$','\9') repl,
  REGEXP_REPLACE(event_id,'^ANH[0-9]{1,3}-((F)|(MA)|(MI)|(P)|(Z))(-([ABC]))?(-Bajas)?$','\9') ='-Bajas' aguas_bajas,
  EXTRACT(YEAR FROM TO_DATE(event_date,'YYYY-MM-DD')) año
FROM raw_dwc.hidrobiologico_event
)
SELECT anh_num,año, ARRAY_AGG(DISTINCT grupo ORDER BY grupo)
FROM a
GROUP BY anh_num,año
```

Utilizando esta separación de los metodos, podemos ver que, en un anh, para un grupo, siempre se utiliza un solo metodo, con repeticiones posibles (lo que nos va a facilitar la asignación de gp_event

```{sql}
WITH a AS(
SELECT event_id,
  REGEXP_REPLACE(event_id,'^(ANH[0-9]{1,3})-((F)|(MA)|(MI)|(P)|(Z))(-([ABC]))?(-Bajas)?$','\1') anh_name,
  REGEXP_REPLACE(event_id,'^ANH([0-9]{1,3})-((F)|(MA)|(MI)|(P)|(Z))(-([ABC]))?(-Bajas)?$','\1')::int anh_num,
  REGEXP_REPLACE(event_id,'^ANH([0-9]{1,3})-((F)|(MA)|(MI)|(P)|(Z))(-([ABC]))?(-Bajas)?$','\2') grupo,
  CASE
       WHEN sampling_protocol='Draga' THEN 'D'
       WHEN sampling_protocol='Draga/Red tipo D - Asociados a macrofitas' THEN 'DR'
       WHEN sampling_protocol='Kick Sampling Red Tipo D' THEN 'K'
       WHEN sampling_protocol='Red tipo D - Asociados a macrofitas' THEN 'R'
       WHEN sampling_protocol~'[Rr]aspados' THEN 'Ra'
       WHEN sampling_protocol~'Botella Van Dorn' THEN 'B'
       WHEN sampling_protocol='Cuadrante 1x1 m' THEN 'C'
  END metodo,
  REGEXP_REPLACE(event_id,'^ANH([0-9]{1,3})-((F)|(MA)|(MI)|(P)|(Z))(-([ABC]))?(-Bajas)?$','\9') repl,
  REGEXP_REPLACE(event_id,'^ANH[0-9]{1,3}-((F)|(MA)|(MI)|(P)|(Z))(-([ABC]))?(-Bajas)?$','\9') ='-Bajas' aguas_bajas,
  EXTRACT(YEAR FROM TO_DATE(event_date,'YYYY-MM-DD')) año
FROM raw_dwc.hidrobiologico_event
)
SELECT anh_num,año, grupo, ARRAY_AGG(DISTINCT metodo), count(*)
FROM a
GROUP BY anh_num,año,grupo
```


## ANH



Insertar los datos de anh:

```{sql}
INSERT INTO main.punto_referencia(name_pt_ref, num_anh)
WITH a AS(
SELECT
  REGEXP_REPLACE(event_id,'^(ANH)([0-9]{1,3})-((F)|(MA)|(MI)|(P)|(Z))(-([ABC]))?(-Bajas)?$','\1_\2') anh_name,
  REGEXP_REPLACE(event_id,'^ANH([0-9]{1,3})-((F)|(MA)|(MI)|(P)|(Z))(-([ABC]))?(-Bajas)?$','\1')::int anh_num
FROM raw_dwc.hidrobiologico_event
)
SELECT anh_name, anh_num
FROM a
WHERE anh_name IS NOT NULL
GROUP BY anh_name,anh_num
ORDER BY anh_num
ON CONFLICT (name_pt_ref) DO NOTHING
RETURNING cd_pt_ref, name_pt_ref
;
```

dar las referencias en las tablas totales de mamiferos

```{sql}
ALTER TABLE raw_dwc.hidrobiologico_event ADD COLUMN cd_pt_ref int REFERENCES main.punto_referencia(cd_pt_ref) ON DELETE SET NULL ON UPDATE CASCADE;
ALTER TABLE raw_dwc.hidrobiologico_registros ADD COLUMN cd_pt_ref int REFERENCES main.punto_referencia(cd_pt_ref) ON DELETE SET NULL ON UPDATE CASCADE;

WITH a AS(
SELECT event_id,
  REGEXP_REPLACE(event_id,'^(ANH)([0-9]{1,3})-((F)|(MA)|(MI)|(P)|(Z))(-([ABC]))?(-Bajas)?$','\1_\2') anh_name,
  REGEXP_REPLACE(event_id,'^ANH([0-9]{1,3})-((F)|(MA)|(MI)|(P)|(Z))(-([ABC]))?(-Bajas)?$','\1')::int anh_num
FROM raw_dwc.hidrobiologico_event
)
UPDATE raw_dwc.hidrobiologico_event AS m
SET cd_pt_ref=pr.cd_pt_ref
FROM main.punto_referencia pr, a
WHERE m.event_id=a.event_id AND a.anh_name = name_pt_ref
;

WITH a AS(
SELECT event_id,
  REGEXP_REPLACE(event_id,'^(ANH)([0-9]{1,3})-((F)|(MA)|(MI)|(P)|(Z))(-([ABC]))?(-Bajas)?$','\1_\2') anh_name,
  REGEXP_REPLACE(event_id,'^ANH([0-9]{1,3})-((F)|(MA)|(MI)|(P)|(Z))(-([ABC]))?(-Bajas)?$','\1')::int anh_num
FROM raw_dwc.hidrobiologico_registros
)
UPDATE raw_dwc.hidrobiologico_registros AS m
SET cd_pt_ref=pr.cd_pt_ref
FROM main.punto_referencia pr, a
WHERE m.event_id=a.event_id AND a.anh_name = name_pt_ref
;

SELECT true;
```

Averiguando que ninguna fila no tenga anh

```{sql}
SELECT event_id FROM raw_dwc.hidrobiologico_event WHERE cd_pt_ref IS NULL;
```

```{sql}
SELECT event_id,occurrence_id FROM raw_dwc.hidrobiologico_registros WHERE cd_pt_ref IS NULL;
```

## Unit, sampling efforts definition, abundance definition, protocolo

**Anotar: lo que llamaron abundancia relativa en las tablas es abundancia absoluta**

**Anotar: lo que llamaron cobertura en las tablas es area de cobertura no parece estar en porcentajes, a pesar del nombre de la variable**




```{sql}
INSERT INTO main.def_unit(cd_measurement_type, unit, unit_spa, abbv_unit,factor)
VALUES(
  (SELECT cd_measurement_type FROM main.def_measurement_type WHERE measurement_type='density'),
  'Individuals per square centimeter',
  'Individuos por centimetro cuadrado',
  'Ind/cm2',
  1
  ),(
  (SELECT cd_measurement_type FROM main.def_measurement_type WHERE measurement_type='density'),
  'Individuals per square meter',
  'Individuos por metro cuadrado',
  'Ind/m2',
  10000
  ),(
  (SELECT cd_measurement_type FROM main.def_measurement_type WHERE measurement_type='percentage'),
  'Percentage',
  'Porcentaje',
  '%',
  1
  )
  ,(
  (SELECT cd_measurement_type FROM main.def_measurement_type WHERE measurement_type='number concentration'),
  'Individuals per liter',
  'Individuos por litro',
  'Ind/L',
  1
  )
  ,(
  (SELECT cd_measurement_type FROM main.def_measurement_type WHERE measurement_type='area'),
  'Square centimeters',
  'Centimetros cuadrados',
  'cm2',
  1/10000
  )
  ,(
  (SELECT cd_measurement_type FROM main.def_measurement_type WHERE measurement_type='volume'),
  'Liters',
  'Litros',
  'L',
  1000
  )
  ,(
  (SELECT cd_measurement_type FROM main.def_measurement_type WHERE measurement_type='number of traps'),
  'Number of quadrat',
  'Número de cuadrante',
  'Quadrats',
  1
  )
  ,(
  (SELECT cd_measurement_type FROM main.def_measurement_type WHERE measurement_type='number of traps'),
  'Number of bottles',
  'Número de botellas',
  'bottles',
  1
  )
  ,(
  (SELECT cd_measurement_type FROM main.def_measurement_type WHERE measurement_type='number of traps'),
  'Number of scraped areas',
  'Número de raspados',
  'raspados',
  1
  )
  ,(
  (SELECT cd_measurement_type FROM main.def_measurement_type WHERE measurement_type='number of traps'),
  'Number of submerged stems',
  'Número de tallos sumergidos',
  'stems',
  1
  )
  ,(
  (SELECT cd_measurement_type FROM main.def_measurement_type WHERE measurement_type='number of traps'),
  'Number of kicks',
  'Número de kicks',
  'kicks',
  1
  )
  ,(
  (SELECT cd_measurement_type FROM main.def_measurement_type WHERE measurement_type='number of traps'),
  'Number of replicates',
  'Número de repeticiones',
  'replicates',
  1
  )
RETURNING cd_unit, unit, unit_spa
```

```{sql}
INSERT INTO main.def_var_ind_qt(var_qt_ind, var_qt_ind_spa, cd_unit, type_variable)
VALUES
(
  'Individual density (ind/cm2)',
  'Densidad de individuos (ind/cm2)',
  (SELECT cd_unit FROM main.def_unit WHERE cd_measurement_type=(SELECT cd_measurement_type FROM main.def_measurement_type WHERE measurement_type='density') AND unit='Individuals per square centimeter'),
  'double precision'
),
(
  'Individual density (ind/m2)',
  'Densidad de individuos (ind/m2)',
  (SELECT cd_unit FROM main.def_unit WHERE cd_measurement_type=(SELECT cd_measurement_type FROM main.def_measurement_type WHERE measurement_type='density') AND unit='Individuals per square meter'),
  'double precision'
),
(
  'Individual concentration',
  'Concentración de individuos',
  (SELECT cd_unit FROM main.def_unit WHERE cd_measurement_type=(SELECT cd_measurement_type FROM main.def_measurement_type WHERE measurement_type='number concentration') AND unit='Individuals per liter'),
  'double precision'
),
(
  'Absolute coverage',
  'Cobertura absoluta',
  (SELECT cd_unit FROM main.def_unit WHERE cd_measurement_type=(SELECT cd_measurement_type FROM main.def_measurement_type WHERE measurement_type='area') AND unit='Square meter'),
  'double precision'
),
(
  'Cover (%)',
  'Cobertura (%)',
  (SELECT cd_unit FROM main.def_unit WHERE cd_measurement_type=(SELECT cd_measurement_type FROM main.def_measurement_type WHERE measurement_type='percentage') AND unit='Percentage'),
  'double precision'
)
RETURNING cd_var_ind_qt,var_qt_ind
;
```

```{sql}
INSERT INTO main.def_var_samp_eff(var_samp_eff, var_samp_eff_spa, cd_unit,type_variable)
VALUES
  (
  'Number of quadrats',
  'Número de cuadrantes',
  (SELECT cd_unit FROM main.def_unit WHERE cd_measurement_type=(SELECT cd_measurement_type FROM main.def_measurement_type WHERE measurement_type='number of traps') AND unit='Number of quadrat'),
  'int'
  )
  ,(
  'Number of bottles',
  'Número de botellas',
  (SELECT cd_unit FROM main.def_unit WHERE cd_measurement_type=(SELECT cd_measurement_type FROM main.def_measurement_type WHERE measurement_type='number of traps') AND unit='Number of bottles'),
  'int'
  )
  ,(
  'Number of scraped areas',
  'Número de raspados',
  (SELECT cd_unit FROM main.def_unit WHERE cd_measurement_type=(SELECT cd_measurement_type FROM main.def_measurement_type WHERE measurement_type='number of traps') AND unit='Number of scraped areas'),
  'int'
  )
  ,(
  'Number of submerged stems',
  'Número de tallos sumergidos',
  (SELECT cd_unit FROM main.def_unit WHERE cd_measurement_type=(SELECT cd_measurement_type FROM main.def_measurement_type WHERE measurement_type='number of traps') AND unit='Number of submerged stems'),
  'int'
  )
  ,(
  'Number of kicks',
  'Número de kicks',
  (SELECT cd_unit FROM main.def_unit WHERE cd_measurement_type=(SELECT cd_measurement_type FROM main.def_measurement_type WHERE measurement_type='number of traps') AND unit='Number of kicks'),
  'int'
  )
  ,(
  'Sampling volume (L)',
  'Volumen de muestreo (L)',
  (SELECT cd_unit FROM main.def_unit WHERE cd_measurement_type=(SELECT cd_measurement_type FROM main.def_measurement_type WHERE measurement_type='volume') AND unit='Liters'),
  'double precision'
  )
  ,(
  'Sampling area (cm2)',
  'Superficie de muestreo (cm2)',
  (SELECT cd_unit FROM main.def_unit WHERE cd_measurement_type=(SELECT cd_measurement_type FROM main.def_measurement_type WHERE measurement_type='area') AND unit='Square centimeters'),
  'int'
  )
  ,(
  'Number of replicates',
  'Número de repeticiones',
  (SELECT cd_unit FROM main.def_unit WHERE cd_measurement_type=(SELECT cd_measurement_type FROM main.def_measurement_type WHERE measurement_type='number of traps') AND unit='Number of replicates'),
  'int'
  )


RETURNING cd_var_samp_eff, var_samp_eff;
```

```{sql}
INSERT INTO main.def_protocol(protocol,protocol_spa,cd_var_samp_eff_1,cd_var_samp_eff_2,samp_eff_1_implicit,samp_eff_2_implicit,cd_var_ind_qt,description_spa)
VALUES(
  'Grab collector',
  'Draga',
  (SELECT cd_var_samp_eff FROM main.def_var_samp_eff WHERE var_samp_eff='Sampling area'),
  (SELECT cd_var_samp_eff FROM main.def_var_samp_eff WHERE var_samp_eff='Number of replicates'),
  false,
  false,
  (SELECT cd_var_ind_qt FROM main.def_var_ind_qt WHERE var_qt_ind='Individuals per square meter'),
  NULL
)
,(
  'Substrate scraping',
  'Raspados',
  (SELECT cd_var_samp_eff FROM main.def_var_samp_eff WHERE var_samp_eff='Sampling area (cm2)'),
  (SELECT cd_var_samp_eff FROM main.def_var_samp_eff WHERE var_samp_eff='Number of replicates'),
  false,
  false,
  (SELECT cd_var_ind_qt FROM main.def_var_ind_qt WHERE var_qt_ind='Densidad de individuos (ind/cm2)'),
  NULL
)
,(
  'Sampling quadrats',
  'Cuadrantes',
  (SELECT cd_var_samp_eff FROM main.def_var_samp_eff WHERE var_samp_eff='Sampling area'),
  (SELECT cd_var_samp_eff FROM main.def_var_samp_eff WHERE var_samp_eff='Number of quadrats'),
  false,
  false,
  (SELECT cd_var_ind_qt FROM main.def_var_ind_qt WHERE var_qt_ind='Cover (%)'),
  NULL
)
,(
  'D net kick sampling',
  'Kick',
  (SELECT cd_var_samp_eff FROM main.def_var_samp_eff WHERE var_samp_eff='Sampling area'),
  (SELECT cd_var_samp_eff FROM main.def_var_samp_eff WHERE var_samp_eff='Number of kicks'),
  false,
  false,
  (SELECT cd_var_ind_qt FROM main.def_var_ind_qt WHERE var_qt_ind='Individual density (ind/m2)'),
  'Kick Sampling Red Tipo D'
)
,(
  'Van Dorn Bottle',
  'Botella Van Dorn',
  (SELECT cd_var_samp_eff FROM main.def_var_samp_eff WHERE var_samp_eff='Sampling volume (L)'),
  (SELECT cd_var_samp_eff FROM main.def_var_samp_eff WHERE var_samp_eff='Number of bottles'),
  false,
  false,
  (SELECT cd_var_ind_qt FROM main.def_var_ind_qt WHERE var_qt_ind='Individual concentration'),
  NULL
)
,(
  'D net (associated with macrophytes)',
  'Red tipo D asociados con macrofitas',
  (SELECT cd_var_samp_eff FROM main.def_var_samp_eff WHERE var_samp_eff='Sampling area'),
  (SELECT cd_var_samp_eff FROM main.def_var_samp_eff WHERE var_samp_eff='Number of trawl nets'),
  false,
  false,
  (SELECT cd_var_ind_qt FROM main.def_var_ind_qt WHERE var_qt_ind='Individual density (ind/m2)'),
  'type D nets associated to macrophytes'
)
,(
  'Grab collector + type D net',
  'Draga + Red tipo D',
  (SELECT cd_var_samp_eff FROM main.def_var_samp_eff WHERE var_samp_eff='Sampling area'),
  (SELECT cd_var_samp_eff FROM main.def_var_samp_eff WHERE var_samp_eff='Number of replicates'),
  false,
  false,
  (SELECT cd_var_ind_qt FROM main.def_var_ind_qt WHERE var_qt_ind='Densidad de individuos (ind/m2)'),
  'Draga/Red tipo D - Asociados a macrofitas, Se trata de una asociacion entre metodos, por las condiciones particulares del evento de muestreo'
)

RETURNING cd_protocol,protocol,protocol_spa;
```

## Personas

```{sql}
INSERT INTO main.people(verbatim_person)
WITH a AS(
SELECT DISTINCT INITCAP(TRIM(UNNEST(STRING_TO_ARRAY(recorded_by, ' | ')))) AS name_person
FROM raw_dwc.hidrobiologico_registros
UNION
SELECT DISTINCT INITCAP(TRIM(UNNEST(STRING_TO_ARRAY(identified_by, ' | '))))
FROM raw_dwc.hidrobiologico_registros
)
SELECT DISTINCT REGEXP_REPLACE(name_person, '- ','-')
FROM a 
ORDER BY REGEXP_REPLACE(name_person, '- ','-')
ON CONFLICT(verbatim_person) DO NOTHING
RETURNING cd_person, verbatim_person
```

Dar los codigos a las tables de origen:

```{sql}
ALTER TABLE raw_dwc.hidrobiologico_registros ADD COLUMN cds_recorded_by int[];

WITH a AS(
SELECT table_orig,"row.names", REGEXP_REPLACE(INITCAP(TRIM(UNNEST(STRING_TO_ARRAY(recorded_by, ' | ')))),'- ','-') AS name_person
FROM raw_dwc.hidrobiologico_registros
),b AS(
SELECT table_orig,"row.names", ARRAY_AGG(cd_person) cds
FROM a 
LEFT JOIN main.people p ON a.name_person=p.verbatim_person
GROUP BY table_orig,"row.names"
)
UPDATE raw_dwc.hidrobiologico_registros AS r
SET cds_recorded_by=b.cds
FROM b
WHERE r."row.names"=b."row.names" AND r.table_orig=b.table_orig
RETURNING r."row.names", cds_recorded_by
;

ALTER TABLE raw_dwc.hidrobiologico_registros ADD COLUMN cds_identified_by int[];

WITH a AS(
SELECT table_orig,"row.names", REGEXP_REPLACE(INITCAP(TRIM(UNNEST(STRING_TO_ARRAY(identified_by, ' | ')))),'- ','-') AS name_person
FROM raw_dwc.hidrobiologico_registros
),b AS(
SELECT table_orig,"row.names", ARRAY_AGG(cd_person) cds
FROM a 
LEFT JOIN main.people p ON a.name_person=p.verbatim_person
GROUP BY table_orig,"row.names"
)
UPDATE raw_dwc.hidrobiologico_registros AS r
SET cds_identified_by=b.cds
FROM b
WHERE r."row.names"=b."row.names" AND r.table_orig=b.table_orig
RETURNING r."row.names", cds_identified_by
;

SELECT 1;
```

## gp_event

```{sql}
WITH a AS(
SELECT 
  event_id,
  REGEXP_REPLACE(event_id,'^(ANH)([0-9]{1,3})-((F)|(MA)|(MI)|(P)|(Z))(-([ABC]))?(-Bajas)?$','\1_\2') anh_name,
  REGEXP_REPLACE(event_id,'^ANH([0-9]{1,3})-((F)|(MA)|(MI)|(P)|(Z))(-([ABC]))?(-Bajas)?$','\1')::int anh_num,
  REGEXP_REPLACE(event_id,'^ANH([0-9]{1,3})-((F)|(MA)|(MI)|(P)|(Z))(-([ABC]))?(-Bajas)?$','\2') grupo,
  CASE
       WHEN sampling_protocol='Draga' THEN 'D'
       WHEN sampling_protocol='Draga/Red tipo D - Asociados a macrofitas' THEN 'DR'
       WHEN sampling_protocol='Kick Sampling Red Tipo D' THEN 'K'
       WHEN sampling_protocol='Red tipo D - Asociados a macrofitas' THEN 'R'
       WHEN sampling_protocol~'[Rr]aspados' THEN 'Ra'
       WHEN sampling_protocol~'Botella Van Dorn' THEN 'B'
       WHEN sampling_protocol='Cuadrante 1x1 m' THEN 'C'
  END metodo,
  REGEXP_REPLACE(event_id,'^ANH([0-9]{1,3})-((F)|(MA)|(MI)|(P)|(Z))(-([ABC]))?(-Bajas)?$','\9') repli,
  REGEXP_REPLACE(event_id,'^ANH[0-9]{1,3}-((F)|(MA)|(MI)|(P)|(Z))(-([ABC]))?(-Bajas)?$','\9') ='-Bajas' aguas_bajas,
  EXTRACT(YEAR FROM TO_DATE(event_date,'YYYY-MM-DD')) año
FROM raw_dwc.hidrobiologico_event
)
SELECT año,grupo, anh_num,metodo, ARRAY_AGG(repli), count(*)
FROM a
GROUP BY año, grupo, anh_num, metodo
ORDER BY año, grupo, anh_num, metodo
;
```

Because there is more than a method, the number of the campaign should be determined this way:

```{sql}
WITH a AS(
SELECT 
  event_id,
  REGEXP_REPLACE(event_id,'^(ANH)([0-9]{1,3})-((F)|(MA)|(MI)|(P)|(Z))(-([ABC]))?(-Bajas)?$','\1_\2') anh_name,
  REGEXP_REPLACE(event_id,'^ANH([0-9]{1,3})-((F)|(MA)|(MI)|(P)|(Z))(-([ABC]))?(-Bajas)?$','\1')::int anh_num,
  REGEXP_REPLACE(event_id,'^ANH([0-9]{1,3})-((F)|(MA)|(MI)|(P)|(Z))(-([ABC]))?(-Bajas)?$','\2') grupo,
  CASE
       WHEN sampling_protocol='Draga' THEN 'D'
       WHEN sampling_protocol='Draga/Red tipo D - Asociados a macrofitas' THEN 'DR'
       WHEN sampling_protocol='Kick Sampling Red Tipo D' THEN 'K'
       WHEN sampling_protocol='Red tipo D - Asociados a macrofitas' THEN 'R'
       WHEN sampling_protocol~'[Rr]aspados' THEN 'Ra'
       WHEN sampling_protocol~'Botella Van Dorn' THEN 'B'
       WHEN sampling_protocol='Cuadrante 1x1 m' THEN 'C'
  END metodo,
  REGEXP_REPLACE(event_id,'^ANH([0-9]{1,3})-((F)|(MA)|(MI)|(P)|(Z))(-([ABC]))?(-Bajas)?$','\9') repli,
  REGEXP_REPLACE(event_id,'^ANH[0-9]{1,3}-((F)|(MA)|(MI)|(P)|(Z))(-([ABC]))?(-Bajas)?$','\9') ='-Bajas' aguas_bajas,
  EXTRACT(YEAR FROM TO_DATE(event_date,'YYYY-MM-DD')) año
FROM raw_dwc.hidrobiologico_event
)
SELECT año,aguas_bajas, anh_name,grupo, ROW_NUMBER() OVER (PARTITION BY anh_name,grupo ORDER BY año,aguas_bajas) campaign_nb
FROM a
GROUP BY año,grupo,aguas_bajas, anh_name
ORDER BY año,grupo,aguas_bajas, anh_name
;
```


```{sql}
INSERT INTO main.gp_event(cd_gp_biol,cd_protocol,cd_pt_ref,campaign_nb)
WITH a AS(
SELECT 
  event_id,
  REGEXP_REPLACE(event_id,'^(ANH)([0-9]{1,3})-((F)|(MA)|(MI)|(P)|(Z))(-([ABC]))?(-Bajas)?$','\1_\2') anh_name,
  REGEXP_REPLACE(event_id,'^ANH([0-9]{1,3})-((F)|(MA)|(MI)|(P)|(Z))(-([ABC]))?(-Bajas)?$','\1')::int anh_num,
  REGEXP_REPLACE(event_id,'^ANH([0-9]{1,3})-((F)|(MA)|(MI)|(P)|(Z))(-([ABC]))?(-Bajas)?$','\2') grupo,
  CASE
       WHEN sampling_protocol='Draga' THEN 'D'
       WHEN sampling_protocol='Draga/Red tipo D - Asociados a macrofitas' THEN 'DR'
       WHEN sampling_protocol='Kick Sampling Red Tipo D' THEN 'K'
       WHEN sampling_protocol='Red tipo D - Asociados a macrofitas' THEN 'R'
       WHEN sampling_protocol~'[Rr]aspados' THEN 'Ra'
       WHEN sampling_protocol~'Botella Van Dorn' THEN 'B'
       WHEN sampling_protocol='Cuadrante 1x1 m' THEN 'C'
  END metodo,
  REGEXP_REPLACE(event_id,'^ANH([0-9]{1,3})-((F)|(MA)|(MI)|(P)|(Z))(-([ABC]))?(-Bajas)?$','\9') repli,
  REGEXP_REPLACE(event_id,'^ANH[0-9]{1,3}-((F)|(MA)|(MI)|(P)|(Z))(-([ABC]))?(-Bajas)?$','\9') ='-Bajas' aguas_bajas,
  EXTRACT(YEAR FROM TO_DATE(event_date,'YYYY-MM-DD')) año,
  cd_pt_ref
FROM raw_dwc.hidrobiologico_event
), campaign AS(
SELECT año,aguas_bajas, a.metodo,anh_name,grupo, ROW_NUMBER() OVER (PARTITION BY anh_name,grupo ORDER BY año,aguas_bajas) campaign_nb
FROM a
GROUP BY año,grupo,metodo,aguas_bajas, anh_name
ORDER BY año,grupo,metodo,aguas_bajas, anh_name
)
SELECT 
CASE
 WHEN a.grupo='F' THEN 'fipl'
 WHEN a.grupo='MA' THEN 'mafi'
 WHEN a.grupo='MI' THEN 'minv'
 WHEN a.grupo='P' THEN 'peri'
 WHEN a.grupo='Z' THEN 'zopl'
END cd_gp_biol,  
CASE
    WHEN a.metodo='D' THEN (SELECT cd_protocol FROM main.def_protocol WHERE protocol='Grab collector')
    WHEN a.metodo='Ra' THEN (SELECT cd_protocol FROM main.def_protocol WHERE protocol='Substrate scraping')
    WHEN a.metodo='C' THEN (SELECT cd_protocol FROM main.def_protocol WHERE protocol='Sampling quadrats')
    WHEN a.metodo='K' THEN (SELECT cd_protocol FROM main.def_protocol WHERE protocol='D net kick sampling')
    WHEN a.metodo='B' THEN (SELECT cd_protocol FROM main.def_protocol WHERE protocol='Van Dorn Bottle')
    WHEN a.metodo='DR' THEN (SELECT cd_protocol FROM main.def_protocol WHERE protocol='Grab collector + type D net')
    WHEN a.metodo='R' THEN (SELECT cd_protocol FROM main.def_protocol WHERE protocol='D net (associated with macrophytes)')
  END cd_protocol,
  cd_pt_ref,
  c.campaign_nb
FROM a
LEFT JOIN campaign c ON c.aguas_bajas=a.aguas_bajas AND (c.anh_name=a.anh_name OR (c.anh_name IS NULL AND a.anh_name IS NULL)) AND a.metodo=c.metodo
LEFT JOIN main.punto_referencia USING (cd_pt_ref)
GROUP BY a.grupo, cd_pt_ref, name_pt_ref,a.año, a.aguas_bajas, a.metodo, c.campaign_nb
ORDER BY a.año,a.aguas_bajas,cd_pt_ref, a.grupo, cd_protocol
RETURNING cd_gp_event,cd_gp_biol,cd_protocol,cd_pt_ref,campaign_nb,subpart
;
```

Attributing the gp_event

```{sql}
ALTER TABLE raw_dwc.hidrobiologico_event ADD COLUMN cd_gp_event int REFERENCES main.gp_event(cd_gp_event) ON DELETE SET NULL;

WITH a AS(
SELECT 
  event_id,
  REGEXP_REPLACE(event_id,'^(ANH)([0-9]{1,3})-((F)|(MA)|(MI)|(P)|(Z))(-([ABC]))?(-Bajas)?$','\1_\2') anh_name,
  REGEXP_REPLACE(event_id,'^ANH([0-9]{1,3})-((F)|(MA)|(MI)|(P)|(Z))(-([ABC]))?(-Bajas)?$','\1')::int anh_num,
  REGEXP_REPLACE(event_id,'^ANH([0-9]{1,3})-((F)|(MA)|(MI)|(P)|(Z))(-([ABC]))?(-Bajas)?$','\2') grupo,
  CASE
       WHEN sampling_protocol='Draga' THEN 'D'
       WHEN sampling_protocol='Draga/Red tipo D - Asociados a macrofitas' THEN 'DR'
       WHEN sampling_protocol='Kick Sampling Red Tipo D' THEN 'K'
       WHEN sampling_protocol='Red tipo D - Asociados a macrofitas' THEN 'R'
       WHEN sampling_protocol~'[Rr]aspados' THEN 'Ra'
       WHEN sampling_protocol~'Botella Van Dorn' THEN 'B'
       WHEN sampling_protocol='Cuadrante 1x1 m' THEN 'C'
  END metodo,
  REGEXP_REPLACE(event_id,'^ANH([0-9]{1,3})-((F)|(MA)|(MI)|(P)|(Z))(-([ABC]))?(-Bajas)?$','\9') repli,
  REGEXP_REPLACE(event_id,'^ANH[0-9]{1,3}-((F)|(MA)|(MI)|(P)|(Z))(-([ABC]))?(-Bajas)?$','\9') ='-Bajas' aguas_bajas,
  EXTRACT(YEAR FROM TO_DATE(event_date,'YYYY-MM-DD')) año,
  cd_pt_ref
FROM raw_dwc.hidrobiologico_event
), campaign AS(
SELECT año,aguas_bajas, metodo,anh_name,grupo, ROW_NUMBER() OVER (PARTITION BY anh_name,grupo ORDER BY año,aguas_bajas) campaign_nb
FROM a
GROUP BY año,grupo,metodo,aguas_bajas, anh_name
ORDER BY año,grupo,metodo,aguas_bajas, anh_name
),b AS(
SELECT event_id,
CASE
 WHEN a.grupo='F' THEN 'fipl'
 WHEN a.grupo='MA' THEN 'mafi'
 WHEN a.grupo='MI' THEN 'minv'
 WHEN a.grupo='P' THEN 'peri'
 WHEN a.grupo='Z' THEN 'zopl'
END cd_gp_biol,  
CASE
    WHEN metodo='D' THEN (SELECT cd_protocol FROM main.def_protocol WHERE protocol='Grab collector')
    WHEN metodo='Ra' THEN (SELECT cd_protocol FROM main.def_protocol WHERE protocol='Substrate scraping')
    WHEN metodo='C' THEN (SELECT cd_protocol FROM main.def_protocol WHERE protocol='Sampling quadrats')
    WHEN metodo='K' THEN (SELECT cd_protocol FROM main.def_protocol WHERE protocol='D net kick sampling')
    WHEN metodo='B' THEN (SELECT cd_protocol FROM main.def_protocol WHERE protocol='Van Dorn Bottle')
    WHEN metodo='DR' THEN (SELECT cd_protocol FROM main.def_protocol WHERE protocol='Grab collector + type D net')
    WHEN metodo='R' THEN (SELECT cd_protocol FROM main.def_protocol WHERE protocol='D net (associated with macrophytes)')
  END cd_protocol,
  cd_pt_ref,
  c.campaign_nb
FROM a
LEFT JOIN campaign c USING (grupo,año,metodo,aguas_bajas,anh_name)
LEFT JOIN main.punto_referencia USING (cd_pt_ref)
),d AS(
SELECT b.*,cd_gp_event
FROM b
LEFT JOIN main.gp_event USING (cd_gp_biol,cd_protocol,campaign_nb,cd_pt_ref)
)
UPDATE raw_dwc.hidrobiologico_event e
SET cd_gp_event=d.cd_gp_event
FROM d
WHERE d.event_id=e.event_id
RETURNING e.event_id, e.cd_gp_event
;

SELECT event_id
FROM raw_dwc.hidrobiologico_event
WHERE cd_gp_event IS NULL;

```

## event

**Los event_remarks son muy largos, voy a ponerlos en event_extra**

**Anotar: en sample_size_value hay un espacio que hace que el campo esta considerado como texto**


```{sql}
SELECT event_id,sample_size_value
FROM raw_dwc.hidrobiologico_event
WHERE sample_size_value ~ '\s'
```


Averiguar que las unidades de sample_size corresponden a las unidades definidas como samp_eff_1 en los protocolos:

```{sql}
SELECT cd_gp_biol,protocol, sample_size_unit, abbv_unit, count(*)
FROM raw_dwc.hidrobiologico_event
LEFT JOIN main.gp_event USING (cd_gp_event)
LEFT JOIN main.def_protocol USING (cd_protocol)
LEFT JOIN main.def_var_samp_eff ON cd_var_samp_eff_1 = cd_var_samp_eff
LEFT JOIN main.def_unit USING (cd_unit)
GROUP BY cd_gp_biol,sample_size_unit, abbv_unit, protocol
ORDER BY cd_gp_biol, count(*)
```

Para extraer samp_eff_2:
```{sql}
SELECT DISTINCT 
  sample_size_unit, 
  sample_size_value,
  sampling_effort,
  sampling_protocol
FROM raw_dwc.hidrobiologico_event
```

```{sql}
WITH se2_1 AS(
SELECT event_id, sampling_effort, UNNEST(REGEXP_MATCHES(sampling_effort,'([0-9]+)','g'))::int s_e
FROM raw_dwc.hidrobiologico_event
)
SELECT event_id,sampling_effort,SUM(s_e) samp_eff_2
FROM se2_1
GROUP BY event_id,sampling_effort
```


\footnotesize

```{sql}
INSERT INTO main.event(cd_gp_event,event_id,num_replicate, description_replicate, date_time_begin, date_time_end, locality_verb, event_remarks, samp_effort_1, samp_effort_2, pt_geom)
WITH se2_1 AS(
SELECT event_id, sampling_effort, UNNEST(REGEXP_MATCHES(sampling_effort,'([0-9]+)','g'))::int s_e
FROM raw_dwc.hidrobiologico_event
),se2_2 AS(
SELECT event_id, SUM(s_e) samp_eff_2
FROM se2_1
GROUP BY event_id,sampling_effort
), a AS(
SELECT cd_gp_event,
  event_id, 
  REGEXP_REPLACE(event_id,'^(ANH)([0-9]{1,3})-((F)|(MA)|(MI)|(P)|(Z))(-([ABC]))?(-Bajas)?$','\1_\2') anh_name,
  REGEXP_REPLACE(event_id,'^ANH([0-9]{1,3})-((F)|(MA)|(MI)|(P)|(Z))(-([ABC]))?(-Bajas)?$','\1')::int anh_num,
  REGEXP_REPLACE(event_id,'^ANH([0-9]{1,3})-((F)|(MA)|(MI)|(P)|(Z))(-([ABC]))?(-Bajas)?$','\2') grupo,
  CASE
       WHEN sampling_protocol='Draga' THEN 'D'
       WHEN sampling_protocol='Draga/Red tipo D - Asociados a macrofitas' THEN 'DR'
       WHEN sampling_protocol='Kick Sampling Red Tipo D' THEN 'K'
       WHEN sampling_protocol='Red tipo D - Asociados a macrofitas' THEN 'R'
       WHEN sampling_protocol~'[Rr]aspados' THEN 'Ra'
       WHEN sampling_protocol~'Botella Van Dorn' THEN 'B'
       WHEN sampling_protocol='Cuadrante 1x1 m' THEN 'C'
  END metodo,
  REGEXP_REPLACE(event_id,'^ANH([0-9]{1,3})-((F)|(MA)|(MI)|(P)|(Z))(-([ABC]))?(-Bajas)?$','\9') repli,
  REGEXP_REPLACE(event_id,'^ANH[0-9]{1,3}-((F)|(MA)|(MI)|(P)|(Z))(-([ABC]))?(-Bajas)?$','\9') ='-Bajas' aguas_bajas,
  EXTRACT(YEAR FROM TO_DATE(event_date,'YYYY-MM-DD')) año,
  (event_date||' '||event_time)::timestamp date_time_begin,
  NULL::timestamp date_time_end,
  locality locality_verb,
  REGEXP_REPLACE(sample_size_value,'\s','')::double precision samp_eff_1,
  samp_eff_2,
  --sampling_size_value,
  --sample_size_unit,
  --sampling_size_unit,
  --sampling_effort,
  NULL event_remarks,
  --locality_remarks,
  ST_SetSRID(ST_Transform(ST_SetSRID(ST_MakePoint(decimal_longitude,decimal_latitude),4326),(SELECT proj4text FROM spatial_ref_sys WHERE srid=3116)),3116) pt_geom
FROM raw_dwc.hidrobiologico_event
LEFT JOIN se2_2 USING (event_id)
)--calculation of sampling effort and num_replicate
SELECT 
  cd_gp_event,
  event_id, 
  ROW_NUMBER() OVER (PARTITION BY cd_gp_event ORDER BY repli) num_replicate,
  CASE
    WHEN repli != '' AND repli IS NOT NULL THEN 'replicate:'||repli 
  END description_replicate,
  date_time_begin,
  date_time_end,
  locality_verb,
  event_remarks ,
  samp_eff_1,
  samp_eff_2,
  pt_geom
FROM a
ORDER BY cd_gp_event, event_id, num_replicate

RETURNING main.event.cd_event, main.event.cd_gp_event, main.event.event_id, main.event.num_replicate, main.event.description_replicate, main.event.date_time_begin, main.event.date_time_end, main.event.locality_verb, main.event.event_remarks, main.event.pt_geom
```

Damos los cd_event a todos las filas:

```{sql}
ALTER TABLE raw_dwc.hidrobiologico_event ADD COLUMN cd_event int REFERENCES main.event(cd_event) ON DELETE SET NULL;
ALTER TABLE raw_dwc.hidrobiologico_registros ADD COLUMN cd_event int REFERENCES main.event(cd_event);

UPDATE raw_dwc.hidrobiologico_event AS t
SET cd_event=e.cd_event
FROM main.event e
WHERE t.event_id=e.event_id;

UPDATE raw_dwc.hidrobiologico_registros AS t
SET cd_event=e.cd_event
FROM main.event e
WHERE t.event_id=e.event_id;

SELECT true;
```

### Añadir información temporal faltante

Añadir los comentarios largos sobre los eventos:

```{sql}
INSERT INTO main.event_extra(cd_event, cd_var_event_extra,value_text)
SELECT cd_event, 
  (SELECT cd_var_event_extra FROM main.def_var_event_extra WHERE var_event_extra = 'big_remarks'),
  event_remarks
FROM raw_dwc.hidrobiologico_event
WHERE  event_remarks IS NOT NULL
;

```



## registros


```{sql}
SELECT occurrence_id, count(*)
FROM raw_dwc.hidrobiologico_registros 
GROUP BY occurrence_id
HAVING count(*)>1;
```





**Commas intempestivos en el campo de organism_quantity** 



```{sql}
INSERT INTO main.registros(cd_event, cds_recorded_by, date_time, cd_tax, cd_morfo, date_ident, cds_identified_by, qt_int, qt_double, remarks, occurrence_id, organism_id)
SELECT 
 cd_event,
 cds_recorded_by,
 NULL::timestamp date_time,
 tt.cd_tax,
 tt.cd_morfo,
 TO_DATE(date_identified,'YYYY-MM-DD') date_ident,
 cds_identified_by,
 measurement_value__abundancia_relativa_ qt_int,
 REGEXP_REPLACE(organism_quantity,',','.')::double precision qt_double,
 NULL remarks,
 --r.event_remarks remarks,
 r.occurrence_id,
 SPLIT_PART(occurrence_id,':',7) organism_id
 --ROW_NUMBER() OVER (ORDER BY (e.date_time_begin::date||' '||event_time)::timestamp)
 --organism_id,
 --ST_SetSRID(ST_Transform(ST_SetSRID(ST_MakePoint(measurement_value__longitud_,measurement_value__latitud_), 4326),  (SELECT proj4text FROM spatial_ref_sys WHERE srid=3116)),3116)
FROM raw_dwc.hidrobiologico_registros r
LEFT JOIN raw_dwc.taxonomy_total tt ON tt."row.names"=r."row.names" AND tt.table_orig=r.table_orig

RETURNING cd_event, cds_recorded_by, date_time, cd_tax, cd_morfo, cds_identified_by, qt_int,remarks, occurrence_id, organism_id
```

```{sql}
ALTER TABLE raw_dwc.hidrobiologico_registros ADD COLUMN cd_reg int REFERENCES main.registros(cd_reg);
UPDATE raw_dwc.hidrobiologico_registros AS ar
SET cd_reg=r.cd_reg
FROM main.registros r
WHERE ar.cd_event=r.cd_event AND ar.occurrence_id=r.occurrence_id;

-- Check cd_reg are unique in the source table
SELECT cd_reg,count(*) FROM  raw_dwc.hidrobiologico_registros GROUP BY cd_reg HAVING count(*)>1;
```



En la mayoría de los casos no corresponden las cifras de abundancias:

```{sql}
SELECT qt_int/samp_effort_1, qt_double
FROM main.registros
LEFT JOIN main.event USING (cd_event)
LEFT JOIN main.gp_event USING (cd_gp_event)
LEFT JOIN main.def_gp_biol USING (cd_gp_biol)
WHERE super_gp='Hydrobiology'
```

# Cameras trampa


## Entender el plan de muestreo

```{sql}
SELECT 
  REGEXP_REPLACE(event_id, '^ANH([0-9]{3})_T([1-3])$','\1')::int anh_num,
  'ANH_'||REGEXP_REPLACE(event_id, '^ANH([0-9]{3})_T([1-3])$','\1')::int anh_name,
  REGEXP_REPLACE(event_id, '^ANH([0-9]{3})_T([1-3])$','\2')::int tempo,
  ARRAY_AGG(event_id)
FROM raw_dwc.cameras_trampa_event
GROUP BY anh_num, tempo
ORDER BY anh_num, tempo
```

```{sql}
WITH a AS(
SELECT 
  event_id,
  REGEXP_REPLACE(event_id, '^ANH([0-9]{3})_T([1-3])$','\1')::int anh_num,
  'ANH_'||REGEXP_REPLACE(event_id, '^ANH([0-9]{3})_T([1-3])$','\1')::int anh_name,
  REGEXP_REPLACE(event_id, '^ANH([0-9]{3})_T([1-3])$','\2')::int tempo
FROM raw_dwc.cameras_trampa_event
ORDER BY anh_num, tempo
)
SELECT anh_num, ARRAY_AGG(tempo),count(*)
FROM a
GROUP BY anh_num
ORDER BY anh_num,count(*)

```


## ANH


Insertar los datos de anh:

```{sql}
INSERT INTO main.punto_referencia(name_pt_ref, num_anh)
WITH a AS(
SELECT
  REGEXP_REPLACE(event_id, '^ANH([0-9]{3})_T([1-3])$','\1')::int anh_num,
  'ANH_'||REGEXP_REPLACE(event_id, '^ANH([0-9]{3})_T([1-3])$','\1')::int anh_name
FROM raw_dwc.cameras_trampa_event
)
SELECT anh_name, anh_num
FROM a
GROUP BY anh_name,anh_num
ORDER BY anh_num
ON CONFLICT (name_pt_ref) DO NOTHING
RETURNING cd_pt_ref, name_pt_ref
;
```

dar las referencias en las tablas de cameras_trampa

```{sql}
ALTER TABLE raw_dwc.cameras_trampa_event ADD COLUMN cd_pt_ref int REFERENCES main.punto_referencia(cd_pt_ref) ON DELETE SET NULL ON UPDATE CASCADE;
ALTER TABLE raw_dwc.cameras_trampa_registros ADD COLUMN cd_pt_ref int REFERENCES main.punto_referencia(cd_pt_ref) ON DELETE SET NULL ON UPDATE CASCADE;

UPDATE raw_dwc.cameras_trampa_event
SET cd_pt_ref=pr.cd_pt_ref
FROM main.punto_referencia pr
WHERE 'ANH_'||REGEXP_REPLACE(event_id, '^ANH([0-9]{3})_T([1-3])$','\1')::int= name_pt_ref
;

UPDATE raw_dwc.cameras_trampa_registros
SET cd_pt_ref=pr.cd_pt_ref
FROM main.punto_referencia pr
WHERE  'ANH_'||REGEXP_REPLACE(event_id, '^ANH([0-9]{3})_T([1-3])$','\1')::int= name_pt_ref
;

SELECT true;
```

Averiguando que ninguna fila no tenga anh

```{sql}
SELECT event_id FROM raw_dwc.cameras_trampa_event WHERE cd_pt_ref IS NULL;
```

```{sql}
SELECT occurrence_id FROM raw_dwc.cameras_trampa_registros WHERE cd_pt_ref IS NULL;
```

## Unit, sampling efforts definition, abundance definition, protocolo

```{sql}
INSERT INTO main.def_unit(cd_measurement_type, unit, unit_spa, abbv_unit,factor)
VALUES(
  (SELECT cd_measurement_type FROM main.def_measurement_type WHERE measurement_type='number of traps'),
  'Number of camera traps',
  'Número de cameras trampa',
  'camera traps',
  1
  )
RETURNING cd_unit,unit;
```

```{sql}
INSERT INTO main.def_var_samp_eff(var_samp_eff, var_samp_eff_spa, cd_unit,type_variable)
VALUES(
  'Number of camera traps',
  'Número de cameras trampa',
  (SELECT cd_unit FROM main.def_unit WHERE cd_measurement_type=(SELECT cd_measurement_type FROM main.def_measurement_type WHERE measurement_type='number of traps') AND unit='Number of camera traps'),
  'int'
  )
RETURNING cd_var_samp_eff, var_samp_eff ;
```

```{sql}
INSERT INTO main.def_protocol(protocol,protocol_spa,cd_var_samp_eff_1,cd_var_samp_eff_2,samp_eff_1_implicit,samp_eff_2_implicit,cd_var_ind_qt,description_spa)
VALUES(
  'Camera traps',
  'Fototrampeo',
  (SELECT cd_var_samp_eff FROM main.def_var_samp_eff WHERE var_samp_eff='Number of camera traps'),
  (SELECT cd_var_samp_eff FROM main.def_var_samp_eff WHERE var_samp_eff='Time Elapsed (nigths)'),
  false,
  false,
  (SELECT cd_var_ind_qt FROM main.def_var_ind_qt WHERE var_qt_ind='Number of individuals'),
  NULL
)
RETURNING cd_protocol,protocol,protocol_spa;
```

## Personas

```{sql}
INSERT INTO main.people(verbatim_person)
WITH a AS(
SELECT DISTINCT INITCAP(TRIM(UNNEST(STRING_TO_ARRAY(recorded_by, ' | ')))) AS name_person
FROM raw_dwc.cameras_trampa_registros
UNION
SELECT DISTINCT INITCAP(TRIM(UNNEST(STRING_TO_ARRAY(identified_by, ' | '))))
FROM raw_dwc.cameras_trampa_registros
)
SELECT DISTINCT REGEXP_REPLACE(name_person, '- ','-')
FROM a 
ORDER BY REGEXP_REPLACE(name_person, '- ','-')
ON CONFLICT(verbatim_person) DO NOTHING
RETURNING cd_person, verbatim_person
```

Dar los codigos a las tables de origen:

```{sql}
ALTER TABLE raw_dwc.cameras_trampa_registros ADD COLUMN cds_recorded_by int[];

WITH a AS(
SELECT "row.names", REGEXP_REPLACE(INITCAP(TRIM(UNNEST(STRING_TO_ARRAY(recorded_by, ' | ')))),'- ','-') AS name_person
FROM raw_dwc.cameras_trampa_registros
),b AS(
SELECT "row.names", ARRAY_AGG(cd_person) cds
FROM a 
LEFT JOIN main.people p ON a.name_person=p.verbatim_person
GROUP BY "row.names"
)
UPDATE raw_dwc.cameras_trampa_registros AS r
SET cds_recorded_by=b.cds
FROM b
WHERE r."row.names"=b."row.names"
RETURNING r."row.names", cds_recorded_by
;

ALTER TABLE raw_dwc.cameras_trampa_registros ADD COLUMN cds_identified_by int[];

WITH a AS(
SELECT "row.names", REGEXP_REPLACE(INITCAP(TRIM(UNNEST(STRING_TO_ARRAY(identified_by, ' | ')))),'- ','-') AS name_person
FROM raw_dwc.cameras_trampa_registros
),b AS(
SELECT "row.names", ARRAY_AGG(cd_person) cds
FROM a 
LEFT JOIN main.people p ON a.name_person=p.verbatim_person
GROUP BY "row.names"
)
UPDATE raw_dwc.cameras_trampa_registros AS r
SET cds_identified_by=b.cds
FROM b
WHERE r."row.names"=b."row.names"
RETURNING r."row.names", cds_identified_by
;

SELECT 1;
```

## gp_event

```{sql}
WITH a AS(
SELECT 
  event_id,
  EXTRACT(YEAR FROM TO_DATE(SPLIT_PART(event_date,'/',1), 'YYYY-MM-DD')) año,
  REGEXP_REPLACE(event_id, '^ANH([0-9]{3})_T([1-3])$','\1')::int anh_num,
  'ANH_'||REGEXP_REPLACE(event_id, '^ANH([0-9]{3})_T([1-3])$','\1')::int anh_name,
  REGEXP_REPLACE(event_id, '^ANH([0-9]{3})_T([1-3])$','\2')::int tempo
FROM raw_dwc.cameras_trampa_event
)
SELECT año, anh_num, ARRAY_AGG(tempo), count(*)
FROM a
GROUP BY año, anh_num
ORDER BY anh_num,año
;
```

Because there is only one method, the number of the campaign should be determined this way:

```{sql}
WITH a AS(
SELECT 
  event_id,
  REGEXP_REPLACE(event_id, '^ANH([0-9]{3})_T([1-3])$','\1')::int anh_num,
  'ANH_'||REGEXP_REPLACE(event_id, '^ANH([0-9]{3})_T([1-3])$','\1')::int anh_name,
  REGEXP_REPLACE(event_id, '^ANH([0-9]{3})_T([1-3])$','\2')::int tempo
FROM raw_dwc.cameras_trampa_event
)
SELECT anh_num, ROW_NUMBER() OVER (PARTITION BY anh_num ORDER BY tempo) campaign_nb
FROM a
GROUP BY anh_num,tempo
ORDER BY anh_num,tempo
;
```


```{sql}
INSERT INTO main.gp_event(cd_gp_biol,cd_protocol,cd_pt_ref,campaign_nb)
WITH a AS(
SELECT 
  event_id,
  REGEXP_REPLACE(event_id, '^ANH([0-9]{3})_T([1-3])$','\1')::int anh_num,
  'ANH_'||REGEXP_REPLACE(event_id, '^ANH([0-9]{3})_T([1-3])$','\1')::int anh_name,
  REGEXP_REPLACE(event_id, '^ANH([0-9]{3})_T([1-3])$','\2')::int tempo,
  cd_pt_ref
FROM raw_dwc.cameras_trampa_event
), campaign AS(
SELECT anh_num, tempo, ROW_NUMBER() OVER (PARTITION BY anh_num ORDER BY tempo) campaign_nb
FROM a
GROUP BY anh_num,tempo
ORDER BY anh_num,tempo
)
SELECT 'catr',
    (SELECT cd_protocol FROM main.def_protocol WHERE protocol='Camera traps') cd_protocol,
  cd_pt_ref,
  c.campaign_nb
FROM a
LEFT JOIN campaign c USING (tempo, anh_num)
LEFT JOIN main.punto_referencia USING (cd_pt_ref)
GROUP BY cd_pt_ref, name_pt_ref, c.campaign_nb
ORDER BY cd_pt_ref,cd_protocol
RETURNING cd_gp_event,cd_gp_biol,cd_protocol,cd_pt_ref,campaign_nb
;
```

Attributing the gp_event

```{sql}
ALTER TABLE raw_dwc.cameras_trampa_event ADD COLUMN cd_gp_event int REFERENCES main.gp_event(cd_gp_event) ON DELETE SET NULL;


WITH a AS(
SELECT 
  event_id,
  REGEXP_REPLACE(event_id, '^ANH([0-9]{3})_T([1-3])$','\1')::int anh_num,
  'ANH_'||REGEXP_REPLACE(event_id, '^ANH([0-9]{3})_T([1-3])$','\1')::int anh_name,
  REGEXP_REPLACE(event_id, '^ANH([0-9]{3})_T([1-3])$','\2')::int tempo,
  cd_pt_ref
FROM raw_dwc.cameras_trampa_event
), campaign AS(
SELECT anh_num, tempo, ROW_NUMBER() OVER (PARTITION BY anh_num ORDER BY tempo) campaign_nb
FROM a
),b AS(
SELECT event_id,
    (SELECT cd_protocol FROM main.def_protocol WHERE protocol='Camera traps') cd_protocol,
  cd_pt_ref,
  c.campaign_nb
FROM a
LEFT JOIN campaign c USING (tempo, anh_num)
LEFT JOIN main.punto_referencia USING (cd_pt_ref)
),d AS(
SELECT b.*, cd_gp_event
FROM b
LEFT JOIN main.gp_event ge ON cd_gp_biol='catr' AND b.cd_protocol=ge.cd_protocol AND b.cd_pt_ref=ge.cd_pt_ref AND b.campaign_nb=ge.campaign_nb
)
UPDATE raw_dwc.cameras_trampa_event e
SET cd_gp_event=d.cd_gp_event
FROM d
WHERE d.event_id=e.event_id
RETURNING e.event_id, e.cd_gp_event
;
```

## event

**Poner 18:00:00 y 06:00:00 en las horas es malo?**

\footnotesize

```{sql}
INSERT INTO main.event(cd_gp_event,event_id,num_replicate, description_replicate, date_time_begin, date_time_end, locality_verb, event_remarks, samp_effort_1, samp_effort_2, pt_geom)
SELECT cd_gp_event,
  event_id, 
  1 AS num_replicate,
  NULL AS description_replicate,
  (TO_DATE(SPLIT_PART(event_date,'/',1), 'YYYY-MM-DD')||' 18:00:00')::timestamp date_time_begin,
  (TO_DATE(SPLIT_PART(event_date,'/',2), 'YYYY-MM-DD')||' 06:00:00')::timestamp date_time_end,
  locality locality_verb,
  NULL AS event_remarks,
  sample_size_value samp_effort_1,
  REGEXP_REPLACE(sampling_effort,'^([0-9]*) .*','\1')::int samp_effort_2,
  --locality_remarks,
  ST_SetSRID(ST_Transform(ST_SetSRID(ST_MakePoint(decimal_longitude,decimal_latitude),4326), (SELECT proj4text FROM spatial_ref_sys WHERE srid=3116)),3116) pt_geom
FROM raw_dwc.cameras_trampa_event
LEFT JOIN main.gp_event USING (cd_gp_event)
LEFT JOIN main.def_protocol p USING (cd_protocol)
ORDER BY cd_gp_event, event_id, num_replicate

RETURNING main.event.cd_event, main.event.cd_gp_event, main.event.event_id, main.event.num_replicate, main.event.description_replicate, main.event.date_time_begin, main.event.date_time_end, main.event.locality_verb, main.event.event_remarks, main.event.pt_geom
```

**Averiguar si los samp_effort_2 están bien**:

```{sql}
SELECT date_time_end-date_time_begin,samp_effort_2 FROM main.event LEFT JOIN main.gp_event USING (cd_gp_event) WHERE cd_gp_biol='catr';
```

Damos los cd_event a todos las filas:

```{sql}
ALTER TABLE raw_dwc.cameras_trampa_event ADD COLUMN cd_event int REFERENCES main.event(cd_event) ON DELETE SET NULL;
ALTER TABLE raw_dwc.cameras_trampa_registros ADD COLUMN cd_event int REFERENCES main.event(cd_event);

UPDATE raw_dwc.cameras_trampa_event AS t
SET cd_event=e.cd_event
FROM main.event e
WHERE t.event_id=e.event_id;

UPDATE raw_dwc.cameras_trampa_registros AS t
SET cd_event=e.cd_event
FROM main.event e
WHERE t.event_id=e.event_id;

SELECT true;
```


## registros

**Should we use the organism_id to separate the 30 min of delay to consider 2 individuals?**


```{sql}
SELECT occurrence_id, count(*)
FROM raw_dwc.cameras_trampa_registros 
GROUP BY occurrence_id
HAVING count(*)>1;
```

**Why are a lot of record numbers always repeated twice**?


```{sql}
SELECT record_number, count(*)
FROM raw_dwc.cameras_trampa_registros 
GROUP BY record_number
HAVING count(*)>1;
```

**Why are a lot of associated numbers always repeated twice**?

```{sql}
SELECT associated_media, count(*)
FROM raw_dwc.cameras_trampa_registros 
GROUP BY associated_media
HAVING count(*)>1;
```

**Parece que hay errores fuertes en las fechas de los registros**

```{sql}
SELECT e.event_id, e.event_date, r.event_date, r.event_time
FROM raw_dwc.cameras_trampa_registros r
LEFT JOIN raw_dwc.cameras_trampa_event e USING(cd_event)
ORDER BY r.event_date::date, r.event_time::time

```



```{sql}

INSERT INTO main.registros(cd_event, cds_recorded_by, date_time, cd_tax, cd_morfo, date_ident, cds_identified_by, qt_int,remarks, occurrence_id, organism_id)
SELECT 
 cd_event,
 cds_recorded_by,
 (event_date||' '||event_time)::timestamp date_time,
 tt.cd_tax,
 tt.cd_morfo,
 TO_DATE(date_identified,'YYYY-MM-DD') date_ident,
 cds_identified_by,
 organism_quantity::double precision::int qt_int,
 r."row.names" remarks, -- I use the empty remarks field to have a unique tag for later assignation
 occurrence_id,
 NULL AS organism_id
 --ROW_NUMBER() OVER (ORDER BY (e.date_time_begin::date||' '||event_time)::timestamp)
 --organism_id::text
FROM raw_dwc.cameras_trampa_registros r
LEFT JOIN raw_dwc.taxonomy_total tt ON tt."row.names"=r."row.names" AND tt.table_orig='cameras_trampa_registros'
LEFT JOIN main.event e USING (cd_event)
ORDER BY date_time
RETURNING cd_event, cds_recorded_by, date_time, cd_tax, cd_morfo, cds_identified_by, qt_int,remarks, occurrence_id, organism_id
```

```{sql}
ALTER TABLE raw_dwc.cameras_trampa_registros ADD COLUMN cd_reg int REFERENCES main.registros(cd_reg);
UPDATE raw_dwc.cameras_trampa_registros AS ar
SET cd_reg=r.cd_reg
FROM main.registros r
WHERE ar."row.names"=r.remarks;

WITH a AS(
SELECT cd_reg 
FROM main.registros
LEFT JOIN main.event USING (cd_event)
LEFT JOIN main.gp_event USING (cd_gp_event)
WHERE cd_gp_biol = 'catr'
)
UPDATE main.registros r
SET remarks=NULL
FROM a
WHERE a.cd_reg=r.cd_reg;


-- Check cd_reg are unique in the source table
SELECT cd_reg,count(*) FROM  raw_dwc.cameras_trampa_registros GROUP BY cd_reg HAVING count(*)>1;
```



# Attribución de los puntos de referencias a la plataformas

TODO



# Correcciones
## Macroinvertebrados


A veces las areas que están en la pestaña de registros están mal, lo que resulta en errores en el calculo de las densidades:

**Nota: son 171 casos donde la diferencia entre mi calculo y lo que hay en el DwC es de más de 20%**

```{sql, max.print=NA}
SELECT event_id,protocol,samp_effort_1 area,qt_int abs_ab,qt_int/samp_effort_1 calculado,qt_double val_dwc
FROM main.registros r
LEFT JOIN main.event USING(cd_event)
LEFT JOIN main.gp_event USING (cd_gp_event)
LEFT JOIN main.def_protocol USING (cd_protocol)
WHERE cd_gp_biol='minv' AND samp_effort_1 IS NOT NULL AND qt_int IS NOT NULL
 AND ( ((qt_int/samp_effort_1)/qt_double)>1.2 OR ((qt_int/samp_effort_1)/qt_double)<0.8 )
```

Así que lo que voy a hacer para macroinvertebrados es hacer el calculo y reemplazar todos los valores (incluso los que tenían menos de 20% de diferencia)

```{sql, results='hide'}
WITH a AS(
  SELECT cd_reg,qt_int/samp_effort_1 calculado
  FROM main.registros r
  LEFT JOIN main.event USING(cd_event)
  LEFT JOIN main.gp_event USING (cd_gp_event)
  LEFT JOIN main.def_protocol USING (cd_protocol)
  WHERE cd_gp_biol='minv' AND samp_effort_1 IS NOT NULL AND qt_int IS NOT NULL
)
UPDATE main.registros r
SET qt_double=a.calculado
FROM a 
WHERE r.cd_reg=a.cd_reg
RETURNING r.cd_reg;
```

## Macrofitas

### Errores con la suma de abundancia de los cuadrantes
No es un error real sino una imprecisión en las unidades y variables utilizada, la cantidad expresada en el campo organism_quantity es la area total de cobertura en metros, lo que vamos a utilizar acá es la cobertura en porcentaje.

```{sql max.print=NA}
WITH a AS(
SELECT cd_reg,cd_event, REGEXP_REPLACE("measurement_value__cobertura_de_cada_una_de_las_especies__%__",',','.')::double precision sum_cov
FROM raw_dwc.hidrobiologico_registros
)
SELECT event_id,samp_effort_1 area, sum_cov, sum_cov/samp_effort_1 calculado,qt_double val_dwc
FROM a
LEFT JOIN main.registros USING (cd_reg,cd_event)
LEFT JOIN main.event USING (cd_event)
LEFT JOIN main.gp_event USING(cd_gp_event)
LEFT JOIN main.def_protocol USING (cd_protocol)
WHERE cd_gp_biol='mafi'
AND (((sum_cov/samp_effort_1)/qt_double)>1.2 OR ((sum_cov/samp_effort_1)/qt_double)<0.8 )
```

```{sql}
WITH a AS(
SELECT cd_reg,cd_event, REGEXP_REPLACE("measurement_value__cobertura_de_cada_una_de_las_especies__%__",',','.')::double precision sum_cov
FROM raw_dwc.hidrobiologico_registros
),b AS(
SELECT cd_reg,event_id,samp_effort_1 area, sum_cov, sum_cov/samp_effort_1 calculado,qt_double val_dwc
FROM a
LEFT JOIN main.registros USING (cd_reg,cd_event)
LEFT JOIN main.event USING (cd_event)
LEFT JOIN main.gp_event USING(cd_gp_event)
LEFT JOIN main.def_protocol USING (cd_protocol)
WHERE cd_gp_biol='mafi'
)
UPDATE main.registros r
SET qt_double=b.calculado
FROM b
WHERE r.cd_reg=b.cd_reg
RETURNING r.cd_reg, qt_double
```

```{r}
dbDisconnect(fracking_db)
```
